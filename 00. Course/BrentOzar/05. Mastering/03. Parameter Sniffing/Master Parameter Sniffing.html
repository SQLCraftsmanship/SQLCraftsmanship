<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Brent Ozar Course Notes</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ startOnLoad: true });
    </script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="brent-ozar-course-notes">Brent Ozar Course Notes</h1>
<style>
r { color: red }
o { color: Orange }
g { color: Green }
lg { color: lightgreen }
b { color: Blue }
lb { color: lightblue }
</style>
<pre><code class="language-sql"></code></pre>
<ul>
<li>
<p>Initial Training Page</p>
<p><a href="https://training.brentozar.com/courses/">https://training.brentozar.com/courses/</a></p>
</li>
</ul>
<hr>
<h1 id="1-mastering-parameter-sniffing">1. Mastering Parameter Sniffing</h1>
<ul>
<li>Index
<ul>
<li><a href="#Reducing-the-Stench-of-Sniffing-Problems">Reducing the Stench of Sniffing Problems</a>
<ul>
<li><a href="#With-Index-Tuning">With Index Tuning</a>
<ul>
<li><a href="#Index-Seek-+-Key-Lookup-one-table">Index Seek + Key Lookup one table</a></li>
<li><a href="#2-Indexes">2 Indexes</a></li>
<li><a href="#RECAP">RECAP</a></li>
</ul>
</li>
<li><a href="#With-Query-Tuning">With Query Tuning</a>
<ul>
<li><a href="#RECAP">RECAP</a></li>
</ul>
</li>
<li><a href="#With-Recompile-Hints">With Recompile Hints</a>
<ul>
<li><a href="#RECAP">RECAP</a></li>
</ul>
</li>
<li><a href="#LAB-1">Lab 1</a>
<ul>
<li><a href="#Task-#-1">Task #1</a></li>
<li><a href="#Task-#-2">Task #2</a></li>
<li><a href="#Task-#-3">Task #3</a></li>
</ul>
</li>
<li><a href="#Bad-Branching-Causes-Sniffing-,-Good-Branching-Reduces-It">Bad Branching Causes Sniffing, Good Branching Reduces It</a>
<ul>
<li><a href="Bad-Branching-Causes-Sniffing-,-Good-Branching-Reduces-It">Bad Branching Causes Sniffing, Good Branching Reduces It</a></li>
<li><a href="#RECAP">RECAP</a></li>
<li><a href="#My#RECAP">My RECAP</a></li>
</ul>
</li>
<li><a href="#LAB-2">Lab 2</a>
<ul>
<li><a href="#My-Solution">My Solution</a></li>
<li><a href="#Brent-Solution">Brent Solution</a></li>
</ul>
</li>
<li><a href="#Spotting-Variable-Plans-in-the-Cache">Spotting Variable Plans in the Cache</a></li>
<li><a href="#Lower-Impact-Query-Store-:-usp_PlanCacheAutopilot">Lower-Impact Query Store: usp_PlanCacheAutopilot</a></li>
<li><a href="#Higher-Impact-:-Query-Store">Higher-Impact: Query Store</a></li>
<li><a href="#LAB-3">LAB 3</a>
<ul>
<li><a href="#Lab-3-Setup-:-Track-Down-Sniffing-in-Plan-Cache-History">Lab 3 Setup: Track Down Sniffing in Plan Cache History</a></li>
<li><a href="#My-Solution">My Solution</a></li>
<li><a href="#Brent-Solution">Brent Solution</a></li>
</ul>
</li>
<li><a href="#Memory-Grant-Feedback">Memory Grant Feedback</a></li>
<li><a href="#Adaptive-Joins">Adaptive Joins</a></li>
<li><a href="#Automatic-Tuning-,-aka-Automatic-Plan-Regression">Automatic Tuning, aka Automatic Plan Regression</a></li>
<li><a href="#LAB-4">LAB 4</a>
<ul>
<li><a href="#My-Solution">My Solution</a></li>
<li><a href="#Brent-Solution">Brent Solution</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h1 id="with-index-tuning">With Index Tuning</h1>
<p>By far, the single biggest causes of parameter sniffing is when SQL Server has to:</p>
<ul>
<li>Choose between an index seek + key lookup versus a table scan, or</li>
<li>Choose between two different indexes on the same table, or</li>
<li>Choose which table to process first in a join</li>
</ul>
<h2 id="index-seek--key-lookup-one-table">Index Seek + Key Lookup one table</h2>
<p>Let’s see which ones we can reduce with index expansion and tuning.</p>
<pre><code class="language-sql"><span class="hljs-comment">/**********************************************************************************************
Mastering Parameter Sniffing
1.1 How Index Tuning Reduces the Stench
**********************************************************************************************/</span>
RAISERROR(N<span class="hljs-string">&#x27;Oops! No, don&#x27;&#x27;t just hit F5. Run these demos one at a time.&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> LOG;
GO

<span class="hljs-comment">/* Set the stage with the right server options &amp; database config. We&#x27;ll be 
doing this repeatedly for a few modules, and this script should be idempotent. */</span>
USE StackOverflow;
GO
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Users&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>;
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate,_dta_index_Posts_5_85575343__K8,IX_OwnerUserId,OwnerUserId&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Users&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>)
	<span class="hljs-keyword">CREATE</span> INDEX Location <span class="hljs-keyword">ON</span> dbo.Users(Location);
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;_dta_index_Posts_5_85575343__K8&#x27;</span>)
	<span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts._dta_index_Posts_5_85575343__K8&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;CreationDate&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;IX_OwnerUserId&#x27;</span>)
	<span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts.IX_OwnerUserId&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;OwnerUserId&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate&#x27;</span>)
	<span class="hljs-keyword">CREATE</span> INDEX CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate);
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;OwnerUserId&#x27;</span>)
	<span class="hljs-keyword">CREATE</span> INDEX OwnerUserId <span class="hljs-keyword">ON</span> dbo.Posts(OwnerUserId);
GO
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">140</span>; <span class="hljs-comment">/* 2017, not 2019 yet */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* We&#x27;ll start with a fairly simple proc: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByDate <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    p.Score
  , p.Title
  , p.Body
  , p.Id
  , p.CreationDate
  , u.DisplayName
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span>   p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* And remember that we have this index: */</span>
<span class="hljs-keyword">CREATE</span> INDEX CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate);
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* If I pass in a very selective date range, I get an index seek + key lookups: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
</code></pre>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EP_1.png" alt="alt text"></p>
<pre><code class="language-sql"><span class="hljs-comment">/* A less selective range gets a table scan, and it&#x27;s rightfully slow: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

<span class="hljs-comment">/* The question is: how can we strech this SP?

We can fix this by reducing the number of key lookups we do.

We can&#x27;t cover the entire query: they&#x27;re asking for the Body of the post. That&#x27;s big. But remember from 
Fundamentals of Index Tuning: an ORDER BY with a TOP is basically a WHERE clause.

Armed with that, how could we reduce our key lookups? */</span>

<span class="hljs-keyword">CREATE</span> INDEX CreationDate_Score <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate, Score);
GO

<span class="hljs-comment">/* But now think about the Posts component of the query: */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> CreationDate, Score
<span class="hljs-keyword">FROM</span>   dbo.Posts
<span class="hljs-keyword">WHERE</span>  CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">&#x27;2017-12-01&#x27;</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Score <span class="hljs-keyword">DESC</span>;
GO
</code></pre>
<ul>
<li>
<p>The index is sorted by both CreationDate AND Score.
So what will our query plan look like?</p>
<p>Poll &quot;The query plan will:&quot;</p>
<ol>
<li>&quot;Have an index seek and a TOP&quot;</li>
<li>&quot;Have an index seek, then a sort by CreationDate, then a TOP&quot;</li>
<li>&quot;Have an index scan&quot;</li>
<li>&quot;Have a table scan&quot;</li>
</ol>
<p>Response
OPTION 2. After create the index I executed the query. The engine use the new Index. Execute an Index Seek + Order By</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EX_2.png" alt="alt text"></p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Now what happens with the queries and the new index?

If I pass in a very selective date range, I get an index seek + key lookups: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
</code></pre>
<ul>
<li>
<p>The Engines use the new index.</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EP_3.png" alt="alt text"></p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* A less selective range gets a table scan, and it&#x27;s rightfully slow: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
</code></pre>
<ul>
<li>
<p>The Engines doesn't use the new index.</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EP_4.png" alt="alt text"></p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Index visualization query: */</span>
<span class="hljs-keyword">SELECT</span> CreationDate, Score
<span class="hljs-keyword">FROM</span>   dbo.Posts
<span class="hljs-keyword">WHERE</span>  CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">&#x27;2017-12-01&#x27;</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate, Score;


<span class="hljs-comment">/* So basically, EITHER of these indexes would have the same plan here: */</span>
<span class="hljs-keyword">CREATE</span> INDEX CreationDate_Score <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate, Score);
GO
<span class="hljs-keyword">CREATE</span> INDEX CreationDate_Inc <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate) INCLUDE (Score);
GO

<span class="hljs-comment">/* Don&#x27;t get too hung up on chasing &quot;perfect.&quot; = Perfect, is the enemy of good.

Armed with either of these indexes, how does our plan look now: 

If I pass in a very selective date range, I get an index seek + key lookups: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
</code></pre>
<ul>
<li>A GOOD PLAN, As usual we get Index Seek + Kee Lookups</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Now try the less selective range: bad plan as usual */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
GO
</code></pre>
<ul>
<li>A BAD PLAN, As usual we get Index Seek + Kee Lookups</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* What if we put the tiny data plan in memory first? */</span>
sp_recompile <span class="hljs-string">&#x27;usp_TopScoringPostsByDate&#x27;</span>;
GO

<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>;

<span class="hljs-comment">/* Then run the big one? */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span>;
GO
</code></pre>
<ul>
<li>
<p>Now on the second query the engine use the new index but we are still executing a Sort.</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EP_5.png" alt="alt text"></p>
</li>
<li>
<p>The problem is the location of the sort.
SQL Server usually puts the index seek + key lookup right next to each other, and then sorts the data AFTER it finds the rows.</p>
<p>What if we:</p>
<ol>
<li>Used the index to find the rows we want</li>
<li>Sort them</li>
<li>Did the 200 key lookups later?</li>
</ol>
<p>To do that, we'll need to coach SQL Server. Here's one way:</p>
<ul>
<li>
<p>using CTE</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByDate_CTE <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-comment">-- Here we only put the columns that we have on the index</span>
  <span class="hljs-keyword">WITH</span> RowsIWant <span class="hljs-keyword">AS</span> 
  (
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
      p.Score, 
      p.CreationDate, 
      p.Id
    <span class="hljs-keyword">FROM</span> dbo.Posts p
    <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>
  )

  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    pKeyLookup.Score, 
    pKeyLookup.Title, 
    pKeyLookup.Body, 
    pKeyLookup.Id, 
    pKeyLookup.CreationDate, 
    u.DisplayName
  <span class="hljs-keyword">FROM</span> RowsIWant r
  <span class="hljs-keyword">JOIN</span> dbo.Posts pKeyLookup 
  <span class="hljs-keyword">ON</span>   r.Id <span class="hljs-operator">=</span> pKeyLookup.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span>   pKeyLookup.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.Score <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO

sp_recompile <span class="hljs-string">&#x27;usp_TopScoringPostsByDate_CTE&#x27;</span>;
GO

<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate_CTE <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>;
</code></pre>
<ul>
<li>
<p>So now the execution plan changed. The engine execute the Index Seek, then Sort and the Key Lookups for only 200 records.</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EP_6.png" alt="alt text"></p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Then run the big one? */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate_CTE <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span>;
GO
</code></pre>
<ul>
<li>
<p>So now the query finished. Execute the same query plan for both queries &quot;small&quot; and &quot;big&quot;</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EP_7.png" alt="alt text"></p>
</li>
</ul>
</li>
<li>
<p>Using TEMPTABLE
It's kinda like an index hint, but without naming the index.</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByDate_TempTables <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> #RowsIWant (Id <span class="hljs-type">INT</span>);

  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> #RowsIWant (Id)
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> p.Id
    <span class="hljs-keyword">FROM</span> dbo.Posts p
    <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>;

  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    pKeyLookup.Score, 
    pKeyLookup.Title, 
    pKeyLookup.Body, 
    pKeyLookup.Id, 
    pKeyLookup.CreationDate, 
    u.DisplayName
  <span class="hljs-keyword">FROM</span> #RowsIWant r
  <span class="hljs-keyword">JOIN</span> dbo.Posts pKeyLookup 
  <span class="hljs-keyword">ON</span>   r.Id <span class="hljs-operator">=</span> pKeyLookup.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span>   pKeyLookup.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pKeyLookup.Score <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO
</code></pre>
<pre><code class="language-sql">sp_recompile <span class="hljs-string">&#x27;usp_TopScoringPostsByDate_TempTables&#x27;</span>;
GO

<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate_TempTables <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>;
</code></pre>
<ul>
<li>
<p>So now, the engine create the temp table and do the sort. Then execute the Keylookups</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EP_8.png" alt="alt text"></p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Then run the big one */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate_TempTables <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span>;
GO
</code></pre>
<ul>
<li>
<p>So now, the engine execute the same Plan.</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EP_9.png" alt="alt text"></p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* You can still have outliers though: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDate <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1970-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2039-12-31&#x27;</span>;

<span class="hljs-comment">/* If you needed to make THAT fast, then you really need two different plans. More on that later. */</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p>Notes</p>
<ul>
<li>
<p>Fixing parameter sniffing with indexes is all about giving SQL Server a narrower copy of the data to reduce the blast radius.
Sometimes we have to encourage SQL Server to use the index by breaking the work up into different phases.</p>
<p>WE STILL HAVE PARAMETER SNIFFING. These plans can have different:</p>
<ul>
<li>Parallelism</li>
<li>Memory grants</li>
</ul>
<p>But they will at least look CLOSER than they looked before, and it may not matter AS MUCH which one goes in first.</p>
<p><r>If your biggest challenge in a parameter sniffing problem is deciding between an index seek vs key lookup, your goal is to reduce
the number of key lookups that SQL Server is forced to do. Give it enough in the index to let it do the filtering necessary.</p>
<p>The index helps you find the rows you want.</p>
<p><r>Once you've found the rows you want, 100-10,000 key lookups isn't a big deal at all (and the numbers may go even higher on bigger
databases.) Although if someone says they want more than 10,000 rows on a single report, I'm like look, buddy, it's time to do table scans.</p>
</li>
</ul>
</li>
</ul>
<h2 id="2-indexes">2 Indexes</h2>
<ul>
<li>That was a relatively simple filtering problem on one table. But what if the choice is between TWO indexes?</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByDateAndScore <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@MinimumScore</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    p.Score, 
    p.Title, 
    p.Body, 
    p.Id, 
    p.CreationDate, 
    u.DisplayName
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span>   p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   p.Score <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@MinimumScore</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO


<span class="hljs-comment">/* If we call it for a narrow date range, we can do our filtering on the index: 

@MinimumScore = 1 Is NOT selective, almost all the users has MinimumScore = 1 */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>, <span class="hljs-variable">@MinimumScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
GO
</code></pre>
<ul>
<li>
<p>Here the engine use the CreationDate_Score index to run the Index Seek + Key Lookups</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EP_10.png" alt="alt text"></p>
<pre><code class="language-sql"><span class="hljs-comment">/* But if we call it for a wide date range, and a narrow score filter: 
@MinimumScore = 10000 Is selective, almost nobody has MinimumScore = 10000 */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2016-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2016-12-31&#x27;</span>, <span class="hljs-variable">@MinimumScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
GO
</code></pre>
</li>
<li>
<p>Here the execution plan is different</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\EP_11.png" alt="alt text"></p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Now, an index on Score would be way more effective - because there just aren&#x27;t a lot of rows that match that narrow predicate.
If we had an index on Score, CreationDate: */</span>
<span class="hljs-keyword">CREATE</span> INDEX Score_CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(Score, CreationDate);
GO

<span class="hljs-comment">/* Then SQL Server will pick it when the score is very selective: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2016-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2016-12-31&#x27;</span>, <span class="hljs-variable">@MinimumScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
GO
</code></pre>
<ul>
<li>
<p>Here the engine use the new index Score_CreationDate</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\12.png" alt="alt text"></p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* But not when the date is very selective, and the score isn&#x27;t: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>, <span class="hljs-variable">@MinimumScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
GO
</code></pre>
<ul>
<li>
<p>Here the engine use the old index CreationDate_Score</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\13.png" alt="alt text"></p>
</li>
</ul>
<p><r>Here we have a NEW problem.</p>
<p><r>Our problem is NOT choosing between an index seek + key lookup vs a table scan.</p>
<p><r>Our problem is choosing between TWO DIFFERENT INDEXES on the same table.</p>
<p><r>Index tuning doesn't help here. Query tuning could help</p>
<ul>
<li>
<p>Now let's take it up a notch and filter on two tables at once:</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Find the most recent posts from an area */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    u.DisplayName, 
    p.Title, 
    p.Id, 
    p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span>   p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> u.Location     <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
  <span class="hljs-keyword">AND</span>   p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO
</code></pre>
</li>
<li>
<p>That's actually really similar to the above proc - but now, SQL Server's biggest challenge is determining WHICH TABLE to process first, and THEN which index to use on that table.</p>
<p>When the User.Location is very selective, it makes sense to find the users in that location first, then look up their posts.</p>
<p>When the Post.CreationDate range is very selective, it makes sense to find the posts in that date range first, then look up the users to see if they match.</p>
<p>If BOTH are very selective, it doesn't really matter which plan we pick.</p>
<p>If NEITHER is very selective, we'll probably end up with table scans.</p>
<p><r>Index tuning alone isn't going to be enough here: when SQL Server has to choose which table to process first, indexing each table isn't going to be enough.</p>
</li>
</ul>
<h2 id="recap">RECAP</h2>
<p>What to take away from this demo:</p>
<ul>
<li>
<p><r>If the biggest problem you're trying to solve is the choice between an index seek + key lookup versus a table scan,<r> your goal is to find the parts of the filtering &amp; sorting that require key lookups, and see if you can move those to the index instead.</p>
</li>
<li>
<p><r>Even the index alone may not cut it: if we can't fully cover the query, we may need to break the query into phases so that we can  do a sort before we do a key lookup.</r></p>
</li>
<li>
<p>If the biggest problem is choosing between <r>two indexes on the same table,</r> index tuning can help, but it's probably not going to be the only solution by itself. We're probably also going to have to introduce branching logic or a recompile hint to let ourselves get different query plans for different sets of parameters.</p>
</li>
<li>
<p>If the biggest problem you're trying to solve is <r>which table to process first</r> because different parameters should focus on different tables, indexes alone won't be enough.</p>
</li>
</ul>
<h1 id="with-query-tuning">With Query Tuning</h1>
<p>In our last module, we hit a wall when we tried to use index tuning to solve a problem where SQL Server had to choose between two different indexes for the same table. Sometimes a date range was more selective, and sometimes a score was more selective.</p>
<p>When you’re facing the problem of which index to process first, try both (or all) of the options and see if there’s one that has the least amount of terribleness. No, you shouldn’t hint the index by name – instead, just give SQL Server optimization hints that suggest which columns will be more selective, and that way, as index names change, you’ll still get a working plan. (This beats index hints and plan guides because those will fail as index names change.)</p>
<pre><code class="language-sql">RAISERROR(N<span class="hljs-string">&#x27;Oops! No, don&#x27;&#x27;t just hit F5. Run these demos one at a time.&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> LOG;
GO

USE StackOverflow;
GO
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Users&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>;
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate,_dta_index_Posts_5_85575343__K8,IX_OwnerUserId,OwnerUserId,Score_CreationDate&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Users&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>)
	<span class="hljs-keyword">CREATE</span> INDEX Location <span class="hljs-keyword">ON</span> dbo.Users(Location);
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;_dta_index_Posts_5_85575343__K8&#x27;</span>)
	<span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts._dta_index_Posts_5_85575343__K8&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;CreationDate&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;IX_OwnerUserId&#x27;</span>)
	<span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts.IX_OwnerUserId&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;OwnerUserId&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate&#x27;</span>)
	<span class="hljs-keyword">CREATE</span> INDEX CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate);
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;OwnerUserId&#x27;</span>)
	<span class="hljs-keyword">CREATE</span> INDEX OwnerUserId <span class="hljs-keyword">ON</span> dbo.Posts(OwnerUserId);
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Score_CreationDate&#x27;</span>)
	<span class="hljs-keyword">CREATE</span> INDEX Score_CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(Score, CreationDate);
GO

<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">140</span>; <span class="hljs-comment">/* 2017, not 2019 yet */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO
</code></pre>
<ul>
<li>In the index-tuning module, we hit a wall when we tried to use index tuning alone to solve a tough choice between two indexes, on this proc:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByDateAndScore <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@MinimumScore</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    p.Score, 
    p.Title,
    p.Body, 
    p.Id, 
    p.CreationDate, 
    u.DisplayName
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   p.Score <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@MinimumScore</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO
</code></pre>
<ul>
<li>
<p>There is no one good plan for this.</p>
</li>
<li>
<p>If you call it for a SELECTIVE date range and a NON-SELECTIVE score, you need to use the index on CreationDate first:</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>    <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>      <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> 
	<span class="hljs-keyword">WITH</span> RECOMPILE;
GO
</code></pre>
<ul>
<li>If you call it for a NON-SELECTIVE date range and a SELECTIVE score, you need to use the index on Score first:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>    <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-01&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>      <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span> 
	<span class="hljs-keyword">WITH</span> RECOMPILE;
GO
</code></pre>
<ul>
<li>If the CreationDate index goes into cache first, and then we call the other, the results are terrible:</li>
</ul>
<pre><code class="language-sql">sp_recompile <span class="hljs-string">&#x27;usp_TopScoringPostsByDateAndScore&#x27;</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>    <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>      <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-01&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>		  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span>	<span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
GO
</code></pre>
<ul>
<li>If the Score index goes in memory first:</li>
</ul>
<pre><code class="language-sql">sp_recompile <span class="hljs-string">&#x27;usp_TopScoringPostsByDateAndScore&#x27;</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-01&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>		  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span>	<span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>		  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span>	<span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO
</code></pre>
<ul>
<li>Wait Wait Wait .... - that's...that's actually not bad! We might be able to live with that plan being used for everything. Let's try the absolute worst case for it: a score filter that matches ALL posts, and a CreationDate that only matches just one single post:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1</span> CreationDate <span class="hljs-keyword">FROM</span> dbo.Posts;
GO
<span class="hljs-comment">-- 2008-07-31 21:42:52.667</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-07-31 21:42:52.667&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-07-31 21:42:52.667&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span>	<span class="hljs-operator">=</span> <span class="hljs-number">-100</span>;
GO
</code></pre>
<ul>
<li>
<p>In this case:</p>
<ul>
<li>We read ALL of the posts (40 millons records) - that's a lot of logical reads</li>
<li>But SQL Server can read data quickly, even with just one core</li>
<li>There's no over-allocation of CPU here</li>
<li>There's no over-allocation of memory here</li>
<li>There aren't a bunch of key lookups</li>
</ul>
</li>
<li>
<p>This might be the least-bad query! If we want to stick with this, we could use an index hint on the SP by name:</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByDateAndScore <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@MinimumScore</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    p.Score, 
    p.Title, 
    p.Body, 
    p.Id, 
    p.CreationDate, 
    u.DisplayName
  <span class="hljs-keyword">FROM</span> dbo.Posts p <span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> Score_CreationDate)
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   p.Score <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@MinimumScore</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO
</code></pre>
<ul>
<li>Try our absolute worst case scenario first, which SHOULD build a query plan that wants the index by CreationDate first:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-07-31 21:42:52.667&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-07-31 21:42:52.667&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span>	<span class="hljs-operator">=</span> <span class="hljs-number">-100</span>;
GO
</code></pre>
<ul>
<li>Things to note in the actual plan:
<ul>
<li>We get a seek on the Score_CreationDate index</li>
<li>Even though Score -100 isn't selective</li>
<li>Because SQL Server used the index hint</li>
</ul>
</li>
</ul>
<p>But if something happens with that index, like if someone renames it:</p>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> sp_rename 
	<span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts.Score_CreationDate&#x27;</span>, 
	<span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;IX_Score_CreationDate&#x27;</span>, 
	<span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
</code></pre>
<ul>
<li>So yeah, not a big fan of index hints.
<r>Hint the PARAMETERS instead, and then let SQL Server pick the appropriate index at runtime. Plus, the parameter hints let SQL Server optimize for different parallelism, memory grants, data changes over time, etc:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByDateAndScore <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@MinimumScore</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    p.Score, 
    p.Title, 
    p.Body, 
    p.Id, 
    p.CreationDate, 
    u.DisplayName
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span> p.Score <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@MinimumScore</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>
  OPTION (OPTIMIZE <span class="hljs-keyword">FOR</span> (<span class="hljs-variable">@MinimumScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">100000</span>));
<span class="hljs-keyword">END</span>
GO
</code></pre>
<ul>
<li>Is hinting for score alone enough?</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span>	<span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-01&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-31&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span>	<span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
GO
<span class="hljs-comment">/* And our worst case: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByDateAndScore 
	<span class="hljs-variable">@StartDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-07-31 21:42:52.667&#x27;</span>, 
	<span class="hljs-variable">@EndDate</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-07-31 21:42:52.667&#x27;</span>,
	<span class="hljs-variable">@MinimumScore</span>	<span class="hljs-operator">=</span> <span class="hljs-number">-100</span>;
GO
</code></pre>
<ul>
<li>We can also hint both score and dates:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByDateAndScore
	<span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@MinimumScore</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> p.Score, p.Title, p.Body, p.Id, p.CreationDate, u.DisplayName
  <span class="hljs-keyword">FROM</span> dbo.Posts p												<span class="hljs-comment">/* INDEX HINT IS GONE */</span>
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
    <span class="hljs-keyword">AND</span> p.Score <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@MinimumScore</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>
  OPTION (OPTIMIZE <span class="hljs-keyword">FOR</span> (<span class="hljs-variable">@MinimumScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">100000</span>, 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-07-31 21:42:52.667&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-07-31 21:42:52.667&#x27;</span>));
<span class="hljs-keyword">END</span>
GO
</code></pre>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByDateAndScore <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@MinimumScore</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExecute</span> NVARCHAR(<span class="hljs-number">4000</span>);
  <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;
    SELECT TOP 200 p.Score, p.Title, p.Body, p.Id, p.CreationDate, u.DisplayName
      FROM dbo.Posts p
      INNER JOIN dbo.Users u ON p.OwnerUserId = u.Id
      WHERE p.CreationDate BETWEEN @StartDate AND @EndDate
      AND p.Score &gt;= @MinimumScore
      ORDER BY p.Score DESC &#x27;</span>;

<span class="hljs-comment">/* If they&#x27;re asking for &gt;60 days, it&#x27;s big data, so get a fresh plan for it: */</span>
IF DATEDIFF(DD, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">60</span>
	<span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; OPTION (RECOMPILE) &#x27;</span>;

<span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExecute</span>, 
	N<span class="hljs-string">&#x27;@StartDate DATETIME, @EndDate DATETIME, @MinimumScore INT&#x27;</span>,
	<span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>, <span class="hljs-variable">@MinimumScore</span>;
<span class="hljs-keyword">END</span>
GO
</code></pre>
<h2 id="recap-1">RECAP</h2>
<ul>
<li>
<p>There are a huge number of hints available, and they keep growing with each new version:
<a href="https://docs.microsoft.com/en-us/sql/t-sql/queries/hints-transact-sql-query?view=sql-server-ver15">https://docs.microsoft.com/en-us/sql/t-sql/queries/hints-transact-sql-query?view=sql-server-ver15</a></p>
<p>I don't use these often, but when I do, these are the ones I like:</p>
<ul>
<li>
<p>OPTIMIZE FOR specific variables:
Lets me pick which plan I want to aim for. Works well if the majority of my queries have a similar pattern, like a narrow or wide date range.</p>
<ul>
<li>
<p>OPTIMIZE FOR UNKNOWN:
I don't actually like this much because you're optimizing for the &quot;average&quot; value, and that value can change a lot over time. However, if your query would
perform well if the &quot;average&quot; value worked well, and if you specifically want to exclude an outlier plan (like Jon Skeet running first), then this works.
If you find yourself using this a lot, try the database-level setting for disabling parameter sniffing instead (which can also be set differently for AG
secondaries, which have reporting-style big-data queries.)</p>
</li>
<li>
<p>MAX_GRANT_PERCENT:
If SQL Server believes a huge amount of memory is necessary for a query, but I know that the predicate is just nonsargable, OR if I know the speed of this
query just doesn't matter (and I'm okay if it spills to disk), then this lets me limit the grant.</p>
</li>
<li>
<p>MAXDOP:
You can actually pass in a HIGHER number here than the server's MAXDOP. Useful if you need to run batch reports against something like a Dynamics database
that would otherwise get MAXDOP 1. When I do this, I tend to hint MAXDOP 8. I don't usually want to take over <em>all</em> of the cores on a server. To be clear
though, this does NOT encourage a parallel plan.</p>
</li>
<li>
<p>OPTION(USE HINT('ENABLE_PARALLEL_PLAN_PREFERENCE'))
This one encourages a parallel plan.</p>
</li>
<li>
<p>Cardinality estimation hotfixes:
There are hints you can use to ask for a newer or legacy CE, depending on whether your database defaults to the old or new one.</p>
</li>
<li>
<p>QUERY_OPTIMIZER_COMPATIBILITY_LEVEL_n:
This is Microsoft's attempt to let ISVs ask for a specific CE, and thereby maintain support on newer versions of SQL Server. If they have a query that
only performs well on the older (or a specific) compat level, they can ask for it at the query level here. I've never met an ISV that had enough time to hint
all of their queries like this. Your mileage may vary.</p>
</li>
<li>
<p>QUERYTRACEON:
If you need a specific trace flag, you can do it with this syntax:
OPTION (QUERYTRACEON 4199, QUERYTRACEON 4137)</p>
</li>
</ul>
<p>List of supported trace flags:
<a href="https://docs.microsoft.com/en-us/sql/t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql">https://docs.microsoft.com/en-us/sql/t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql</a></p>
<ul>
<li>4199: query optimizer behavior changes</li>
<li>9398: disables Adaptive Joins</li>
<li>9481: old CE (pre-2014) regardless of compat level</li>
<li>11064: memory balancing for columnstore inserts</li>
</ul>
<p>List of all trace flags, including unsupported:
<a href="https://github.com/ktaranov/sqlserver-kit/blob/master/SQL%20Server%20Trace%20Flag.md">https://github.com/ktaranov/sqlserver-kit/blob/master/SQL Server Trace Flag.md</a></p>
<ul>
<li>8671: spend more time compiling plans, ignore &quot;good enough plan found&quot;</li>
<li>2453: table variables can trigger recompile when rows are inserted</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>I've seriously never done this in production, but I know a lot of folks that I respect who have, so I'm leaving this here.</p>
<p>RECOMPILE:
But I'll dedicate a whole module to that.</p>
<h1 id="with-recompile-hints">With Recompile Hints</h1>
<p>So far, we’ve added indexes, broken up queries into sections to encourage SQL Server to use those indexes, and even added query-level hints, all in an effort to get one execution plan that works well enough for most scenarios.</p>
<p>But what if you can’t?</p>
<p>Recompile hints are so compelling because they get a brand new customized execution plan for every set of incoming parameters. Option recompile is almost like a cheat code, and I love cheat codes! Let’s talk about when they’re safe to use, when they’ll get you busted, and how to use Erik Darling’s sp_HumanEvents to find out how bad of a problem they are for you already.</p>
<hr>
<p>SI LA QUERY CORRE A CADA MINUTO O MENOS NO USAR OPTION()</p>
<p>SI LA QUERY CORRE con menos frecuencia
REPORTES QUE CORREN CADA MES O 3 O 6 MESES TIENEN QUE USAR OPTION(RECOMPILE)</p>
<p>escuchar este video de nuevo en el minuto 13:30 .. no termino de entender.</p>
<hr>
<pre><code class="language-sql">RAISERROR(N<span class="hljs-string">&#x27;Oops! No, don&#x27;&#x27;t just hit F5. Run these demos one at a time.&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> LOG;
GO


<span class="hljs-comment">/* Set the stage with the right server options &amp; database config. We&#x27;ll be 
doing this repeatedly for a few modules, and this script should be idempotent. */</span>
USE StackOverflow;
GO
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Users&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>;
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate,_dta_index_Posts_5_85575343__K8,IX_OwnerUserId,OwnerUserId&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Users&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>)
	<span class="hljs-keyword">CREATE</span> INDEX Location <span class="hljs-keyword">ON</span> dbo.Users(Location);
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;_dta_index_Posts_5_85575343__K8&#x27;</span>)
	<span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts._dta_index_Posts_5_85575343__K8&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;CreationDate&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;IX_OwnerUserId&#x27;</span>)
	<span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts.IX_OwnerUserId&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;OwnerUserId&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate&#x27;</span>)
	<span class="hljs-keyword">CREATE</span> INDEX CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate);
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;OwnerUserId&#x27;</span>)
	<span class="hljs-keyword">CREATE</span> INDEX OwnerUserId <span class="hljs-keyword">ON</span> dbo.Posts(OwnerUserId);
GO
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">140</span>; <span class="hljs-comment">/* 2017, not 2019 yet */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO
DBCC FREEPROCCACHE;
GO
</code></pre>
<ul>
<li>We've been hitting a wall when we have a really big choice to make: which table should we process first?</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-comment">/* Find the most recent posts from an area */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    u.DisplayName, 
    p.Title, 
    p.Id, 
    p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span>   p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
  <span class="hljs-keyword">AND</span>   p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO
</code></pre>
<ul>
<li>If we run them all with recompile hints, they all add up to &lt; 10 seconds:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, small dates */</span>
 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, small dates */</span>
 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, small dates */</span>
 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, small dates */</span>
GO
</code></pre>
<ul>
<li>
<p>Their actual plans are all over the place!</p>
</li>
<li>
<p>If we truly want every one of them to get their own plan, we can just redefine the stored procedure with a recompile hint built right in:</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-comment">/* Find the most recent posts from an area */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    u.DisplayName, 
    p.Title, 
    p.Id, 
    p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>
  OPTION (RECOMPILE) <span class="hljs-comment">/* THIS IS NEW */</span>;
<span class="hljs-keyword">END</span>
GO
</code></pre>
<ul>
<li>We don't have to ask for a recompile - it's even easier &amp; faster!</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Big data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Big data, small dates */</span>
 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Medium data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Medium data, small dates */</span>
 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Small data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Small data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Small data, small dates */</span>
 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Outlier data, small dates */</span>
GO
</code></pre>
<ul>
<li>
<p>There are 3 drawbacks:</p>
<ol>
<li>
<p>The plans may still not actually be good: if SQL Server has estimation problems, it may still pick bad indexes, grants, orders, etc. That's a separate problem - that's just plain old query tuning. We cover that in Mastering Query Tuning.</p>
</li>
<li>
<p>The statement-level metrics disappear from cache: note the number of executions for the proc and for the statement:
sp_BlitzCache;</p>
</li>
<li>
<p>Each time the query is compiled, there's a CPU hit. This isn't bad in a small stored proc like ours, but it can be a big deal as:</p>
</li>
</ol>
<ul>
<li>You build the hint into more queries</li>
<li>You build the hint into LARGER queries (that take more CPU time to compile)</li>
</ul>
</li>
<li>
<p>You can see the overhead in each actual plan by looking at its compilation CPU and compilation time metrics, but ain't nobody got time for that.</p>
</li>
</ul>
<p>Let's see the overhead with sp_HumanEvents: <a href="https://www.erikdarlingdata.com/sp_humanevents/">https://www.erikdarlingdata.com/sp_humanevents/</a></p>
<pre><code class="language-sql"><span class="hljs-comment">/* Start this in another window: */</span>
<span class="hljs-keyword">EXEC</span> dbo.sp_HumanEvents <span class="hljs-variable">@event</span>_type <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;recompilations&#x27;</span>, <span class="hljs-variable">@seconds</span>_sample <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;
GO
</code></pre>
<ul>
<li>
<p>Then run our workload again:</p>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Big data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Big data, small dates */</span>

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Medium data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Medium data, small dates */</span>

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Small data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Small data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Small data, small dates */</span>

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Outlier data, small dates */</span>
GO
</code></pre>
<ul>
<li>The compilation overhead on a simple query like that is not bad. However, add more of these:
<ul>
<li>Statements</li>
<li>Joins</li>
<li>Partitions</li>
<li>Plan choices</li>
</ul>
</li>
</ul>
<p>And compilation time gets worse. To illustrate it, I am going to partition the Users table by CreationDate:</p>
<pre><code class="language-sql"><span class="hljs-comment">/* Create a numbers table with 1M rows: */</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> dbo.Numbers;
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> Numbers (Number <span class="hljs-type">int</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">PRIMARY</span> KEY CLUSTERED);
;<span class="hljs-keyword">WITH</span>
  Pass0 <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> C <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>), <span class="hljs-comment">--2 rows</span>
  Pass1 <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> C <span class="hljs-keyword">from</span> Pass0 <span class="hljs-keyword">as</span> A, Pass0 <span class="hljs-keyword">as</span> B),<span class="hljs-comment">--4 rows</span>
  Pass2 <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> C <span class="hljs-keyword">from</span> Pass1 <span class="hljs-keyword">as</span> A, Pass1 <span class="hljs-keyword">as</span> B),<span class="hljs-comment">--16 rows</span>
  Pass3 <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> C <span class="hljs-keyword">from</span> Pass2 <span class="hljs-keyword">as</span> A, Pass2 <span class="hljs-keyword">as</span> B),<span class="hljs-comment">--256 rows</span>
  Pass4 <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> C <span class="hljs-keyword">from</span> Pass3 <span class="hljs-keyword">as</span> A, Pass3 <span class="hljs-keyword">as</span> B),<span class="hljs-comment">--65536 rows</span>
  Pass5 <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> C <span class="hljs-keyword">from</span> Pass4 <span class="hljs-keyword">as</span> A, Pass4 <span class="hljs-keyword">as</span> B),<span class="hljs-comment">--Bigint</span>
  Tally <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> <span class="hljs-built_in">row_number</span>() <span class="hljs-keyword">over</span>(<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> C) <span class="hljs-keyword">as</span> Number <span class="hljs-keyword">from</span> Pass5)
<span class="hljs-keyword">INSERT</span> dbo.Numbers
        (Number)
    <span class="hljs-keyword">SELECT</span> Number
        <span class="hljs-keyword">FROM</span> Tally
        <span class="hljs-keyword">WHERE</span> Number <span class="hljs-operator">&lt;=</span> <span class="hljs-number">1000000</span>;
GO
</code></pre>
<ul>
<li>Create date partition function by day since Stack Overflow's origin, modified from Microsoft Books Online:
<a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-partition-function-transact-sql?view=sql-server-ver15#BKMK_examples">https://docs.microsoft.com/en-us/sql/t-sql/statements/create-partition-function-transact-sql?view=sql-server-ver15#BKMK_examples</a></li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PARTITION</span> SCHEME [DatePartitionScheme];
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">FUNCTION</span> [DatePartitionFunction];

<span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@DatePartitionFunction</span> nvarchar(max) <span class="hljs-operator">=</span> 
  N<span class="hljs-string">&#x27;CREATE PARTITION FUNCTION DatePartitionFunction (datetime) 
  AS RANGE RIGHT FOR VALUES (&#x27;</span>;  
<span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@i</span> datetime <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-06-01&#x27;</span>;
WHILE <span class="hljs-variable">@i</span> <span class="hljs-operator">&lt;=</span> GETDATE()
<span class="hljs-keyword">BEGIN</span>  
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@DatePartitionFunction</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-variable">@i</span> <span class="hljs-keyword">as</span> nvarchar(<span class="hljs-number">20</span>)) <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;, &#x27;</span>;  
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@i</span> <span class="hljs-operator">=</span> DATEADD(<span class="hljs-keyword">DAY</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">@i</span>);  
<span class="hljs-keyword">END</span>  
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@DatePartitionFunction</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-variable">@i</span> <span class="hljs-keyword">as</span> nvarchar(<span class="hljs-number">20</span>))<span class="hljs-operator">+</span> <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;);&#x27;</span>;  
<span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@DatePartitionFunction</span>;  
GO

<span class="hljs-comment">/* Create matching partition scheme, but put everything in Primary: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PARTITION</span> SCHEME DatePartitionScheme  
<span class="hljs-keyword">AS</span> <span class="hljs-keyword">PARTITION</span> DatePartitionFunction  
<span class="hljs-keyword">ALL</span> <span class="hljs-keyword">TO</span> ( [<span class="hljs-keyword">PRIMARY</span>] ); 
GO

<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> dbo.Users_partitioned;
GO
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> [dbo].[Users_partitioned](
  [Id] [<span class="hljs-type">int</span>] <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  [AboutMe] [nvarchar](max) <span class="hljs-keyword">NULL</span>,
  [Age] [<span class="hljs-type">int</span>] <span class="hljs-keyword">NULL</span>,
  [CreationDate] [datetime] <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  [DisplayName] [nvarchar](<span class="hljs-number">40</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  [DownVotes] [<span class="hljs-type">int</span>] <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  [EmailHash] [nvarchar](<span class="hljs-number">40</span>) <span class="hljs-keyword">NULL</span>,
  [LastAccessDate] [datetime] <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  [Location] [nvarchar](<span class="hljs-number">100</span>) <span class="hljs-keyword">NULL</span>,
  [Reputation] [<span class="hljs-type">int</span>] <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  [UpVotes] [<span class="hljs-type">int</span>] <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  [Views] [<span class="hljs-type">int</span>] <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  [WebsiteUrl] [nvarchar](<span class="hljs-number">200</span>) <span class="hljs-keyword">NULL</span>,
  [AccountId] [<span class="hljs-type">int</span>] <span class="hljs-keyword">NULL</span>
) <span class="hljs-keyword">ON</span> [<span class="hljs-keyword">PRIMARY</span>];
GO

<span class="hljs-keyword">CREATE</span> CLUSTERED INDEX CreationDate_Id <span class="hljs-keyword">ON</span> dbo.Users_partitioned (Id) <span class="hljs-keyword">ON</span> DatePartitionScheme(CreationDate);
GO

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dbo.Users_partitioned (Id, AboutMe, Age, CreationDate, DisplayName, DownVotes, EmailHash,
  LastAccessDate, Location, Reputation, UpVotes, Views, WebsiteUrl, AccountId)
<span class="hljs-keyword">SELECT</span> Id, AboutMe, Age, CreationDate, DisplayName, DownVotes, EmailHash,
  LastAccessDate, Location, Reputation, UpVotes, Views, WebsiteUrl, AccountId
<span class="hljs-keyword">FROM</span> dbo.Users;
GO

<span class="hljs-keyword">CREATE</span> INDEX Location_Aligned    <span class="hljs-keyword">ON</span> dbo.Users_partitioned(Location);
<span class="hljs-keyword">CREATE</span> INDEX Location_NotAligned <span class="hljs-keyword">ON</span> dbo.Users(Location) <span class="hljs-keyword">ON</span> [<span class="hljs-keyword">PRIMARY</span>];
GO

<span class="hljs-comment">/* Change the SP */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation_Partitioned <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-comment">/* Find the most recent posts from an area */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    u.DisplayName, 
    p.Title, 
    p.Id, 
    p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users_partitioned u 
  <span class="hljs-keyword">ON</span>   p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
  <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>
  OPTION (RECOMPILE);
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* Start this in another window: */</span>
<span class="hljs-keyword">EXEC</span> dbo.sp_HumanEvents <span class="hljs-variable">@event</span>_type <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;recompilations&#x27;</span>, <span class="hljs-variable">@seconds</span>_sample <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;
GO

<span class="hljs-comment">/* Then run our workload again: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Big data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Big data, small dates */</span>

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Medium data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Medium data, small dates */</span>

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Small data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Small data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Small data, small dates */</span>

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Partitioned <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Outlier data, small dates */</span>
GO
</code></pre>
</li>
<li>
<p>Last note: if you're gonna do recompilations in the real world, never put the hint on the outside of the stored procedure like this:</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME 
  <span class="hljs-comment">/* This is bad */</span>
  <span class="hljs-keyword">WITH</span> RECOMPILE <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Find the most recent posts from an area */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
      u.DisplayName, 
      p.Title, 
      p.Id, 
      p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
  <span class="hljs-keyword">AND</span>   p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO    

<span class="hljs-comment">/* Put them on the inside like this: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-comment">/* Find the most recent posts from an area */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> u.DisplayName, p.Title, p.Id, p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>
  OPTION (RECOMPILE); <span class="hljs-comment">/* This is less bad */</span>
<span class="hljs-keyword">END</span>
GO
</code></pre>
<ul>
<li>Because you'll get some (but not all) monitoring in the plan cache:</li>
</ul>
<pre><code class="language-sql">DBCC FREEPROCCACHE;
GO

<span class="hljs-comment">/* Then run our workload again: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Big data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Big data, small dates */</span>
 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Medium data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Medium data, small dates */</span>
 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Small data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Small data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Small data, small dates */</span>
 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Outlier data, small dates */</span>
GO

sp_BlitzCache;
</code></pre>
<h2 id="recap-2">RECAP</h2>
<p>What to take away from this demo:</p>
<ul>
<li>
<p><r>If you truly need different plans for every parameter set, statement-level recompile hints are the way to go.</p>
</li>
<li>
<p><r>I just only use these when the query runs less than a few times per minute, or else the overhead of this (plus the rest of the queries where I end up REQUIRING recompile hints) can add up to a big deal.</p>
</li>
<li>
<p>The easy way to see if it's a big deal on your server already: <r>sp_HumanEvents by Erik Darling.
<a href="https://www.erikdarlingdata.com/sp_humanevents/">https://www.erikdarlingdata.com/sp_humanevents/</a></p>
</li>
</ul>
<h1 id="lab-1">LAB 1</h1>
<ul>
<li>
<p>Setting up for the lab</p>
<ol>
<li>Restart your SQL Server service (clears all stats)</li>
<li>Restore your StackOverflow database (Agent job)</li>
<li>Copy &amp; run the setup script for Lab 1</li>
<li>(No SQLQueryStress for this lab)</li>
</ol>
</li>
<li>
<p>Task #1: fix these 2 parameters
EXEC usp_MostRecentCommentsForMe @UserId = 26837, @MinimumCommenterReputation = 0, @MinimumCommentScore = 0
EXEC usp_MostRecentCommentsForMe @UserId = 22656, @MinimumCommenterReputation = 10000, @MinimumCommentScore = 50</p>
<p>. Get these two sets of parameters to perform consistently sub-5-seconds, no matter which one is called first. Try freeing the plan cache, then run Brent, then run Jon Skeet. Then free the plan cache again, run Jon Skeet, then Brent.</p>
<p>. Recompile hints are off-limits because the queries run really frequently</p>
<p>. You’re not allowed to drop indexes – assume that the other indexes in place are being used by other queries  (although you can expand them to include additional columns if that helps)</p>
<p>. Get both sets of parameters to use the same plan (and the plan needs to be fast enough that it runs in, under 5 seconds</p>
<h3 id="my-solution">My solution</h3>
<p>Task #1:</p>
<pre><code class="language-sql">Test A
  <span class="hljs-keyword">Execute</span> Brent <span class="hljs-keyword">first</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.		Scan count   <span class="hljs-number">0</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">674</span> , physical <span class="hljs-keyword">reads</span> <span class="hljs-number">1</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span> <span class="hljs-number">107</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>.	Scan count <span class="hljs-number">166</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">2145</span>, physical <span class="hljs-keyword">reads</span> <span class="hljs-number">1</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span> <span class="hljs-number">224</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>.		Scan count   <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">3</span>   , physical <span class="hljs-keyword">reads</span> <span class="hljs-number">3</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span> <span class="hljs-number">0</span>  
    
    <span class="hljs-type">Time</span> <span class="hljs-number">1</span> se
</code></pre>
<pre><code>![alt text](Image/LAB1_EP.png)
</code></pre>
<pre><code class="language-sql">Test A
  <span class="hljs-keyword">Execute</span> Jon Skeet <span class="hljs-keyword">first</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.    Scan count     <span class="hljs-number">0</span>, logical <span class="hljs-keyword">reads</span>    <span class="hljs-number">366</span>, physical <span class="hljs-keyword">reads</span>   <span class="hljs-number">0</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span> <span class="hljs-number">64</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>. Scan count <span class="hljs-number">34202</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">834189</span>, physical <span class="hljs-keyword">reads</span> <span class="hljs-number">233</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span> <span class="hljs-number">101368</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>.    Scan count     <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span>     <span class="hljs-number">63</span>, physical <span class="hljs-keyword">reads</span>   <span class="hljs-number">3</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span> <span class="hljs-number">58</span>
    
    <span class="hljs-type">Time</span> <span class="hljs-number">4</span> se
</code></pre>
<pre><code>![alt text](Image/LAB2_EP.png)
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/*
. Si ejecuto 1ero Brent y despues Jon todo esta bien. Los dos demoran menos de 5 seg y usan el mismo plan
. Si ejecuto 1ero Jon y despues Brent, Brent no termina nunca

Posible Solutions
  . Put OPTION(RECOMPILE)
  . OPTION(OPTIMIZE FOR UNKNOWN)
  . OPTION(OPTIMIZE FOR (@UserId = 26837))
  . OPTION(OPTIMIZE FOR (pMine.OwnerUserId = @26837 AND u.Reputation &gt;= 0 AND c.Score &gt;= 0))
  . OPTION(OPTIMIZE FOR (u.Reputation &gt;= 0 AND c.Score &gt;= 0))
*/</span>
</code></pre>
</li>
<li>
<p>Task #2: find more outlier params
Find at least 3 other sets of parameters that might cause a problem for your newly tuned stored proc.</p>
<ul>
<li>
<p>Outlier users</p>
<ul>
<li>SELECT TOP 1 OwnerUserID, COUNT(<em>) FROM dbo.Posts GROUP BY OwnerUserID ORDER BY COUNT(</em>) DESC</li>
<li>SELECT COUNT(*) FROM dbo.Posts GROUP BY OwnerUserID WHERE OwnerUserId = -100 (we try to find an UserId whitout records)</li>
<li>Result
Big Data = 0
Tiny Data = -100</li>
</ul>
</li>
<li>
<p>Outlier minimum reputations    = 1 - 6 - 17839</p>
<ul>
<li>SELECT TOP 1 Reputation , COUNT(<em>) FROM dbo.Users GROUP BY Reputation  ORDER BY COUNT(</em>) DESC</li>
<li>SELECT TOP 10 Reputation FROM dbo.Users ORDER BY reputation DESC;</li>
<li>Result
Big Data  = -100
Tiny Data = 1029634</li>
</ul>
</li>
<li>
<p>Outlier minimum comment scores = 1 - 2 - 325</p>
<ul>
<li>SELECT TOP 10 Scrore FROM dbo.Comments ORDER BY Scrore DESC;</li>
<li>Result
Big Data  = -100
Tiny Data = 1228</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Task #3, optional: fix those too
Can you tune it so everyone performs in &lt;5 seconds?
What changes might you consider making? (This one’s really hard.)</p>
<pre><code class="language-sql"><span class="hljs-comment">/* Big Data outliers, used to get 30 seconds with his own plan */</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_MostRecentCommentsForMe] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, 
  <span class="hljs-variable">@MinimumCommenterReputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">-100</span>, <span class="hljs-variable">@MinimumCommentScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">-100</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

<span class="hljs-comment">/* Small Data outliers, used to get instantaneous with his own plan */</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_MostRecentCommentsForMe] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">-100</span>, 
  <span class="hljs-variable">@MinimumCommenterReputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1029634</span>, <span class="hljs-variable">@MinimumCommentScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">1228</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

<span class="hljs-comment">/* 201 Buckets outliers, used to get instantaneous with his own plan */</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_MostRecentCommentsForMe] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">128165</span>, 
  <span class="hljs-variable">@MinimumCommenterReputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1029634</span>, <span class="hljs-variable">@MinimumCommentScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">1228</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> [dbo].[usp_MostRecentCommentsForMe] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">128165</span>, 
  <span class="hljs-variable">@MinimumCommenterReputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">-100</span>, <span class="hljs-variable">@MinimumCommentScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">-100</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
</code></pre>
</li>
<li>
<p>Gotchas</p>
<ul>
<li>Recompile hints are off-limits</li>
<li>You’re not allowed to drop indexes: assume all indexes are being used by other queries</li>
</ul>
</li>
</ul>
<h1 id="bad-branching-causes-sniffing-good-branching-reduces-it">Bad Branching Causes Sniffing, Good Branching Reduces It</h1>
<ul>
<li>
<p>Bad Branching Causes Sniffing, Good Branching Reduces It
Index tuning and query hinting give us one plan that works well enough for some situations, but what if we really need two different plans? For example, we’ve been dodging around the problem of two different input parameters that really require two different approaches: maybe it’s small data versus big data, maybe it’s two different indexes that are better fits for different situations, or maybe it’s two different possible driver tables.</p>
<p>Or, maybe our code has gotten complex enough to the point where it has an IF branch: if we’re doing daily processing, run one block of code, and if we’re doing monthly processing, run a different block of code.</p>
<p>The technique of branching logic gives us the capability to get multiple stable plans without the constant overhead and amnesia of recompile hints. We’ll cover how to start introducing branching logic, dynamic SQL, and child stored procedures in order to produce different plans, and we’ll cover how bad branching actually makes things worse.</p>
<pre><code class="language-sql">USE StackOverflow;
GO

<span class="hljs-comment">/* The Users table has an index on Reputation: */</span>
sp_BlitzIndex <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Users&#x27;</span>
GO

<span class="hljs-comment">/* Create the Proc Test */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> dbo.Users
  <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* These two get different plans: */</span>
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">-- Small Data Plan</span>
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">-- Bid Data Plan</span>

<span class="hljs-comment">/* If the big data plan goes in first, they both perform as expected: */</span>
sp_recompile <span class="hljs-string">&#x27;usp_RptUsersByReputation&#x27;</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">/* If the tiny data plan goes in first, then the big one sucks: */</span>
sp_recompile <span class="hljs-string">&#x27;usp_RptUsersByReputation&#x27;</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO
</code></pre>
<p>So let's say we truly need different plans, and we don't want to recompile because this query is called thousands of times per minute.</p>
<p>Can we put in a branch and get two different plans?</p>
<pre><code class="language-sql"><span class="hljs-comment">/* Change SP add If to try to generate 2 plans */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  IF <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
  <span class="hljs-keyword">ELSE</span>
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* Do we still have parameter sniffing? Does it matter which one goes first? */</span>
sp_recompile <span class="hljs-string">&#x27;usp_RptUsersByReputation&#x27;</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO

<span class="hljs-comment">/* If I stick query hints in this, will I still have parameter sniffing? Add with(index ...) */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  IF <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
    <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
    <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
  <span class="hljs-keyword">ELSE</span>
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
    <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> IX_Reputation_Includes)
    <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* Do we still have parameter sniffing? Does it matter which one goes first? */</span>
sp_recompile <span class="hljs-string">&#x27;usp_RptUsersByReputation&#x27;</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO
</code></pre>
<p>Did the big data plan:</p>
<ul>
<li>Go parallel? Why?</li>
<li>Estimate the right number of rows? Why?</li>
<li>Estimate the right memory grant? Why?</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* What if I build dynamic SQL? */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExecute</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;SELECT TOP 1000 * FROM dbo.Users
    WHERE Reputation = @Reputation
    ORDER BY DisplayName;&#x27;</span>;
  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExecute</span>, N<span class="hljs-string">&#x27;@Reputation INT&#x27;</span>, <span class="hljs-variable">@Reputation</span>;
<span class="hljs-keyword">END</span>
GO

sp_recompile <span class="hljs-string">&#x27;usp_RptUsersByReputation&#x27;</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO


<span class="hljs-comment">/* What if I build DIFFERENT dynamic SQL? THIS IS THE ONE THAT BRENT PREFER */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExecute</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;SELECT TOP 1000 * FROM dbo.Users
    WHERE Reputation = @Reputation
    ORDER BY DisplayName;&#x27;</span>;

  IF <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; /* Big data */&#x27;</span>;

  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExecute</span>, N<span class="hljs-string">&#x27;@Reputation INT&#x27;</span>, <span class="hljs-variable">@Reputation</span>;
<span class="hljs-keyword">END</span>
GO

DBCC FREEPROCCACHE
GO
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO

<span class="hljs-comment">/* Turn off actual plans: */</span>
sp_BlitzCache;


<span class="hljs-comment">/* Similar tactic: different child stored procedures. */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  IF <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation_BigData <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>;
  <span class="hljs-keyword">ELSE</span>
    <span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation_SmallData <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* Child 1 */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation_BigData <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> dbo.Users
  <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* Child 2 */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation_SmallData <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> dbo.Users
  <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
<span class="hljs-keyword">END</span>
GO
</code></pre>
<p>THE TWO CHILD STORED PROCS ARE IDENTICAL, but because they're different queries, they both get parameter sniffing independently, each producing their own execution plans:</p>
<pre><code class="language-sql">DBCC FREEPROCCACHE
GO
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO

<span class="hljs-comment">/* Turn off actual plans: */</span>
sp_BlitzCache;
GO
</code></pre>
<p>Benefits of child procs:</p>
<ul>
<li>The optimal plan for both can change automatically over time</li>
<li>Or code can be hand-tuned for each one (like different optimizer hints)</li>
</ul>
<p>Drawbacks:</p>
<ul>
<li>
<p>The same code is now in two procs, making maintainability a little harder</p>
</li>
<li>
<p>One IF branch and two child procs may not be enough: the more possible plans a query has, the more branching you're tempted to build, and it'll be hard</p>
</li>
<li>
<p>The right trigger value might change over time, like if Stack Overflow suddenly gives people 100 reputation points on joining instead of 1</p>
</li>
</ul>
<p><r>Child procs are especially powerful when you have joins, and you want the join decisions to be postponed until after you've found out how many rows are in the driver table of the query:</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation_Joins <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> dbo.Users u
  <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> p.OwnerUserId
  <span class="hljs-keyword">JOIN</span> dbo.Comments c <span class="hljs-keyword">ON</span> p.Id <span class="hljs-operator">=</span> c.PostId
  <span class="hljs-keyword">JOIN</span> dbo.Users uCommenter <span class="hljs-keyword">ON</span> c.UserId <span class="hljs-operator">=</span> uCommenter.Id
  <span class="hljs-keyword">JOIN</span> dbo.Badges b <span class="hljs-keyword">ON</span> uCommenter.Id <span class="hljs-operator">=</span> b.UserId
  <span class="hljs-keyword">WHERE</span> u.Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> u.DisplayName;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* 
If you call this for @Reputation = 2, only a few users will come out, and you wouldn&#x27;t mind a few index seeks on the join tables.
If you call it for @Reputation = 1, you&#x27;re better off with giant table scans and a giant memory grant.
Start with a pre-check of how many users match in the driver table:
*/</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation_Joins <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  IF <span class="hljs-number">10000</span> <span class="hljs-operator">&lt;</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>)
    <span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation_Joins_BigData <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>;
  <span class="hljs-keyword">ELSE</span>
    <span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation_Joins_SmallData <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* Or: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation_Joins <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> #MatchingUsers (Id <span class="hljs-type">INT</span>);
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> #MatchingUsers (Id)
    <span class="hljs-keyword">SELECT</span> Id
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>;

  IF <span class="hljs-number">10000</span> <span class="hljs-operator">&lt;</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> #MatchingUsers)
    <span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation_Joins_BigData <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>;
  <span class="hljs-keyword">ELSE</span>
    <span class="hljs-keyword">EXEC</span> usp_RptUsersByReputation_Joins_SmallData <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* Because then you can use the temp table in the child stored procs: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersByReputation_Joins_BigData <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> #MatchingUsers m
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> m.Id <span class="hljs-operator">=</span> u.Id
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> p.OwnerUserId
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Comments c <span class="hljs-keyword">ON</span> p.Id <span class="hljs-operator">=</span> c.PostId
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users uCommenter <span class="hljs-keyword">ON</span> c.UserId <span class="hljs-operator">=</span> uCommenter.Id
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Badges b <span class="hljs-keyword">ON</span> uCommenter.Id <span class="hljs-operator">=</span> b.UserId
  <span class="hljs-keyword">WHERE</span> u.Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> u.DisplayName;
<span class="hljs-keyword">END</span>
GO
</code></pre>
</li>
</ul>
<h2 id="recap-3">RECAP</h2>
<p>What to take away from this demo:</p>
<ul>
<li><r>All of the code in a batch gets compiled at once initially.</li>
<li>If you want a different plan, you have to:
<ul>
<li>Ask for it - like with a RECOMPILE hint</li>
<li>Change a lot of data, forcing stats to update</li>
<li>Postpone compilation for part of the query: (like build a child stored procedure or dynamic SQL)</li>
<li><r>Comment injection can be super powerful and low maintenance</li>
</ul>
</li>
<li>But when you do any of the above, you're building technical debt: if the data distribution changes over time, you may need to revisit the triggers you used to spawn the branching logic.</li>
</ul>
<h1 id="my-recap">My RECAP</h1>
<ul>
<li>Branchis you can
<ul>
<li>Option 1<pre><code class="language-sql">IF ....
  ....
<span class="hljs-keyword">ELSE</span>
  ....
</code></pre>
</li>
<li>Option 2<pre><code class="language-sql">IF ....
  .... <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> ....)
<span class="hljs-keyword">ELSE</span>
  .... <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> ....)
</code></pre>
</li>
<li>Option 3
DYNAMIC QUERY</li>
<li>Option 4
DYNAMIC QUERY + COMMENT</li>
<li>Option 5
CHILD SP. This is good with joins</li>
</ul>
</li>
</ul>
<h1 id="lab-2">LAB 2</h1>
<ul>
<li>
<p>My solution</p>
<ul>
<li>
<p>Best run option is to execute on this way:</p>
<ol>
<li>Iceland                = 0  sec</li>
<li>Hafnarfjordur, Iceland = 0  sec</li>
<li>Germany                = 14 sec</li>
</ol>
</li>
<li>
<p>If I run each one individual I got the below execution plans:</p>
<ol>
<li>Iceland
Users + Post (Index Seek + Key Lookup)</li>
</ol>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\Iceland.png" alt="alt text"></p>
<ol start="2">
<li>Hafnarfjordur, Iceland
Users + Post (Index Seek + Key Lookup)</li>
</ol>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\IcelandH.png" alt="alt text"></p>
<ol start="3">
<li>Germany
Post (Index Scan + Key Lookup) + Users</li>
</ol>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\GermanyEX.png" alt="alt text"></p>
</li>
<li>
<p>My new SP tunned</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.RecentPostsByLocation_Tune <span class="hljs-variable">@Location</span> NVARCHAR(<span class="hljs-number">100</span>) 
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringtoExecute</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;SELECT TOP 200 p.Title, p.Id, p.CreationDate
  FROM dbo.Posts p
  JOIN dbo.Users u ON p.OwnerUserId = u.Id
  WHERE u.Location = @Location
  ORDER BY p.CreationDate DESC;&#x27;</span>;

  IF <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Germany&#x27;</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringtoExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringtoExecute</span> <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;/* This is for German */&#x27;</span>
  
  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringtoExecute</span>, N<span class="hljs-string">&#x27;@Location NVARCHAR(100)&#x27;</span>, <span class="hljs-variable">@Location</span>
<span class="hljs-keyword">END</span>
GO
</code></pre>
</li>
<li>
<p>Brent Solution</p>
</li>
</ul>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\LAB2_BrentSolution1.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\LAB2_BrentSolution2.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\LAB2_BrentSolution3.png" alt="alt text"></p>
<p>From the second video</p>
<p>Using var tables doesn't work
<img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\LAB2_BrentSolution4.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\LAB2_BrentSolution5.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\LAB2_BrentSolution6.png" alt="alt text"></p>
<p>Supose that we want to force a list of values that we know that never change</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> N<span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> REPLACE(Location, N<span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span>, N<span class="hljs-string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span>) <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;&#x27;&#x27;,&#x27;</span>, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> recs
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Location <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> lOCATION
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">DESC</span>
</code></pre>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\LAB2_BrentSolution7.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\LAB2_BrentSolution8.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\05. Mastering\03. Parameter Sniffing\Image\LAB2_BrentSolution9.png" alt="alt text"></p>
<h1 id="spotting-variable-plans-in-the-cache">Spotting Variable Plans in the Cache</h1>
<ul>
<li>
<p>In order to detect, troubleshoot, and prevent parameter sniffing issues, we’re going to need:</p>
<ul>
<li>Metrics about how queries are performing</li>
<li>Different versions of the query plans that caused those metrics</li>
<li>To collect them, we’re going to go from the lowest-overhead, least-data solutions first, and then gradually progress to the collection methods that have the highest level of overhead but produce the most diagnostic data.</li>
<li>First up: sys.dm_exec_query_stats and sys.dm_exec_query_plan_stats.</li>
</ul>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Set the stage with the right server options &amp; database config: */</span>
USE StackOverflow;
GO
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">140</span>; <span class="hljs-comment">/* 2017, not 2019 yet */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO
<span class="hljs-keyword">SET</span> STATISTICS IO, <span class="hljs-type">TIME</span> <span class="hljs-keyword">ON</span>;
GO

<span class="hljs-comment">/* Add a few indexes to let SQL Server choose.  This can take 4-5 minutes. */</span>
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Users&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>;
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate,_dta_index_Posts_5_85575343__K8,IX_OwnerUserId,OwnerUserId&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Users&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>)
  <span class="hljs-keyword">CREATE</span> INDEX Location <span class="hljs-keyword">ON</span> dbo.Users(Location);
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;_dta_index_Posts_5_85575343__K8&#x27;</span>)
  <span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts._dta_index_Posts_5_85575343__K8&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;CreationDate&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;IX_OwnerUserId&#x27;</span>)
  <span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts.IX_OwnerUserId&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;OwnerUserId&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate&#x27;</span>)
  <span class="hljs-keyword">CREATE</span> INDEX CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate);
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;OwnerUserId&#x27;</span>)
  <span class="hljs-keyword">CREATE</span> INDEX OwnerUserId <span class="hljs-keyword">ON</span> dbo.Posts(OwnerUserId);
GO


<span class="hljs-comment">/* Build our very sensitive proc: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation 
  <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Find the most recent posts from an area */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    u.DisplayName, p.Title, p.Id, p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> 
    u.Location		<span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
  <span class="hljs-keyword">AND</span> p.CreationDate	<span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO
</code></pre>
<ul>
<li>As a reminder, these produce wildly different plans. Note differences in:
<ul>
<li>Which table is processed first</li>
<li>Parallelism or single-threaded</li>
<li>Memory grant sizes</li>
</ul>
</li>
</ul>
<pre><code class="language-sql">DBCC FREEPROCCACHE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, small dates */</span>

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, small dates */</span>

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, small dates */</span>

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, small dates */</span>
GO
</code></pre>
<p>Note that when ALL of them are run with RECOMPILE, they finish in under 5 seconds.
Let's put the tiny-data plan in memory, then run a few others:</p>
<pre><code class="language-sql">DBCC FREEPROCCACHE;
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Small data, small dates */</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Medium data, medium dates */</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, medium dates */</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Big data, medium dates */</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
GO
</code></pre>
<p>Run them all a few times, and then check the plan cache:
When you are investigation Parameter Sniffing issue the below table has lot of columns to check.</p>
<p>Things to note:
* Plan_generation_num = 1  right now
* Execution_Count	  = 11 right now
* Worker time		  = last/min/max (last_worker_time/min_worker_time/max_worker_time)
Note:
How do you know that you have parameter sniffin?
If the same query has a wide swings in between [min_worker_time] and [max_worker_time]</p>
<pre><code>* Logical reads		  = last/min/max (last_logical_reads/min_logical_reads/max_logical_reads)
* Elapsed time		  = last/min/max (last_elapsed_time/min_elapsed_time/max_elapsed_time/) Duration in ms
* Total rows		    = last/min/max (bigger datasets will naturally take more time)
* DOP				        = min/max/last (total makes no sense here)
* Grant				      = min/max/last, used
* Spills			      = min/max/last

Make a note of the query_hash for later querying: 0xC3D39254FF662673
</code></pre>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_elapsed_time <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">/* One disappointing thing to <span class="hljs-doctag">note:</span> the contents of the plan are just the estimates. */</span>
<span class="hljs-keyword">SELECT</span> qp.query_plan, qs.<span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats qs
  <span class="hljs-keyword">CROSS</span> APPLY sys.dm_exec_query_plan(qs.plan_handle) qp
  <span class="hljs-keyword">WHERE</span> qs.query_hash <span class="hljs-operator">=</span> <span class="hljs-number">0xC3D39254FF662673</span>;
GO

<span class="hljs-comment">/* Starting with SQL Server 2019, you can turn this on to cache (most of the) last actual plan: */</span>
<span class="hljs-keyword">ALTER</span> DATABASE SCOPED CONFIGURATION <span class="hljs-keyword">SET</span> LAST_QUERY_PLAN_STATS <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>;
GO

<span class="hljs-comment">/* And run the query again: */</span>
DBCC FREEPROCCACHE;
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
GO

<span class="hljs-comment">/* The old-school plan cache still only has the estimates: */</span>
<span class="hljs-keyword">SELECT</span> qp.query_plan, qs.<span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats qs
  <span class="hljs-keyword">CROSS</span> APPLY sys.dm_exec_query_plan(qs.plan_handle) qp
  <span class="hljs-keyword">WHERE</span> qs.query_hash <span class="hljs-operator">=</span> <span class="hljs-number">0xC3D39254FF662673</span>;
GO

<span class="hljs-comment">/* But there&#x27;s a new function in town: */</span>
<span class="hljs-keyword">SELECT</span> qp.query_plan <span class="hljs-keyword">AS</span> normally_cached_plan, qps.query_plan <span class="hljs-keyword">AS</span> last_actual_plan, qs.<span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats qs
  <span class="hljs-keyword">CROSS</span> APPLY sys.dm_exec_query_plan(qs.plan_handle) qp
  <span class="hljs-keyword">CROSS</span> APPLY sys.dm_exec_query_plan_stats(qs.plan_handle) qps <span class="hljs-comment">/* THIS ONE IS NEW IN 2019 */</span>
  <span class="hljs-keyword">WHERE</span> qs.query_hash <span class="hljs-operator">=</span> <span class="hljs-number">0xC3D39254FF662673</span>;
GO
</code></pre>
<p>The new one shows:
* Estimated rows vs actuals
* Some (but not all) info on spills
* The compiled (but not runtime) parameters this is a piece of shit</p>
<p>sp_BlitzCache shows this automatically by default:</p>
<pre><code class="language-sql">sp_BlitzCache
GO

<span class="hljs-comment">/* Rebuild an index on Users: */</span>
<span class="hljs-keyword">ALTER</span> INDEX Location <span class="hljs-keyword">ON</span> dbo.Users REBUILD;
GO

<span class="hljs-comment">/* Check the plan cache again: */</span>
<span class="hljs-keyword">SELECT</span> execution_count, plan_generation_num, <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats <span class="hljs-keyword">WHERE</span> query_hash <span class="hljs-operator">=</span> <span class="hljs-number">0xC3D39254FF662673</span>;

<span class="hljs-comment">/* Note the # of executions, and plan_generation_num = 1. The rebuild of the index didn&#x27;t cause a new plan to be built - YET.
But run the stored proc again, and give it a different starting value: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>

<span class="hljs-comment">/* And then check the plan cache again: */</span>
<span class="hljs-keyword">SELECT</span> execution_count, plan_generation_num, <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats <span class="hljs-keyword">WHERE</span> query_hash <span class="hljs-operator">=</span> <span class="hljs-number">0xC3D39254FF662673</span>;
GO
</code></pre>
<p>Ruh roh - check:
* plan_generation_num
* All the performance metrics, like worker time min/max/last/total</p>
<p>We expose plan_generation_num at the far right:</p>
<pre><code class="language-sql">sp_BlitzCache;
</code></pre>
<p>If we only have the current contents of sys.dm_exec_query_stats:</p>
<pre><code>* The plan cache is useful for spotting wild variations in CPU, reads, duration, etc.
* The plan cache only stores the current estimated plan, not all the old ones
* 2019 adds the last actual plan, but only if you opt into it, and it's not all actuals (no spill page counts, runtime parameters)
* High plan_generation_num can mean you're getting frequent compiles, but...
* Metrics reset, so you can't see how the current plan fares vs historical
* In theory, you could look for wild variances between min/max/total/avg/last, but there are risks with that, too.
</code></pre>
<p>Here's the code we use in sp_BlitzCache to trigger the parameter sniffing warning.
The defaults:
@parameter_sniffing_warning_pct = 30%
@parameter_sniffing_io_threshold = 100,000 logical reads</p>
<p>parameter_sniffing =
CASE WHEN ExecutionCount &gt; 3 AND AverageReads &gt; @parameter_sniffing_io_threshold
AND min_worker_time &lt; ((1.0 - (@parameter_sniffing_warning_pct / 100.0)) * AverageCPU) THEN 1
WHEN ExecutionCount &gt; 3 AND AverageReads &gt; @parameter_sniffing_io_threshold
AND max_worker_time &gt; ((1.0 + (@parameter_sniffing_warning_pct / 100.0)) * AverageCPU) THEN 1
WHEN ExecutionCount &gt; 3 AND AverageReads &gt; @parameter_sniffing_io_threshold
AND MinReturnedRows &lt; ((1.0 - (@parameter_sniffing_warning_pct / 100.0)) * AverageReturnedRows) THEN 1
WHEN ExecutionCount &gt; 3 AND AverageReads &gt; @parameter_sniffing_io_threshold
AND MaxReturnedRows &gt; ((1.0 + (@parameter_sniffing_warning_pct / 100.0)) * AverageReturnedRows) THEN 1 END ,
GO</p>
<p>Parameter sniffing happens when a NEW plan is regenerated, and the OLD one is flushed out of the cache.
So what we really need to do is store the plan cache contents over time.</p>
<p>I do this to clear out past instances of my monitoring tables only to make it clear what's happening while I run my demos.
If you're already logging sp_BlitzFirst &amp; friends to tables, you may not want to delete your existing data.</p>
<pre><code class="language-sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> DBAtools.dbo.BlitzFirst;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> DBAtools.dbo.BlitzFirst_FileStats;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> DBAtools.dbo.BlitzFirst_PerfmonStats;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> DBAtools.dbo.BlitzFirst_WaitStats;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> DBAtools.dbo.BlitzCache;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> DBAtools.dbo.BlitzWho;
</code></pre>
<p>Let's put the tiny-data plan in memory, then run a few others. This whole set will take ~60 seconds.</p>
<pre><code class="language-sql">DBCC FREEPROCCACHE;
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Small data, small dates */</span>
GO <span class="hljs-number">5</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Medium data, medium dates */</span>
GO <span class="hljs-number">5</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, medium dates */</span>
GO <span class="hljs-number">5</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Big data, medium dates */</span>
GO <span class="hljs-number">5</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
GO <span class="hljs-number">5</span>
<span class="hljs-comment">/* This one is going to suck a little: he takes 3-5 seconds each time to run if the tiny-data plan goes in memory first. */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
GO <span class="hljs-number">5</span>
</code></pre>
<p>If you want to track plan cache changes over time, plus track root causes for why the plan cache will clear out, you can run this every 15 minutes:</p>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> dbo.sp_BlitzFirst 
  <span class="hljs-variable">@OutputDatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;DBAtools&#x27;</span>, 
  <span class="hljs-variable">@OutputSchemaName</span>	<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dbo&#x27;</span>, 
  <span class="hljs-variable">@OutputTableName</span>	<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameFileStats</span>	 <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst_FileStats&#x27;</span>,
  <span class="hljs-variable">@OutputTableNamePerfmonStats</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst_PerfmonStats&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameWaitStats</span>	 <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst_WaitStats&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameBlitzCache</span>	 <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzCache&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameBlitzWho</span>	 <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzWho&#x27;</span>,
  <span class="hljs-variable">@BlitzCacheSkipAnalysis</span>		 <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
GO
</code></pre>
<p>When you call sp_BlitzFirst like this, it's really running:
sp_BlitzCache @SortOrder = 'all', @MinutesBack = 15;
Which logs all of these sort orders in dbo.BlitzCache:</p>
<ul>
<li>CPU</li>
<li>Reads</li>
<li>Duration</li>
<li>Writes</li>
<li>Spills</li>
<li>Memory grant</li>
</ul>
<p>And more. It's basically finding the top 10 queries by each of those sort orders, so the most CPU-consuming, read-consuming spill-producing, etc.</p>
<p>As a result, it's 50-100 queries (depending on how yours sort out) - it's not the top 10 overall, but the top 10 for ALL of those sort methods.</p>
<p>For each one of those, you get its current plan and cumulative metrics. (Not the metrics for the last 15 minutes - the total metrics.)</p>
<pre><code class="language-sql"><span class="hljs-comment">/* Check the results: */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> DBAtools.dbo.BlitzFirst
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CheckDate <span class="hljs-keyword">DESC</span>, Priority <span class="hljs-keyword">ASC</span>, FindingsGroup <span class="hljs-keyword">ASC</span>, Finding <span class="hljs-keyword">ASC</span>;
GO
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> DBAtools.dbo.BlitzCache
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CheckDate <span class="hljs-keyword">DESC</span>, TotalCPU <span class="hljs-keyword">DESC</span>;
GO
</code></pre>
<p>Things to note in dbo.BlitzCache:</p>
<pre><code>* All numbers are cumulative since the last capture
* The only way to get Warnings (or anything else that involves parsing the XML) is to set @SkipAnalysis = 0, which takes 
more time for each execution
* If you set LAST_QUERY_PLAN_STATS = ON for a database, the QueryPlan column is the last actual plan 
- has est vs actual rows, rough spill info, and the compiled (but not runtime) parameters
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* So if something happens, and the plan gets reset: */</span>
<span class="hljs-keyword">ALTER</span> INDEX Location <span class="hljs-keyword">ON</span> dbo.Users REBUILD;
GO

<span class="hljs-comment">/* And then run the proc again with a different starting value - this time, with the one that was suffering, so he gets a 
perfect plan: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
GO <span class="hljs-number">5</span>

<span class="hljs-comment">/* And try tiny data - he&#x27;s quick: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>;
GO <span class="hljs-number">5</span>

<span class="hljs-comment">/* But then run it for India, which won&#x27;t do so well - 
  takes ~30 seconds just to run once: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
GO

<span class="hljs-comment">/* Then when sp_BlitzFirst logs data to disk again: This it the job that Brent created to run every 15 min */</span>
<span class="hljs-keyword">EXEC</span> dbo.sp_BlitzFirst 
  <span class="hljs-variable">@OutputDatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;DBAtools&#x27;</span>, 
  <span class="hljs-variable">@OutputSchemaName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dbo&#x27;</span>, 
  <span class="hljs-variable">@OutputTableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameFileStats</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst_FileStats&#x27;</span>,
  <span class="hljs-variable">@OutputTableNamePerfmonStats</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst_PerfmonStats&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameWaitStats</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst_WaitStats&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameBlitzCache</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzCache&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameBlitzWho</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzWho&#x27;</span>,
  <span class="hljs-variable">@BlitzCacheSkipAnalysis</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
GO

<span class="hljs-comment">/* You&#x27;ll be able to see the different plans for this query over time: */</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> 
  <span class="hljs-keyword">FROM</span> DBAtools.dbo.BlitzCache
  <span class="hljs-keyword">WHERE</span> QueryHash <span class="hljs-operator">=</span> <span class="hljs-number">0xC3D39254FF662673</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CheckDate <span class="hljs-keyword">DESC</span>;
GO
</code></pre>
<p>You can use this table to find:
* Distinct query plans (note the QueryPlanHash column)
* Which parameters produced the plan (to build a set of testing params)
* Total &amp; avg reads/CPU/duration/etc per plan</p>
<p>Here's an example query that will give you the top 10 queries that have burned the most CPU, and have multiple cached plans:</p>
<pre><code class="language-sql"><span class="hljs-keyword">WITH</span> MultiplePlans <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> 
      QueryHash
    , <span class="hljs-built_in">SUM</span>(TotalCPU) <span class="hljs-keyword">AS</span> TotalCPU
  <span class="hljs-keyword">FROM</span> DBAtools.dbo.BlitzCache
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> QueryHash
  <span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> QueryPlanHash) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">SUM</span>(TotalCPU) <span class="hljs-keyword">DESC</span>
)
<span class="hljs-keyword">SELECT</span> 
    mp.TotalCPU
  , mp.QueryHash
  , bc.<span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> MultiplePlans mp
<span class="hljs-keyword">JOIN</span> DBAtools.dbo.BlitzCache bc 
<span class="hljs-keyword">ON</span> mp.QueryHash <span class="hljs-operator">=</span> bc.QueryHash
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DESC</span>, bc.CheckDate <span class="hljs-keyword">DESC</span>;
</code></pre>
<p>But you can't tell:
* Which parameters each plan sucks for
* Min/max numbers for each plan (because we're not logging it...yet)
* Warnings for the plan (because it takes too long to examine every 15 minutes)
* &quot;Good&quot; versions of the plan (because they may not be in the top ~50)</p>
<p>We can augment our data a little if we happen to get lucky, and the data collection happens at the same time as a
long-running query.</p>
<pre><code class="language-sql">Run this <span class="hljs-number">30</span><span class="hljs-operator">-</span><span class="hljs-keyword">second</span> query <span class="hljs-keyword">in</span> another <span class="hljs-keyword">window</span>: <span class="hljs-operator">*</span><span class="hljs-operator">/</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
GO

<span class="hljs-comment">/* While you collect data with sp_BlitzFirst: */</span>
<span class="hljs-keyword">EXEC</span> dbo.sp_BlitzFirst 
  <span class="hljs-variable">@OutputDatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;DBAtools&#x27;</span>, 
  <span class="hljs-variable">@OutputSchemaName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dbo&#x27;</span>, 
  <span class="hljs-variable">@OutputTableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameFileStats</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst_FileStats&#x27;</span>,
  <span class="hljs-variable">@OutputTableNamePerfmonStats</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst_PerfmonStats&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameWaitStats</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzFirst_WaitStats&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameBlitzCache</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzCache&#x27;</span>,
  <span class="hljs-variable">@OutputTableNameBlitzWho</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;BlitzWho&#x27;</span>,
  <span class="hljs-variable">@BlitzCacheSkipAnalysis</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
GO

<span class="hljs-comment">/* For queries that happen to be running live, in SOME builds of SQL Server, but not 2019 CU13 &amp; newer, we get something 
amazing: check the live_query_plan column: */</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> DBAtools.dbo.BlitzWho;
</code></pre>
<p>Things to know:
* THIS HAS THE RUNTIME PARAMETERS W00T
* The plan and the metrics aren't the final metrics - they're the point-in-time when sp_BlitzWho runs
* This requires SQL Server 2016 SP1 or higher: <a href="https://www.brentozar.com/archive/2017/10/get-live-query-plans-sp_blitzwho/">https://www.brentozar.com/archive/2017/10/get-live-query-plans-sp_blitzwho/</a></p>
<p>This table also has the query hash, so you can filter just for one query:</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> 
  <span class="hljs-keyword">FROM</span> DBAtools.dbo.BlitzWho
  <span class="hljs-keyword">WHERE</span> query_hash <span class="hljs-operator">=</span> <span class="hljs-number">0xC3D39254FF662673</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CheckDate <span class="hljs-keyword">DESC</span>;
GO
</code></pre>
<p>So the plan cache helps - but much more so if you log it over time.</p>
<ul>
<li>Set up an Agent job to run sp_BlitzFirst to table every 15 minutes, and it'll also run sp_BlitzCache, sp_BlitzWho</li>
<li>The dbo.BlitzCache table has actual metrics, estimated plan, and the compiled plan (but only compiled params, not runtime)</li>
<li>For really terrible queries that happen to be running when sp_BlitzFirst's scheduled job runs, the dbo.BlitzWho table adds
the runtime parameters, AND the current (but not total) status of that plan, which can show why those params suck for the
current plan</li>
<li>It's up to you to assemble this data into a picture of the various plans and params for a single stored procedure.</li>
</ul>
<h1 id="lower-impact-query-store-usp_plancacheautopilot">Lower-Impact Query Store: usp_PlanCacheAutopilot</h1>
<p>If you monitor the plan cache looking for outliers, you can start to automate</p>
<ul>
<li>Identifying when a resource-intensive plan has gone into cache</li>
<li>Saving the plan and its parameters for later analysis</li>
<li>Freeing that plan from the cache automatically</li>
<li>That’s where usp_PlanCacheAutopilot comes in. Let’s talk through how to use it:</li>
</ul>
<p>Some Notes
* This sp cleans the plan from cache automatically
* Tested only on SQL 2019 and non prod</p>
<pre><code>![alt text](Image/Autopilot1.png)

![alt text](Image/Autopilot2.png)
</code></pre>
<pre><code class="language-sql">IF OBJECT_ID(<span class="hljs-string">&#x27;dbo.usp_PlanCacheAutopilot&#x27;</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-keyword">EXEC</span> (<span class="hljs-string">&#x27;CREATE PROCEDURE dbo.usp_PlanCacheAutopilot AS RETURN 0;&#x27;</span>);
GO

<span class="hljs-keyword">ALTER</span> PROC dbo.usp_PlanCacheAutopilot
  <span class="hljs-variable">@MinExecutions</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>,
  <span class="hljs-variable">@MinDurationSeconds</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>,
  <span class="hljs-variable">@MinCPUSeconds</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>,
  <span class="hljs-variable">@MinLogicalReads</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000</span>,
  <span class="hljs-variable">@MinLogicalWrites</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,
  <span class="hljs-variable">@MinSpills</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,
  <span class="hljs-variable">@MinGrantMB</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,
  <span class="hljs-variable">@OutputDatabaseName</span> NVARCHAR(<span class="hljs-number">258</span>) <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;DBAtools&#x27;</span>,
  <span class="hljs-variable">@OutputSchemaName</span> NVARCHAR(<span class="hljs-number">258</span>) <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dbo&#x27;</span>,
  <span class="hljs-variable">@OutputTableName</span> NVARCHAR(<span class="hljs-number">258</span>) <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;PlanCacheAutopilot&#x27;</span>,
  <span class="hljs-variable">@CheckDateOverride</span> DATETIMEOFFSET <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-variable">@LogThePlans</span> BIT <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,
  <span class="hljs-variable">@ClearThePlans</span> BIT <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,
  <span class="hljs-variable">@Debug</span> BIT <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,
  <span class="hljs-variable">@Version</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span> OUTPUT,
  <span class="hljs-variable">@VersionDate</span> DATETIME <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span> OUTPUT,
  <span class="hljs-variable">@VersionCheckMode</span> BIT <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">SET</span> NOCOUNT <span class="hljs-keyword">ON</span>;
<span class="hljs-keyword">SET</span> TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@Version</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;0.01&#x27;</span>, <span class="hljs-variable">@VersionDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;20200604&#x27;</span>;
<span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExec</span> NVARCHAR(MAX),
  <span class="hljs-variable">@crlf</span> NVARCHAR(<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> <span class="hljs-type">NCHAR</span>(<span class="hljs-number">13</span>) <span class="hljs-operator">+</span> <span class="hljs-type">NCHAR</span>(<span class="hljs-number">10</span>),
  <span class="hljs-variable">@CurrentPlanHandle</span> <span class="hljs-type">VARBINARY</span>(<span class="hljs-number">64</span>);

IF <span class="hljs-variable">@CheckDateOverride</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
  <span class="hljs-keyword">SET</span> <span class="hljs-variable">@CheckDateOverride</span> <span class="hljs-operator">=</span> SYSDATETIMEOFFSET();

<span class="hljs-comment">/* Using DISTINCT because we may have multiple lines in qs for a single plan,
some of which may have met our thresholds, and some not. I&#x27;m only freeing them
if specific lines have been bad enough to meet the threshold - it isn&#x27;t a 
problem if a big proc has dozens/hundreds of fast lines that add up to meet the
threshold in total. */</span>
RAISERROR(<span class="hljs-string">&#x27;Populating #ProblemPlans.&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> NOWAIT;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> #ProblemPlans (PlanHandle <span class="hljs-type">VARBINARY</span>(<span class="hljs-number">64</span>));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> #ProblemPlans (PlanHandle)
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> qs.plan_handle
  <span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats qs
  <span class="hljs-keyword">WHERE</span> qs.execution_count <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@MinExecutions</span>
    <span class="hljs-keyword">AND</span> qs.max_elapsed_time <span class="hljs-operator">&gt;=</span> (<span class="hljs-variable">@MinDurationSeconds</span> <span class="hljs-operator">*</span> <span class="hljs-number">1000</span>)
    <span class="hljs-keyword">AND</span> qs.max_worker_time <span class="hljs-operator">&gt;=</span> (<span class="hljs-variable">@MinCPUSeconds</span> <span class="hljs-operator">*</span> <span class="hljs-number">1000</span>)
    <span class="hljs-keyword">AND</span> qs.max_logical_reads <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@MinLogicalReads</span>
    <span class="hljs-keyword">AND</span> qs.max_logical_writes <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@MinLogicalWrites</span>
    <span class="hljs-keyword">AND</span> qs.max_spills <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@MinSpills</span>
    <span class="hljs-keyword">AND</span> qs.max_grant_kb <span class="hljs-operator">&gt;=</span> (<span class="hljs-variable">@MinGrantMB</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span>);

IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> #ProblemPlans)
  <span class="hljs-keyword">BEGIN</span>
  RAISERROR(<span class="hljs-string">&#x27;No plans found meeting the thresholds, exiting.&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> NOWAIT;
  <span class="hljs-keyword">RETURN</span>;
  <span class="hljs-keyword">END</span>

IF <span class="hljs-variable">@Debug</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> ##ProblemPlans;
  <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
    <span class="hljs-keyword">INTO</span> ##ProblemPlans
    <span class="hljs-keyword">FROM</span> #ProblemPlans;
  <span class="hljs-keyword">END</span>

IF <span class="hljs-variable">@LogThePlans</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> #ProblemPlans) 
  <span class="hljs-keyword">AND</span> <span class="hljs-variable">@OutputDatabaseName</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@OutputSchemaName</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@OutputTableName</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
  <span class="hljs-keyword">BEGIN</span>
  RAISERROR(<span class="hljs-string">&#x27;@LogThePlans = 1, so logging the #ProblemPlans to table.&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> NOWAIT;
  <span class="hljs-comment">/* Log the plans */</span>

  <span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@OutputDatabaseName</span> <span class="hljs-operator">=</span> QUOTENAME(<span class="hljs-variable">@OutputDatabaseName</span>),
    <span class="hljs-variable">@OutputSchemaName</span>   <span class="hljs-operator">=</span> QUOTENAME(<span class="hljs-variable">@OutputSchemaName</span>),
    <span class="hljs-variable">@OutputTableName</span>    <span class="hljs-operator">=</span> QUOTENAME(<span class="hljs-variable">@OutputTableName</span>);

  RAISERROR(<span class="hljs-string">&#x27;Creating the table if it does not exist.&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> NOWAIT;
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;USE &#x27;</span>
        <span class="hljs-operator">+</span> <span class="hljs-variable">@OutputDatabaseName</span>
        <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;; IF EXISTS(SELECT * FROM &#x27;</span>
        <span class="hljs-operator">+</span> <span class="hljs-variable">@OutputDatabaseName</span>
        <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;.INFORMATION_SCHEMA.SCHEMATA WHERE QUOTENAME(SCHEMA_NAME) = &#x27;&#x27;&#x27;</span>
        <span class="hljs-operator">+</span> <span class="hljs-variable">@OutputSchemaName</span>
        <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;&#x27;&#x27;) AND NOT EXISTS (SELECT * FROM &#x27;</span>
        <span class="hljs-operator">+</span> <span class="hljs-variable">@OutputDatabaseName</span>
        <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;.INFORMATION_SCHEMA.TABLES WHERE QUOTENAME(TABLE_SCHEMA) = &#x27;&#x27;&#x27;</span>
        <span class="hljs-operator">+</span> <span class="hljs-variable">@OutputSchemaName</span> <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;&#x27;&#x27; AND QUOTENAME(TABLE_NAME) = &#x27;&#x27;&#x27;</span>
        <span class="hljs-operator">+</span> <span class="hljs-variable">@OutputTableName</span> <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;&#x27;&#x27;) CREATE TABLE &#x27;</span>
        <span class="hljs-operator">+</span> <span class="hljs-variable">@OutputSchemaName</span> <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;.&#x27;</span>
        <span class="hljs-operator">+</span> <span class="hljs-variable">@OutputTableName</span>
        <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;(ID bigint NOT NULL IDENTITY(1,1),
    ServerName NVARCHAR(258),
    CheckDate DATETIMEOFFSET,
    plan_generation_num BIGINT,
    creation_time DATETIME,
    last_execution_time DATETIME,
    execution_count BIGINT,
    query_hash BINARY(8),
    query_plan_hash BINARY(8),
    plan_handle VARBINARY(64), 
    query_plan XML NULL,
    query_plan_last_actual XML NULL,
    total_worker_time BIGINT,
    last_worker_time BIGINT,
    min_worker_time BIGINT,
    max_worker_time BIGINT,
    total_logical_writes BIGINT,
    last_logical_writes BIGINT,
    min_logical_writes BIGINT,
    max_logical_writes BIGINT,
    total_logical_reads BIGINT,
    last_logical_reads BIGINT,
    min_logical_reads BIGINT,
    max_logical_reads BIGINT,
    total_clr_time BIGINT,
    last_clr_time BIGINT,
    min_clr_time BIGINT,
    max_clr_time BIGINT,
    total_elapsed_time BIGINT,
    last_elapsed_time BIGINT,
    min_elapsed_time BIGINT,
    max_elapsed_time BIGINT,
    total_rows BIGINT,
    last_rows BIGINT,
    min_rows BIGINT,
    max_rows BIGINT,
    total_dop BIGINT,
    last_dop BIGINT,
    min_dop BIGINT,
    max_dop BIGINT,
    total_grant_kb BIGINT,
    last_grant_kb BIGINT,
    min_grant_kb BIGINT,
    max_grant_kb BIGINT,
    total_used_grant_kb BIGINT,
    last_used_grant_kb BIGINT,
    min_used_grant_kb BIGINT,
    max_used_grant_kb BIGINT,
    total_ideal_grant_kb BIGINT,
    last_ideal_grant_kb BIGINT,
    min_ideal_grant_kb BIGINT,
    max_ideal_grant_kb BIGINT,
    total_reserved_threads BIGINT,
    last_reserved_threads BIGINT,
    min_reserved_threads BIGINT,
    max_reserved_threads BIGINT,
    total_used_threads BIGINT,
    last_used_threads BIGINT,
    min_used_threads BIGINT,
    max_used_threads BIGINT,
    total_columnstore_segment_reads BIGINT,
    last_columnstore_segment_reads BIGINT,
    min_columnstore_segment_reads BIGINT,
    max_columnstore_segment_reads BIGINT,
    total_columnstore_segment_skips BIGINT,
    last_columnstore_segment_skips BIGINT,
    min_columnstore_segment_skips BIGINT,
    max_columnstore_segment_skips BIGINT,
    total_spills BIGINT,
    last_spills BIGINT,
    min_spills BIGINT,
    max_spills BIGINT
    CONSTRAINT [PK_&#x27;</span> <span class="hljs-operator">+</span>REPLACE(REPLACE(<span class="hljs-variable">@OutputTableName</span>,<span class="hljs-string">&#x27;[&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>),<span class="hljs-string">&#x27;]&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;] PRIMARY KEY CLUSTERED(ID ASC));&#x27;</span>;

  IF <span class="hljs-variable">@Debug</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">BEGIN</span>
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">4000</span>, <span class="hljs-number">8000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">8000</span>, <span class="hljs-number">12000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">12000</span>, <span class="hljs-number">16000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">16000</span>, <span class="hljs-number">20000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">20000</span>, <span class="hljs-number">24000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">24000</span>, <span class="hljs-number">28000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">28000</span>, <span class="hljs-number">32000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">32000</span>, <span class="hljs-number">36000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">36000</span>, <span class="hljs-number">40000</span>);
    <span class="hljs-keyword">END</span>;

  <span class="hljs-comment">/* Creates the table */</span>
  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExec</span>;

  RAISERROR(<span class="hljs-string">&#x27;Building dynamic SQL to log plan metrics based on this version of SQL.&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> NOWAIT;
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;USE &#x27;</span><span class="hljs-operator">+</span> <span class="hljs-variable">@OutputDatabaseName</span> <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;; &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; WITH QueryStats AS (SELECT &#x27;</span>
    <span class="hljs-operator">+</span> QUOTENAME(<span class="hljs-built_in">CAST</span>(SERVERPROPERTY(<span class="hljs-string">&#x27;ServerName&#x27;</span>) <span class="hljs-keyword">AS</span> NVARCHAR(<span class="hljs-number">128</span>)), N<span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span>) <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AS ServerName, @CheckDateOverride AS CheckDate, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; MAX(qs.plan_generation_num) AS plan_generation_num, MAX(qs.creation_time) AS creation_time, MAX(qs.last_execution_time) AS last_execution_time, MAX(qs.execution_count) AS execution_count, query_hash, query_plan_hash, qs.plan_handle, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_worker_time) AS total_worker_time, SUM(last_worker_time) AS last_worker_time, SUM(min_worker_time) AS min_worker_time, SUM(max_worker_time) AS max_worker_time, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_logical_writes) AS total_logical_writes, SUM(last_logical_writes) AS last_logical_writes, SUM(min_logical_writes) AS min_logical_writes, SUM(max_logical_writes) AS max_logical_writes, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_logical_reads) AS total_logical_reads, SUM(last_logical_reads) AS last_logical_reads, SUM(min_logical_reads) AS min_logical_reads, SUM(max_logical_reads) AS max_logical_reads, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_clr_time) AS total_clr_time, SUM(last_clr_time) AS last_clr_time, SUM(min_clr_time) AS min_clr_time, SUM(max_clr_time) AS max_clr_time, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_elapsed_time) AS total_elapsed_time, SUM(last_elapsed_time) AS last_elapsed_time, SUM(min_elapsed_time) AS min_elapsed_time, SUM(max_elapsed_time) AS max_elapsed_time, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; MAX(total_rows) AS total_rows, MAX(last_rows) AS last_rows, MIN(min_rows) AS min_rows, MAX(max_rows) AS max_rows, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; MAX(total_dop) AS total_dop, MAX(last_dop) AS last_dop, MIN(min_dop) AS min_dop, MAX(max_dop) AS max_dop, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_grant_kb) AS total_grant_kb, SUM(last_grant_kb) AS last_grant_kb, SUM(min_grant_kb) AS min_grant_kb, SUM(max_grant_kb) AS max_grant_kb, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_used_grant_kb) AS total_used_grant_kb, SUM(last_used_grant_kb) AS last_used_grant_kb, SUM(min_used_grant_kb) AS min_used_grant_kb, SUM(max_used_grant_kb) AS max_used_grant_kb, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_ideal_grant_kb) AS total_ideal_grant_kb, SUM(last_ideal_grant_kb) AS last_ideal_grant_kb, SUM(min_ideal_grant_kb) AS min_ideal_grant_kb, SUM(max_ideal_grant_kb) AS max_ideal_grant_kb, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_reserved_threads) AS total_reserved_threads, SUM(last_reserved_threads) AS last_reserved_threads, MIN(min_reserved_threads) AS min_reserved_threads, MAX(max_reserved_threads) AS max_reserved_threads, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; MAX(total_used_threads) AS total_used_threads, MAX(last_used_threads) AS last_used_threads, MIN(min_used_threads) AS min_used_threads, MAX(max_used_threads) AS max_used_threads, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_columnstore_segment_reads) AS total_columnstore_segment_reads, SUM(last_columnstore_segment_reads) AS last_columnstore_segment_reads, SUM(min_columnstore_segment_reads) AS min_columnstore_segment_reads, SUM(max_columnstore_segment_reads) AS max_columnstore_segment_reads, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_columnstore_segment_skips) AS total_columnstore_segment_skips, SUM(last_columnstore_segment_skips) AS last_columnstore_segment_skips, SUM(min_columnstore_segment_skips) AS min_columnstore_segment_skips, SUM(max_columnstore_segment_skips) AS max_columnstore_segment_skips, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SUM(total_spills) AS total_spills, SUM(last_spills) AS last_spills, SUM(min_spills) AS min_spills, SUM(max_spills) AS max_spills &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; FROM #ProblemPlans p INNER JOIN sys.dm_exec_query_stats qs ON p.PlanHandle = qs.plan_handle &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; GROUP BY qs.plan_handle, qs.query_hash, qs.query_plan_hash ) &#x27;</span>;

  <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExec</span> 
        <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; INSERT INTO &#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-variable">@OutputSchemaName</span> <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-variable">@OutputTableName</span>
        <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;(ServerName, CheckDate, plan_generation_num, creation_time, last_execution_time, execution_count, query_hash, query_plan_hash, plan_handle, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; total_worker_time, last_worker_time, min_worker_time, max_worker_time, total_logical_writes, last_logical_writes, min_logical_writes, max_logical_writes, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; total_logical_reads, last_logical_reads, min_logical_reads, max_logical_reads, total_clr_time, last_clr_time, min_clr_time, max_clr_time, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; total_elapsed_time, last_elapsed_time, min_elapsed_time, max_elapsed_time, total_rows, last_rows, min_rows, max_rows, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; total_dop, last_dop, min_dop, max_dop, total_grant_kb, last_grant_kb, min_grant_kb, max_grant_kb, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; total_used_grant_kb, last_used_grant_kb, min_used_grant_kb, max_used_grant_kb, total_ideal_grant_kb, last_ideal_grant_kb, min_ideal_grant_kb, max_ideal_grant_kb, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; total_reserved_threads, last_reserved_threads, min_reserved_threads, max_reserved_threads, total_used_threads, last_used_threads, min_used_threads, max_used_threads, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; total_columnstore_segment_reads, last_columnstore_segment_reads, min_columnstore_segment_reads, max_columnstore_segment_reads, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; total_columnstore_segment_skips, last_columnstore_segment_skips, min_columnstore_segment_skips, max_columnstore_segment_skips, &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; total_spills, last_spills, min_spills, max_spills, query_plan, query_plan_last_actual) &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; SELECT qs.*, qp.query_plan,  &#x27;</span>;

  IF <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.all_objects <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dm_exec_query_plan_stats&#x27;</span>)
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; qps.query_plan AS query_plan_last_actual &#x27;</span>;
  <span class="hljs-keyword">ELSE</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; NULL AS query_plan_last_actual &#x27;</span>;

  <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExec</span> 
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; FROM QueryStats qs &#x27;</span>
    <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; OUTER APPLY sys.dm_exec_query_plan(qs.plan_handle) qp &#x27;</span>;

  IF <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.all_objects <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dm_exec_query_plan_stats&#x27;</span>)
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; OUTER APPLY sys.dm_exec_query_plan_stats(qs.plan_handle) qps; &#x27;</span>;

  IF <span class="hljs-variable">@Debug</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">BEGIN</span>
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">4000</span>, <span class="hljs-number">8000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">8000</span>, <span class="hljs-number">12000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">12000</span>, <span class="hljs-number">16000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">16000</span>, <span class="hljs-number">20000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">20000</span>, <span class="hljs-number">24000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">24000</span>, <span class="hljs-number">28000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">28000</span>, <span class="hljs-number">32000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">32000</span>, <span class="hljs-number">36000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">36000</span>, <span class="hljs-number">40000</span>);
    <span class="hljs-keyword">END</span>;

  RAISERROR(<span class="hljs-string">&#x27;Running dynamic SQL to log plan metrics based on this version of SQL.&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> NOWAIT;
  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExec</span>, N<span class="hljs-string">&#x27;@CheckDateOverride DATETIMEOFFSET&#x27;</span>, <span class="hljs-variable">@CheckDateOverride</span>;
  <span class="hljs-keyword">END</span>

<span class="hljs-comment">/* AFTER saving the plans&#x27; metrics, free them: */</span>
IF <span class="hljs-variable">@ClearThePlans</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> #ProblemPlans)
  <span class="hljs-keyword">BEGIN</span>
  RAISERROR(<span class="hljs-string">&#x27;@ClearThePlans = 1, so clearing the plans from cache.&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> NOWAIT;

  RAISERROR(<span class="hljs-string">&#x27;Building the dynamic SQL to clear the problem plans.&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> NOWAIT;
  <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> N<span class="hljs-string">&#x27;DBCC FREEPROCCACHE (&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">CONVERT</span>(NVARCHAR(<span class="hljs-number">128</span>), qs.PlanHandle, <span class="hljs-number">1</span>) <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;);&#x27;</span>
    <span class="hljs-keyword">FROM</span> #ProblemPlans qs
    <span class="hljs-keyword">FOR</span> XML PATH (<span class="hljs-string">&#x27;&#x27;</span>));

  IF <span class="hljs-variable">@Debug</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">BEGIN</span>
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">4000</span>, <span class="hljs-number">8000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">8000</span>, <span class="hljs-number">12000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">12000</span>, <span class="hljs-number">16000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">16000</span>, <span class="hljs-number">20000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">20000</span>, <span class="hljs-number">24000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">24000</span>, <span class="hljs-number">28000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">28000</span>, <span class="hljs-number">32000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">32000</span>, <span class="hljs-number">36000</span>);
    PRINT <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-variable">@StringToExec</span>, <span class="hljs-number">36000</span>, <span class="hljs-number">40000</span>);
    <span class="hljs-keyword">END</span>;

  <span class="hljs-comment">/* Frees the plan cache */</span>
  RAISERROR(<span class="hljs-string">&#x27;Running the dynamic SQL to clear the problem plans.&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> NOWAIT;
  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExec</span>;

  
  <span class="hljs-keyword">END</span>
<span class="hljs-keyword">END</span>

GO

<span class="hljs-keyword">EXEC</span> dbo.usp_PlanCacheAutopilot
  <span class="hljs-variable">@MinExecutions</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>,
  <span class="hljs-variable">@MinDurationSeconds</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>,
  <span class="hljs-variable">@MinCPUSeconds</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>,
  <span class="hljs-variable">@MinLogicalReads</span> <span class="hljs-operator">=</span> <span class="hljs-number">100000</span>,
  <span class="hljs-variable">@MinLogicalWrites</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,
  <span class="hljs-variable">@MinSpills</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,
  <span class="hljs-variable">@MinGrantMB</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,
  <span class="hljs-variable">@OutputDatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;DBAtools&#x27;</span>,
  <span class="hljs-variable">@OutputSchemaName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;dbo&#x27;</span>,
  <span class="hljs-variable">@OutputTableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;PlanCacheAutopilot&#x27;</span>,
  <span class="hljs-variable">@CheckDateOverride</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-variable">@LogThePlans</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>,
  <span class="hljs-variable">@ClearThePlans</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,
  <span class="hljs-variable">@Debug</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO
<span class="hljs-comment">/* For debugging:

SELECT * FROM ##ProblemPlans p
INNER JOIN sys.dm_exec_query_stats qs ON p.PlanHandle = qs.plan_handle
WHERE p.PlanHandle = 0x0500040040C37F1A2039DA107502000001000000000000000000000000000000000000000000000000000000
ORDER BY p.PlanHandle;

SELECT COUNT(*) FROM DBAtools.dbo.PlanCacheAutopilot;
SELECT TOP 100 * FROM DBAtools.dbo.PlanCacheAutopilot;

DROP TABLE IF EXISTS DBAtools.dbo.PlanCacheAutopilot;
*/</span>




<span class="hljs-comment">/*
MIT License

Copyright (c) 2021 Brent Ozar Unlimited

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/</span>  
</code></pre>
<h1 id="higher-impact-query-store">Higher-Impact: Query Store</h1>
<p>The method of logging sp_BlitzFirst/Cache/Who to table will probably give you everything you need to troubleshoot the majority of parameter sniffing situations. However, sometimes you need to gather even more data, and you’re willing to pay a performance price to get it.</p>
<p>Query Store is a built-in feature that can track dramatically more of the plan cache, even for queries that recompile, but it comes at a performance cost. We’ll enable it, talk about the problems with it, and show how to tell if your server is a good fit or not.</p>
<pre><code class="language-sql"><span class="hljs-comment">/* Set the stage with the right server options &amp; database config. If you already did this in the last module, you can keep it 
as-is: it&#x27;s the exact same indexes &amp; proc we used in the last module. */</span>
USE StackOverflow;
GO
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">140</span>; <span class="hljs-comment">/* 2017, not 2019 yet */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO
<span class="hljs-keyword">SET</span> STATISTICS IO, <span class="hljs-type">TIME</span> <span class="hljs-keyword">ON</span>;
GO

<span class="hljs-comment">/* Add a few indexes to let SQL Server choose. This can take 4-5 minutes. */</span>
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Users&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>;
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate,_dta_index_Posts_5_85575343__K8,IX_OwnerUserId,OwnerUserId&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Users&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>)
  <span class="hljs-keyword">CREATE</span> INDEX Location <span class="hljs-keyword">ON</span> dbo.Users(Location);
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;_dta_index_Posts_5_85575343__K8&#x27;</span>)
  <span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts._dta_index_Posts_5_85575343__K8&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;CreationDate&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;IX_OwnerUserId&#x27;</span>)
  <span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts.IX_OwnerUserId&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;OwnerUserId&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate&#x27;</span>)
  <span class="hljs-keyword">CREATE</span> INDEX CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate);
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;OwnerUserId&#x27;</span>)
  <span class="hljs-keyword">CREATE</span> INDEX OwnerUserId <span class="hljs-keyword">ON</span> dbo.Posts(OwnerUserId);
GO
</code></pre>
<p>Logging the plan cache gets you enough data to troubleshoot a lot of sniffing, but:</p>
<ul>
<li>Some queries have RECOMPILE hints</li>
<li>Some servers get so much memory pressure that the plan cache is worthless</li>
<li>Some shops can't install third party scripts</li>
</ul>
<p>So starting with SQL Server 2016, Query Store is a built-in option that logs the plan cache to disk. It logs the data into the user database itself.</p>
<pre><code class="language-sql"><span class="hljs-comment">/* Build our very sensitive proc, AND say someone &quot;fixed&quot; it with a recompile hint: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation_Recompile_OUTside
  <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">WITH</span> RECOMPILE <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Find the most recent posts from an area */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    u.DisplayName, p.Title, p.Id, p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
  <span class="hljs-keyword">AND</span>   p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* Free the plan cache just to make monitoring easier, then run a few variations - note no recompile hint here: */</span>
DBCC FREEPROCCACHE
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Tiny data */</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
GO

<span class="hljs-comment">/* Look in the plan cache: */</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats;
GO
sp_BlitzCache;
GO
</code></pre>
<p>Putting WITH RECOMPILE on the OUTSIDE of a stored procedure is TERRIBLE. (Unless you want to hide it from monitoring.)</p>
<p>This is where SQL Server 2016 &amp; newer's Query Store comes in handy. It can:</p>
<pre><code>* Catch every execution of a query, including compilation hints
* Catch queries 24/7, not just every 15 minutes
* Write the data into the user database itself
* Clean out its own history based on your settings
</code></pre>
<p>Let's look at the GUI, and then I'm going to enable it with these settings, BUT ONLY FOR DEMO PURPOSES. YOU SHOULD NEVER LOG EVERY MINUTE.</p>
<pre><code class="language-sql"><span class="hljs-keyword">ALTER</span> DATABASE [StackOverflow] <span class="hljs-keyword">SET</span> QUERY_STORE <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">ALTER</span> DATABASE [StackOverflow] <span class="hljs-keyword">SET</span> QUERY_STORE (OPERATION_MODE <span class="hljs-operator">=</span> READ_WRITE, DATA_FLUSH_INTERVAL_SECONDS <span class="hljs-operator">=</span> <span class="hljs-number">60</span>, INTERVAL_LENGTH_MINUTES <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
GO

<span class="hljs-comment">/* 
In case we need to clear it out during a demo: 
ALTER DATABASE [StackOverflow] SET QUERY_STORE CLEAR;
*/</span>

<span class="hljs-comment">/* Then run a bunch of our terrible outside queries that would usually disappear: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Big data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Big data, small dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Small data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Small data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Small data, small dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Outlier data, small dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Medium data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Medium data, small dates */</span>
GO <span class="hljs-number">10</span>

<span class="hljs-comment">/* 
Take a short look at where the data is being stored, and the kind of data we get: 
*/</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.query_store_query;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.query_store_runtime_stats;
GO
</code></pre>
<p>Go into the Query Store GUI, and walk through the reports:</p>
<pre><code>* Queries With High Variations
* Top Resource Consuming Queries
</code></pre>
<p>Note that for each plan - even recompiled plans - we get the parameters!</p>
<p>Pick one of the plans, and force it. Then try to run the queries again:</p>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Big data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Big data, small dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Small data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Small data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Small data, small dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Outlier data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Outlier data, small dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>; <span class="hljs-comment">/* Medium data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation_Recompile_OUTside <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span>; <span class="hljs-comment">/* Medium data, small dates */</span>
GO <span class="hljs-number">10</span>
</code></pre>
<p>The good news is that forcing a plan overrides the recompile hint!</p>
<p>The bad news is that one plan may not be good for everyone.</p>
<p>But that's not Query Store's fault: the problem is that there isn't one good plan that makes all of these go fast - yet, at least. That's where you will have your work cut out for you tomorrow.</p>
<p>Go unforce that plan for now.</p>
<p>I don't actually like the GUI for this - I much prefer sp_BlitzQueryStore:</p>
<pre><code class="language-sql"><span class="hljs-comment">/* Get the top 10: */</span>
<span class="hljs-keyword">EXEC</span> sp_BlitzQueryStore <span class="hljs-variable">@DatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;StackOverflow&#x27;</span>, <span class="hljs-variable">@Top</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>

<span class="hljs-comment">/* Minimum execution count, duration filter (seconds) */</span>
<span class="hljs-keyword">EXEC</span> sp_BlitzQueryStore 
  <span class="hljs-variable">@DatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;StackOverflow&#x27;</span>, 
  <span class="hljs-variable">@Top</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>, 
  <span class="hljs-variable">@MinimumExecutionCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>, 
  <span class="hljs-variable">@DurationFilter</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>

<span class="hljs-comment">/* Look for a stored procedure by name, get its params quickly */</span>
<span class="hljs-keyword">EXEC</span> sp_BlitzQueryStore <span class="hljs-variable">@DatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;StackOverflow&#x27;</span>, 
  <span class="hljs-variable">@Top</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>, 
  <span class="hljs-variable">@SkipXML</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>,
  <span class="hljs-variable">@StoredProcName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;usp_SearchPostsByLocation_Recompile_OUTside&#x27;</span>

<span class="hljs-comment">/* Filter for a date range: */</span>
<span class="hljs-keyword">EXEC</span> sp_BlitzQueryStore <span class="hljs-variable">@DatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;StackOverflow&#x27;</span>, 
  <span class="hljs-variable">@Top</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>, 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;20200530&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;20200605&#x27;</span>
GO

<span class="hljs-comment">/* You may also be able to query for all parameters that have been used for a few query plan hashes */</span>
;<span class="hljs-keyword">WITH</span> XMLNAMESPACES(<span class="hljs-string">&#x27;http://schemas.microsoft.com/sqlserver/2004/07/showplan&#x27;</span> <span class="hljs-keyword">AS</span> p), [raw_data] <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> [p].[plan_id],
    [p].[query_plan_hash],
    <span class="hljs-keyword">CONVERT</span>(XML, p.query_plan) <span class="hljs-keyword">AS</span> [query_plan]
  <span class="hljs-keyword">FROM</span> StackOverflow.sys.query_store_plan <span class="hljs-keyword">AS</span> [p]
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> StackOverflow.sys.query_store_runtime_stats <span class="hljs-keyword">AS</span> [rs] <span class="hljs-keyword">ON</span> [p].[plan_id] <span class="hljs-operator">=</span> [rs].[plan_id]
  <span class="hljs-keyword">WHERE</span> [p].[query_plan_hash] <span class="hljs-keyword">IN</span> (<span class="hljs-number">0xA6B47452A5D7511F</span>, <span class="hljs-number">0xC0DC86703A611840</span>)
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> [plan_id],
  [query_plan_hash],
  <span class="hljs-comment">-- [query_plan],</span>
  n.x.value(<span class="hljs-string">&#x27;@Column&#x27;</span>, <span class="hljs-string">&#x27;varchar(128)&#x27;</span>) <span class="hljs-operator">+</span> <span class="hljs-string">&#x27; = &#x27;</span> <span class="hljs-operator">+</span> n.x.value(<span class="hljs-string">&#x27;@ParameterCompiledValue&#x27;</span>, <span class="hljs-string">&#x27;varchar(128)&#x27;</span>) [<span class="hljs-keyword">parameter</span>]
<span class="hljs-keyword">FROM</span> [raw_data]
  <span class="hljs-keyword">CROSS</span> APPLY [query_plan].nodes(<span class="hljs-string">&#x27;//p:ParameterList/p:ColumnReference&#x27;</span>) <span class="hljs-keyword">AS</span> n(x)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> [plan_id], [<span class="hljs-keyword">parameter</span>];
GO
</code></pre>
<p>Query Store does have a performance overhead. The more queries that it has to examine, the higher the overhead will be. The worst case scenario is a workload whose queries constantly change, like unparameterized dynamic SQL.</p>
<p>Here's the example from Fundamentals of Parameter Sniffing:</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_GetUser <span class="hljs-variable">@UserId</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-variable">@DisplayName</span> NVARCHAR(<span class="hljs-number">40</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-variable">@Location</span> NVARCHAR(<span class="hljs-number">100</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-comment">/* They have to ask for either a UserId or a DisplayName or a Location: */</span>
IF <span class="hljs-variable">@UserId</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@DisplayName</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@Location</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
  <span class="hljs-keyword">RETURN</span>;

<span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExecute</span> NVARCHAR(<span class="hljs-number">4000</span>);
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;SELECT * FROM dbo.Users WHERE 1 = 1 &#x27;</span>;

IF <span class="hljs-variable">@UserId</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
  <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND Id = &#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-variable">@UserId</span> <span class="hljs-keyword">AS</span> NVARCHAR(<span class="hljs-number">10</span>));

IF <span class="hljs-variable">@DisplayName</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
  <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND DisplayName = &#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-variable">@DisplayName</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span>;

IF <span class="hljs-variable">@Location</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
  <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND Location = &#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-variable">@Location</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span>;

<span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExecute</span>;
<span class="hljs-keyword">END</span>
GO


<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_DynamicSQLLab] <span class="hljs-keyword">WITH</span> RECOMPILE <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Hi! You can ignore this stored procedure.
    This is used to run different random stored procs as part of your class.
    Don&#x27;t change this in order to &quot;tune&quot; things.
  */</span>
  <span class="hljs-keyword">SET</span> NOCOUNT <span class="hljs-keyword">ON</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@Id1</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">CAST</span>(RAND() <span class="hljs-operator">*</span> <span class="hljs-number">1000000</span> <span class="hljs-keyword">AS</span> <span class="hljs-type">INT</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span>,
      <span class="hljs-variable">@Param1</span> NVARCHAR(<span class="hljs-number">100</span>);

  IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">4</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>
    <span class="hljs-keyword">EXEC</span> dbo.usp_GetUser <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span>;
  <span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">4</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>
    <span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@Param1</span> <span class="hljs-operator">=</span> Location <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Id <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span> OPTION (RECOMPILE);
    <span class="hljs-keyword">EXEC</span> dbo.usp_GetUser <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Param1</span>;
    <span class="hljs-keyword">END</span>
  <span class="hljs-keyword">ELSE</span>
    <span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@Param1</span> <span class="hljs-operator">=</span> DisplayName <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Id <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span> OPTION (RECOMPILE);
    <span class="hljs-keyword">EXEC</span> dbo.usp_GetUser <span class="hljs-variable">@DisplayName</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Param1</span>;
    <span class="hljs-keyword">END</span>
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* */</span>
<span class="hljs-keyword">EXEC</span> usp_DynamicSQLLab;
GO <span class="hljs-number">500</span>
</code></pre>
<p>To find out if your server is going to have a problem with constant query compilations triggering Query Store to do a lot of work, run this: <a href="https://www.brentozar.com/archive/2018/07/tsql2sday-how-much-plan-cache-history-do-you-have/">https://www.brentozar.com/archive/2018/07/tsql2sday-how-much-plan-cache-history-do-you-have/</a></p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">50</span>
    creation_date <span class="hljs-operator">=</span> <span class="hljs-built_in">CAST</span>(creation_time <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>),
    creation_hour <span class="hljs-operator">=</span> <span class="hljs-keyword">CASE</span>
                        <span class="hljs-keyword">WHEN</span> <span class="hljs-built_in">CAST</span>(creation_time <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-built_in">CAST</span>(GETDATE() <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span>
                        <span class="hljs-keyword">ELSE</span> DATEPART(hh, creation_time)
                    <span class="hljs-keyword">END</span>,
    <span class="hljs-built_in">SUM</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> plans
<span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">CAST</span>(creation_time <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>),
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-built_in">CAST</span>(creation_time <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-built_in">CAST</span>(GETDATE() <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span>
            <span class="hljs-keyword">ELSE</span> DATEPART(hh, creation_time)
        <span class="hljs-keyword">END</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DESC</span>, <span class="hljs-number">2</span> <span class="hljs-keyword">DESC</span>
</code></pre>
<p>If your SQL Server is seeing 10,000 or more queries per hour, and it can only remember the last 2-4 hours of queries, then you're probably going to have a tough time with the performance overhead of Query Store. Get the queries parameterized first, or use Forced Parameterization:</p>
<p><a href="https://www.brentozar.com/training/mastering-server-tuning-wait-stats-live-3-days-recording/3-1-plan-caching-and-parameterization/">https://www.brentozar.com/training/mastering-server-tuning-wait-stats-live-3-days-recording/3-1-plan-caching-and-parameterization/</a></p>
<p>Although ironically...if you use that, then you're going to experience parameter sniffing! Because now these queries will get reusable plans.</p>
<p>What to take away from this demo:</p>
<pre><code>* Query Store can capture every possible variety of every compilation. If you need to track queries with recompile hints, it's great.

* It does add overhead. To minimize it, read Erin Stellato's Query Store Best Practices:
https://www.sqlskills.com/blogs/erin/query-store-best-practices/

* If you aren't a good fit for Query Store, don't forget that sp_BlitzWho can log live query plans on 2016+ when it catches queries running during the every-15-minute capture job. It's nowhere near as good as Query Store, but it's a decent Plan B.

* If you love Query Store, check out sp_QuickieStore: https://www.erikdarlingdata.com/sp_quickiestore/

* In SQL Server 2022, Query Store is on by default but only for newly created databases.
</code></pre>
<h1 id="lab-3">LAB 3</h1>
<h2 id="lab-3-setup-track-down-sniffing-in-plan-cache-history">Lab 3 Setup: Track Down Sniffing in Plan Cache History</h2>
<pre><code>Now, it’s your turn: 
We’re going to run a workload in your lab while sp_BlitzFirst collects data and Query Store runs. You’ll query the plan cache history in DBAtools.dbo.BlitzCache and BlitzWho, find queries whose plans are changing, and gather parameters &amp; plans to use that will help you design a better plan tomorrow.

You don’t have to fix the parameter sniffing yet. Your goal here is just to start identifying problematic queries and collecting data about them. I can’t emphasize this enough: my goal with this lab is to give you a lot of different queries, many of which can have parameter sniffing issues, so that you’ve got a wide variety of challenges over time as you revisit this lab. Don’t think that there’s only “one answer” that you need to find – here, I’m just getting you used to surveying how big the landscape is. In the real world, you would focus on big runaway queries and queries users are complaining about.

Your goal is to use the Blitz% tables and/or Query Store to:

* Identify the worst-performing query that you’d want to tune if given the chance (and don’t worry about whether or not it has parameter sniffing issues – pretty much everything in this lab does)
* Gather at least 2 sets of parameters that are being used to call it in production
* Gather at least 2 different execution plans that are being generated in production (estimated, or last actual, or mid-flight)
and then turn those into me in Slack. You can use PasteThePlan.com to share query plans.
</code></pre>
<h2 id="my-solution-1">My Solution</h2>
<pre><code class="language-sql"><span class="hljs-comment">/*
Your goal is to use the Blitz% tables and/or Query Store to:

  * Identify the worst-performing query that you’d want to tune if given the chance (and don’t worry about whether or not it has parameter sniffing issues 
  – pretty much everything in this lab does)

  * Gather at least 2 sets of parameters that are being used to call it in production

  * Gather at least 2 different execution plans that are being generated in production (estimated, or last actual, or mid-flight)
    And then turn those into me in Slack. You can use PasteThePlan.com to share query plans.
*/</span>


<span class="hljs-comment">/* Using Query Store */</span>
<span class="hljs-keyword">begin</span>

  <span class="hljs-comment">/* By CPU */</span>
    <span class="hljs-comment">-- Query</span>
    <span class="hljs-keyword">SELECT</span> TOP (<span class="hljs-variable">@ResultsToShow</span>) 
      p.CreationDate, p.Score, <span class="hljs-built_in">COALESCE</span>(p.Title, pParent.Title) <span class="hljs-keyword">AS</span> Title, u.DisplayName <span class="hljs-keyword">AS</span> OwnerDisplayName
    <span class="hljs-keyword">FROM</span> dbo.PostTypes pt
    <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> pt.Id <span class="hljs-operator">=</span> p.PostTypeId
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pParent <span class="hljs-keyword">ON</span> p.ParentId <span class="hljs-operator">=</span> pParent.Id
    <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
    <span class="hljs-keyword">WHERE</span> pt.Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostType</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&lt;=</span> <span class="hljs-variable">@EndDate</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate

    <span class="hljs-comment">-- Parameter List</span>
    <span class="hljs-operator">&lt;</span>ParameterList<span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@ResultsToShow&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;int&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;(10000)&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@EndDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2011-11-30 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@StartDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2011-11-01 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@PostType&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;nvarchar(50)&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;N&#x27;Question&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
    <span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>ParameterList<span class="hljs-operator">&gt;</span>

    <span class="hljs-operator">&lt;</span>ParameterList<span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@ResultsToShow&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;int&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;(100)&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@EndDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2011-11-02 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@StartDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2011-11-01 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@PostType&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;nvarchar(50)&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;N&#x27;ModeratorNomination&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
    <span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>ParameterList<span class="hljs-operator">&gt;</span>


  <span class="hljs-comment">/* By Memory Consuption */</span>
    <span class="hljs-comment">-- Query</span>
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> r.ResponseTimeSeconds, pQuestion.Title, pQuestion.CreationDate, pQuestion.Body,
    uQuestion.DisplayName <span class="hljs-keyword">AS</span> Questioner_DisplayName, uQuestion.Reputation <span class="hljs-keyword">AS</span> Questioner_Reputation,
    pAnswer.Body <span class="hljs-keyword">AS</span> Answer_Body, pAnswer.Score <span class="hljs-keyword">AS</span> Answer_Score,
    uAnswer.DisplayName <span class="hljs-keyword">AS</span> Answerer_DisplayName, uAnswer.Reputation <span class="hljs-keyword">AS</span> Answerer_Reputation
    <span class="hljs-keyword">FROM</span> dbo.AverageAnswerResponseTime r
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pQuestion <span class="hljs-keyword">ON</span> r.Id <span class="hljs-operator">=</span> pQuestion.Id
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users uQuestion <span class="hljs-keyword">ON</span> pQuestion.OwnerUserId <span class="hljs-operator">=</span> uQuestion.Id
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pAnswer <span class="hljs-keyword">ON</span> pQuestion.AcceptedAnswerId <span class="hljs-operator">=</span> pAnswer.Id
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users uAnswer <span class="hljs-keyword">ON</span> pAnswer.OwnerUserId <span class="hljs-operator">=</span> uAnswer.Id
    <span class="hljs-keyword">WHERE</span> r.QuestionDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
    <span class="hljs-keyword">AND</span> r.QuestionDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
    <span class="hljs-keyword">AND</span> r.Tags <span class="hljs-operator">=</span> <span class="hljs-variable">@Tag</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.ResponseTimeSeconds <span class="hljs-keyword">ASC</span>

    <span class="hljs-comment">-- Parameter List</span>
    <span class="hljs-operator">&lt;</span>ParameterList<span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@Tag&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;nvarchar(50)&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;N&#x27;&amp;lt;sql-server&amp;gt;&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@EndDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2017-05-14 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@StartDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2017-05-13 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
    <span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>ParameterList<span class="hljs-operator">&gt;</span>

    <span class="hljs-operator">&lt;</span>ParameterList<span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@Tag&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;nvarchar(50)&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;N&#x27;&amp;lt;sql-server&amp;gt;&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@EndDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2018-01-16 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@StartDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2017-07-16 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
    <span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>ParameterList<span class="hljs-operator">&gt;</span>


  <span class="hljs-comment">/* By Memory on TEMPDB */</span>
    <span class="hljs-comment">-- Query</span>
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">250</span> <span class="hljs-operator">*</span>
      <span class="hljs-keyword">FROM</span> dbo.PostTypes pt 
      <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> pt.Id <span class="hljs-operator">=</span> p.PostTypeId
      <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
      <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
      <span class="hljs-keyword">AND</span> pt.Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostTypeName</span>
      <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> AnswerCount <span class="hljs-keyword">DESC</span>

    <span class="hljs-comment">-- Parameter List</span>
    <span class="hljs-operator">&lt;</span>ParameterList<span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@PostTypeName&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;varchar(50)&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;Question&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@EndDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2017-06-16 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@StartDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2017-06-15 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
    <span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>ParameterList<span class="hljs-operator">&gt;</span>

    <span class="hljs-operator">&lt;</span>ParameterList<span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@PostTypeName&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;varchar(50)&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;Answer&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@EndDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2017-09-24 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
      <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@StartDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2017-09-23 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
    <span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>ParameterList<span class="hljs-operator">&gt;</span>
<span class="hljs-keyword">end</span>


<span class="hljs-comment">/* sp_BlitzFirst Job */</span>

  <span class="hljs-comment">/* By CPU */</span>
  <span class="hljs-keyword">SELECT</span> 
    QueryType, Warnings, DatabaseName, AverageCPU, TotalCPU, PercentCPUByType, CPUWeight, ExecutionCount, PlanHandle, 
    SqlHandle, QueryText, QueryPlan, NumberOfPlans, NumberOfDistinctPlans
  <span class="hljs-keyword">FROM</span> DBAtools.dbo.BlitzCache
  <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">Pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CPU&#x27;</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> AverageCPU <span class="hljs-keyword">DESC</span>

  <span class="hljs-comment">-- Query</span>
  <span class="hljs-keyword">Is</span> the same
  Statement (parent [dbo].[usp_SearchPostsByPostType])

  <span class="hljs-comment">-- Patameters are different</span>
    <span class="hljs-operator">&lt;</span>ParameterList<span class="hljs-operator">&gt;</span>
        <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@ResultsToShow&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;int&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;(10000)&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
        <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@EndDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2011-11-30 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
        <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@StartDate&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;datetime&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;&#x27;2011-11-01 00:00:00.000&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
        <span class="hljs-operator">&lt;</span>ColumnReference <span class="hljs-keyword">Column</span><span class="hljs-operator">=</span>&quot;@PostType&quot; ParameterDataType<span class="hljs-operator">=</span>&quot;nvarchar(50)&quot; ParameterCompiledValue<span class="hljs-operator">=</span>&quot;N&#x27;ModeratorNomination&#x27;&quot; <span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
    <span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>ParameterList<span class="hljs-operator">&gt;</span>

</code></pre>
<h2 id="brent-solution">Brent Solution</h2>
<h1 id="memory-grant-feedback">Memory Grant Feedback</h1>
<p>On day 1, we implemented monitoring to start collecting plans having parameter sniffing issues. To keep things simple, we kept the compatibility level at 2017. Now let’s start exploring the features that SQL Server 2019 brings to the table – in spirit, they’re supposed to help SQL Server adapt to varying amounts of data moving through an execution plan. In practice, they mean even more changes to query plans, and they can backfire, hard.</p>
<p>First up: memory grant feedback helps balance between TempDB spills and RESOURCE_SEMAPHORE poison waits. Well, that’s what the brochure says, anyway, but it turns out that it multiplies parameter sniffing problems in OLTP environments, making even predictable plans behave unpredictably.</p>
<p>Introduction to Memory Grants
If you haven’t been through Mastering Query Tuning, where we discuss how memory grants, this short primer will get you up to speed first:</p>
<pre><code class="language-sql"><span class="hljs-comment">/*
Mastering Parameter Sniffing
How Adaptive Memory Grants Mitigate Parameter Sniffing

v1.4 - 2022-06-07

https://www.BrentOzar.com/go/mastersniffing


This demo requires:
* SQL Server 2019 or newer
  (there&#x27;s a SQL Server 2022 section, but that&#x27;s optional)
* 2018-06 Stack Overflow database: https://www.BrentOzar.com/go/querystack

This first RAISERROR is just to make sure you don&#x27;t accidentally hit F5 and
run the entire script. You don&#x27;t need to run this:
*/</span>
RAISERROR(N<span class="hljs-string">&#x27;Oops! No, don&#x27;&#x27;t just hit F5. Run these demos one at a time.&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> LOG;
GO


<span class="hljs-comment">/* Set the stage with the right server options &amp; database config.
If you already did this in the last module, you can keep it as-is:
it&#x27;s the exact same indexes &amp; proc we used in the last module. */</span>
USE StackOverflow;
GO
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Users&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>;
<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate,_dta_index_Posts_5_85575343__K8,IX_OwnerUserId,OwnerUserId&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Users&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Location&#x27;</span>)
  <span class="hljs-keyword">CREATE</span> INDEX Location <span class="hljs-keyword">ON</span> dbo.Users(Location);
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;_dta_index_Posts_5_85575343__K8&#x27;</span>)
  <span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts._dta_index_Posts_5_85575343__K8&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;CreationDate&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;IX_OwnerUserId&#x27;</span>)
  <span class="hljs-keyword">EXEC</span> sp_rename <span class="hljs-variable">@objname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;dbo.Posts.IX_OwnerUserId&#x27;</span>, <span class="hljs-variable">@newname</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;OwnerUserId&#x27;</span>, <span class="hljs-variable">@objtype</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;INDEX&#x27;</span>;
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate&#x27;</span>)
  <span class="hljs-keyword">CREATE</span> INDEX CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate);
GO
IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;OwnerUserId&#x27;</span>)
  <span class="hljs-keyword">CREATE</span> INDEX OwnerUserId <span class="hljs-keyword">ON</span> dbo.Posts(OwnerUserId);
GO
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">140</span>; <span class="hljs-comment">/* 2017, not 2019 yet */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO

<span class="hljs-comment">/* Our regular sensitive proc: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation
  <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-comment">/* Find the most recent posts from an area */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> u.DisplayName, p.Title, p.Id, p.CreationDate,
  <span class="hljs-comment">/* I added these columns to get a bigger sort: */</span>
  u.Location, u.WebsiteUrl, u.AboutMe, u.EmailHash, p.Body
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO


<span class="hljs-comment">/* I&#x27;m going to call this with recompile to show that some plan variations will
need a memory grant for the sort, and some will not: */</span>

<span class="hljs-comment">/* No sort - using the p.CreationDate index for the sort: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, small dates */</span>

<span class="hljs-comment">/* These DO have a sort, so their grant size varies based on the data volume: */</span> 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, medium dates */</span>
<span class="hljs-comment">/* No sort here: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, small dates */</span>

<span class="hljs-comment">/* Sort w/grant: */</span> 
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, medium dates */</span>
<span class="hljs-comment">/* No sort, no grant: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, small dates */</span>

<span class="hljs-comment">/* Sort w/grant, spills: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, big dates */</span>
<span class="hljs-comment">/* Sort w/grant: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, small dates */</span>
GO


<span class="hljs-comment">/* So in terms of memory grants &amp; spills, my two worst cases are:

* The Tiny Grant That Constantly Spills to TempDB
  1. Parameters are used that ask for a tiny memory grant
  2. Other parameters need a HUGE grant, but don&#x27;t get it
  3. When they run, they spill to TempDB and take forever
  General symptom: unhappy users

* The Big Unused Grant:
  1. Parameters are used that ask for a large memory grant
  2. Other parameters don&#x27;t need the grant
  3. SQL Server ends up leaving all the memory unused every time the query runs,
    causing RESOURCE_SEMAPHORE waits. More info: 
    https://www.brentozar.com/training/mastering-server-tuning-wait-stats-live-3-days-recording/2-5-memory-waits-resource_semaphore-38m/
  General symptom: unhappy sysadmins, low PLE.

We&#x27;ll show the tiny grant first. Put a tiny grant plan in memory.
Which one should we use? */</span>

<span class="hljs-keyword">EXEC</span> sp_recompile <span class="hljs-string">&#x27;usp_SearchPostsByLocation&#x27;</span>;
GO
<span class="hljs-comment">/* Tiny grant goes in - check actual plan: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>;
GO
<span class="hljs-comment">/* Now call it for big data: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>;
GO

<span class="hljs-comment">/* Well, that&#x27;s not good. And try it again, and the same thing happens: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>;
GO



<span class="hljs-comment">/* That&#x27;s the tiny-grant, big-spill situation.

Now let&#x27;s see the opposite: a query that wants a large memory grant goes in first,
and then other parameters don&#x27;t use it: */</span>
<span class="hljs-keyword">EXEC</span> sp_recompile <span class="hljs-string">&#x27;usp_SearchPostsByLocation&#x27;</span>;
GO
<span class="hljs-comment">/* This gets a grant: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
GO
<span class="hljs-comment">/* Now run it for tiny data: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>;
GO
<span class="hljs-comment">/* And note the  yellow bang on the plan - we&#x27;re just not using that memory.
Well, honestly, that isn&#x27;t a big grant though - and if we run it for big data,
we actually do use it: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>;
GO


<span class="hljs-comment">/* That&#x27;s how everything worked up to SQL Server 2019.

In SQL Server 2016, Microsoft introduced adaptive memory grants, but they only
activated &#x27;em for queries that had a columnstore index on one of the tables,
because that activated Batch Mode processing.
*/</span>
<span class="hljs-keyword">CREATE</span> NONCLUSTERED COLUMNSTORE INDEX NCCI_Empty <span class="hljs-keyword">ON</span> dbo.Users(Age) <span class="hljs-keyword">WHERE</span> Age <span class="hljs-operator">=</span> <span class="hljs-number">-1</span>;
GO
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Age <span class="hljs-operator">=</span> <span class="hljs-number">-1</span>;
GO
<span class="hljs-comment">/* Nada. But that empty filtered index - just the presence of it - means that
SQL Server will suddenly consider Batch Mode, even on 2017 compat level.

Sometimes that helps! Let&#x27;s take a look: */</span>
<span class="hljs-keyword">EXEC</span> sp_recompile <span class="hljs-string">&#x27;usp_SearchPostsByLocation&#x27;</span>;
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
GO


<span class="hljs-comment">/* Things to keep in mind:

* My query doesn&#x27;t refer to Age
* My query doesn&#x27;t use that index on Age, nor any statistics on Age
* I&#x27;m still on 2017 compat level
* NOTHING ABOUT MY QUERY SHOULD HAVE GONE SO TERRIBLY WRONG

To see what&#x27;s happening, run this in another window and look at the plan,
hovering your mouse over each operator, looking at Batch Mode, AND look at
the memory grant this query gets:
*/</span>
sp_BlitzWho;
GO


<span class="hljs-comment">/* The good news, is, uh, ... we didn&#x27;t spill to disk.

The bad news is:
* Memory grant size
* Memory grant used
* Users are gathering at the door with pitchforks

There&#x27;s a silver lining though: Batch Mode enables adaptive memory grants:
* Desired memory	= 
* Requested memory	= 
* Granted memory	= 
* Used memory		= 

And run it again: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
GO

<span class="hljs-comment">/* But I think the empty nonclustered columnstore index trick is a REALLY bad
way to get adaptive grants. Let&#x27;s drop that and do it the right way: */</span>
<span class="hljs-keyword">DROP</span> INDEX NCCI_Empty <span class="hljs-keyword">ON</span> dbo.Users;
GO
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">150</span>; <span class="hljs-comment">/* 2019, which enables adaptive grants on rowstore indexes */</span>
GO
<span class="hljs-comment">/* And try it again: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
GO
<span class="hljs-comment">/* Make a <span class="hljs-doctag">note:</span>
* Desired memory	= 
* Requested memory	= 
* Granted memory	= 
* Used memory		= 

And run it again: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
GO
<span class="hljs-comment">/* Well, it&#x27;s, uh, &quot;adapting&quot; alright. Third try&#x27;s a charm, maybe? */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>; <span class="hljs-comment">/* Medium data, big dates */</span>
GO
<span class="hljs-comment">/* As you continue to run it, it will continue to adapt. However, it&#x27;s always
adapting to the LAST time the query ran. Now try it with tiny data: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>;
GO
<span class="hljs-comment">/* SQL Server goes into a full on panic, thinking it WAY overestimated.
It&#x27;ll &quot;fix&quot; that next time around, lowering the grant: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>;
GO

<span class="hljs-comment">/* But now call it for big data, and it&#x27;ll spill to disk: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>;
GO

<span class="hljs-comment">/* Spotting this can be really tricky. Turn off actual plans: */</span>
sp_BlitzCache <span class="hljs-variable">@SortOrder</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;spills&#x27;</span>;
GO
<span class="hljs-comment">/* Things to look for:

* Wide variance in spills to disk
* Wide variance between min &amp; max memory grant KB

To learn more about this feature:
https://docs.microsoft.com/en-us/sql/relational-databases/performance/intelligent-query-processing?view=sql-server-ver15#row-mode-memory-grant-feedback

To turn it off for specific queries:
OPTION (USE HINT (&#x27;DISABLE_ROW_MODE_MEMORY_GRANT_FEEDBACK&#x27;)); 

To turn it off for the database altogether while keeping 2019 compat level: */</span>
<span class="hljs-keyword">ALTER</span> DATABASE SCOPED CONFIGURATION 
  <span class="hljs-keyword">SET</span> ROW_MODE_MEMORY_GRANT_FEEDBACK <span class="hljs-operator">=</span> OFF;
<span class="hljs-keyword">ALTER</span> DATABASE SCOPED CONFIGURATION 
  <span class="hljs-keyword">SET</span> BATCH_MODE_MEMORY_GRANT_FEEDBACK <span class="hljs-operator">=</span> OFF;
GO



<span class="hljs-comment">/* SQL Server 2022 tried to fix this problem
by using percentile-based changes rather than
huge swings:
https://docs.microsoft.com/en-us/sql/relational-databases/performance/intelligent-query-processing?view=sql-server-ver16#percentile-and-persistence-mode-memory-grant-feedback

To turn it on: */</span>
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">160</span>;

<span class="hljs-comment">/* These already default to on in 160,
but I leave &#x27;em here in case you turned &#x27;em off: */</span>
<span class="hljs-keyword">ALTER</span> DATABASE SCOPED CONFIGURATION 
  <span class="hljs-keyword">SET</span> ROW_MODE_MEMORY_GRANT_FEEDBACK <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>;
<span class="hljs-keyword">ALTER</span> DATABASE SCOPED CONFIGURATION 
  <span class="hljs-keyword">SET</span> BATCH_MODE_MEMORY_GRANT_FEEDBACK <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>;

<span class="hljs-comment">/* Save grants to Query Store so they show up
on failovers, restarts, etc. Requires Query Store
to be on, which is on by default in the 2018-06
training copy of the database: */</span>
<span class="hljs-keyword">ALTER</span> DATABASE SCOPED CONFIGURATION
  <span class="hljs-keyword">SET</span> MEMORY_GRANT_FEEDBACK_PERSISTENCE <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>;
GO

<span class="hljs-comment">/* Smaller grant swing sizes: */</span>
<span class="hljs-keyword">ALTER</span> DATABASE SCOPED CONFIGURATION
  <span class="hljs-keyword">SET</span> MEMORY_GRANT_FEEDBACK_PERCENTILE <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>;

<span class="hljs-comment">/* That above doesn&#x27;t work yet in CTP 2.0, 
but oddly, it shows as on: */</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.database_scoped_configurations
  <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%MEMORY%&#x27;</span>;
GO

<span class="hljs-comment">/* Let&#x27;s see if it works in small percentile swings.
Run the tiny grant first: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>;
GO
<span class="hljs-comment">/* Now call it for big data: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>;
GO

<span class="hljs-comment">/* That&#x27;s still not fixed - but run it again: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>;
GO

<span class="hljs-comment">/* The swing was giant! Try big again: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>;
GO
<span class="hljs-comment">/* Now we&#x27;re making smaller percentile changes.
That&#x27;s the 2022 improvement.

But try it again for tiny data: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span>;
GO

<span class="hljs-comment">/* Then for big: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span>;
GO

<span class="hljs-comment">/* It didn&#x27;t drop all the way down to zero!
Percentile grants are an improvement over 2019. */</span>


<span class="hljs-comment">/* 
What to take away from this demo:

* Batch Mode Memory Grant Feedback was a really useful feature in 2016-2017
  because columnstore indexes got HUGE memory grants back then.

* I&#x27;m not a fan of the empty columnstore index trick to get batch mode on
  rowstore tables: it can backfire pretty hard. (I&#x27;m a fan of batch mode where
  it&#x27;s appropriate, but 2-3 second OLTP queries ain&#x27;t where it&#x27;s at yet.)

* Row Mode Memory Grant Feedback is a lot sketchier. If you have parameter-
  sensitive queries, you can ride the grant rollercoaster and performance can
  be way worse than a single stable grant (either too high or too low.)

* In 2019, I turn this off at OLTP shops, but love it for reporting systems.
  In 2022, it&#x27;s more qualified for everybody.

* Mostly I just want you to be aware that the feature exists, and that it
  CAUSES (not cures) parameter sniffing problems by making a predictable plan
  less predictable (and more worse.)

*/</span>




<span class="hljs-comment">/*
License: Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)
More info: https://creativecommons.org/licenses/by-sa/4.0/

You are free to:
* Share - copy and redistribute the material in any medium or format
* Adapt - remix, transform, and build upon the material for any purpose, even 
  commercially

Under the following terms:
* Attribution - You must give appropriate credit, provide a link to the license, 
  and indicate if changes were made. You may do so in any reasonable manner, 
  but not in any way that suggests the licensor endorses you or your use.
* ShareAlike - If you remix, transform, or build upon the material, you must
  distribute your contributions under the same license as the original.
*/</span>
</code></pre>
<h1 id="adaptive-joins">Adaptive Joins</h1>
<p>It takes a lot of work on your part to cache multiple plans for the same query. SQL Server 2017 adds a feature to make it easier, automatically, by watching out for situations where the amount of data coming out of one table might influence whether it should do an index seek or a scan on a specific table.</p>
<p>It’s important to understand what this ISN’T:</p>
<ul>
<li>It’s not a choice between an index seek + key lookup vs a table scan</li>
<li>It’s not a choice between which table to process first (or next)</li>
<li>It’s not a dynamic memory grant for the amount of rows that are moving through (and in fact, this operator has a new chance to spill to disk)</li>
<li>But as long as you understand what they ARE, then you can try to suggest initial parameters for a stored proc that will enhance its chance to get an adaptive join, and that’ll help you out with more dynamic plan choices. (Also, though, it’s a new chance to spill, and another reason to probably turn off memory grant feedback.)</li>
</ul>
<pre><code class="language-sql">RAISERROR(N<span class="hljs-string">&#x27;Oops! No, don&#x27;&#x27;t just hit F5. Run these demos one at a time.&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> LOG;
GO
USE StackOverflow;
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO

<span class="hljs-comment">/* Rename an obscure index to make it easier to understand the demo: */</span>
sp_rename N<span class="hljs-string">&#x27;dbo.Posts._dta_index_Posts_5_85575343__K14_K16_K7_K1_K2_17&#x27;</span>, 
  N<span class="hljs-string">&#x27;OwnerUserId_PostTypeId_CommunityOwnedDate_AcceptedAnswerId_Inc&#x27;</span>, N<span class="hljs-string">&#x27;index&#x27;</span>;
GO

<span class="hljs-comment">/* Let&#x27;s start with 2017: */</span>
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">140</span>;
GO

<span class="hljs-comment">/* And we&#x27;ll build a parameter-sensitive proc: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100000</span> 
      u.Id
    , p.Score
    , AcceptedAnswerId
  <span class="hljs-keyword">FROM</span> dbo.Users u
  <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> u.Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>;
GO

<span class="hljs-comment">/* And run it with a few different parameters to see if it has different plan choices: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span> <span class="hljs-keyword">WITH</span> RECOMPILE; 
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span> <span class="hljs-keyword">WITH</span> RECOMPILE; 
GO
</code></pre>
<p>The number of rows we find in Users will dramatically impact the next thing SQL Server decides to do.
Starting with SQL Server 2019, he understands that, and he has a new join type: */</p>
<pre><code class="language-sql"><span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">150</span>; <span class="hljs-comment">/* 2019 */</span>
GO
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO
</code></pre>
<p>Check out that adaptive join:
* Adaptive threshold in tooltip
* Over threshold: do an index scan
* Under: do a seek</p>
<p>Try another reputation, and it chooses the seek:</p>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
GO
</code></pre>
<p>THAT IS AWESOME! Good stuff:
* It's like caching two plans
* Even better, you get just one line in the plan cache with total metrics</p>
<p>Not-so-good stuff:
* Only works for SELECTS, not modifications
* Compat mode 140 or higher (can't hint for this in lower compat levels)
* Query has to be in batch mode (either 2017 w/a columnstore index, or 2019)
* It doesn't replace branching logic: it doesn't pick which table to process first or which index to use on a table</p>
<p>Really, really bad stuff - run it again:</p>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO
</code></pre>
<p>What's causing this?</p>
<p>ARGH, our arch-nemesis. I wish that feature would just be disabled on adaptive joins because after all, they're adaptive BECAUSE the amount of data keeps changing back and forth. They're going to constantly spill. If you know you're going to get adaptive joins on a plan, then this is probably a good idea:</p>
<pre><code class="language-sql"><span class="hljs-keyword">ALTER</span> DATABASE SCOPED CONFIGURATION <span class="hljs-keyword">SET</span> ROW_MODE_MEMORY_GRANT_FEEDBACK <span class="hljs-operator">=</span> OFF;
<span class="hljs-keyword">ALTER</span> DATABASE SCOPED CONFIGURATION <span class="hljs-keyword">SET</span> BATCH_MODE_MEMORY_GRANT_FEEDBACK <span class="hljs-operator">=</span> OFF;
GO

<span class="hljs-comment">/* Or hint it in the query: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100000</span> u.Id, p.Score, AcceptedAnswerId
        <span class="hljs-keyword">FROM</span> dbo.Users u
        <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
        <span class="hljs-keyword">WHERE</span> u.Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>
    OPTION (USE HINT(<span class="hljs-string">&#x27;DISABLE_BATCH_MODE_MEMORY_GRANT_FEEDBACK&#x27;</span>));
GO

<span class="hljs-comment">/* So now when you run it, you can get stable grants: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO

<span class="hljs-comment">/* There&#x27;s just one little problem: these are still vulnerable to sniffing.
Rebuild the indexes table to flush out the plan cache for this table: */</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> dbo.Users REBUILD;
GO

<span class="hljs-comment">/* And then run the query again, but for a different starting parameter: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">/* Aaaaaand no adaptive join. In fact, these 3 get 3 different plans now: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
GO

<span class="hljs-comment">/* If you want an adaptive join, you can&#x27;t hint it: you have to figure out which parameters are likely to get &#x27;em, and then hint those: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100000</span> u.Id, p.Score, AcceptedAnswerId
        <span class="hljs-keyword">FROM</span> dbo.Users u
        <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
        <span class="hljs-keyword">WHERE</span> u.Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>
    OPTION (USE HINT(<span class="hljs-string">&#x27;DISABLE_BATCH_MODE_MEMORY_GRANT_FEEDBACK&#x27;</span>),
        OPTIMIZE <span class="hljs-keyword">FOR</span>(<span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>));
GO

<span class="hljs-comment">/* So now even if reputation = 2 goes first, the adaptive join goes in cache: */</span>
<span class="hljs-keyword">EXEC</span> usp_TopScoringPostsByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
</code></pre>
<p>What to take away from this demo:</p>
<ul>
<li>Adaptive joins are a cool way to cache two plans for the same query.</li>
<li>They have a lot of restrictions, and they don't solve a lot of scenarios yet.</li>
<li>Memory grant feedback is their Achilles' heel: you probably don't want to use those two features together, at least not in the same query.</li>
<li>They only help with parameter sniffing if you can actually get them in the plan: but they're also VICTIMS of parameter sniffing in that many params won't actually trigger them. To get them, you need the first set of params to push a lot of data through.</li>
</ul>
<h1 id="automatic-tuning-aka-automatic-plan-regression">Automatic Tuning, aka Automatic Plan Regression</h1>
<p>Built atop 2016’s Query Store, 2017 added Automatic Tuning: the ability to monitor Query Store, watch for query plans that have gotten worse over time, and automatically force the better prior plans. The problem is that it only works well if there’s one plan that actually works well for enough of the possible parameters. That might theoretically help an extremely simple query or one with a truly outlier set of parameters – but it doesn’t help our simple 2-table, 3-parameter query.</p>
<p>(Note: the demo query below is brand new, newer than what I've got in the video. I'm setting that up for the May delivery of this class.)</p>
<pre><code class="language-sql">RAISERROR(N<span class="hljs-string">&#x27;Oops! No, don&#x27;&#x27;t just hit F5. Run these demos one at a time.&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> LOG;
GO

<span class="hljs-comment">/* Set the stage with the right server options &amp; database config: */</span>
USE StackOverflow;
GO

<span class="hljs-keyword">EXEC</span> DropIndexes <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>, <span class="hljs-variable">@ExceptIndexNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate_Score&#x27;</span>;
GO

IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.indexes <span class="hljs-keyword">WHERE</span> object_id <span class="hljs-operator">=</span> OBJECT_ID(<span class="hljs-string">&#x27;dbo.Posts&#x27;</span>) <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;CreationDate_Score&#x27;</span>)
  <span class="hljs-keyword">CREATE</span> INDEX CreationDate_Score <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate, Score);
GO

<span class="hljs-comment">-- Turn on Query Store with ridiculously frequent capture settings, BUT ONLY FOR DEMO PURPOSES. YOU SHOULD NEVER LOG EVERY MINUTE.</span>
<span class="hljs-keyword">ALTER</span> DATABASE [StackOverflow] <span class="hljs-keyword">SET</span> QUERY_STORE <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">ALTER</span> DATABASE [StackOverflow] <span class="hljs-keyword">SET</span> QUERY_STORE 
  (OPERATION_MODE <span class="hljs-operator">=</span> READ_WRITE, 
  DATA_FLUSH_INTERVAL_SECONDS <span class="hljs-operator">=</span> <span class="hljs-number">60</span>, 
  INTERVAL_LENGTH_MINUTES <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
GO

<span class="hljs-keyword">ALTER</span> DATABASE [StackOverflow] <span class="hljs-keyword">SET</span> QUERY_STORE CLEAR;
GO

<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span>
<span class="hljs-keyword">SET</span> AUTOMATIC_TUNING ( FORCE_LAST_GOOD_PLAN <span class="hljs-operator">=</span> OFF ); 
GO

<span class="hljs-comment">/* Create the SP */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsToAnswer 
  <span class="hljs-variable">@ScoreMin</span> <span class="hljs-type">INT</span>, 
  <span class="hljs-variable">@AnswerCountMin</span> <span class="hljs-type">INT</span>, 
  <span class="hljs-variable">@CommentCountMin</span> <span class="hljs-type">INT</span> 
<span class="hljs-keyword">AS</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span>   dbo.Posts
  <span class="hljs-keyword">WHERE</span>  Score <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@ScoreMin</span>
  <span class="hljs-keyword">AND</span>    AnswerCount <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@AnswerCountMin</span>
  <span class="hljs-keyword">AND</span>    CommentCount <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@CommentCountMin</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">DESC</span>;
GO

<span class="hljs-comment">/* These get different execution plans: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Single-threaded */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">250</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Single-threaded */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1000</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Parallel */</span>
GO

<span class="hljs-comment">-- So depending on which one goes in first, we have different parameter sniffing issues:</span>
sp_recompile <span class="hljs-string">&#x27;usp_SearchPostsToAnswer&#x27;</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">250</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1000</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span> <span class="hljs-comment">/* Used to be parallel */</span>
GO

sp_recompile <span class="hljs-string">&#x27;usp_SearchPostsToAnswer&#x27;</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">250</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1000</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>

sp_recompile <span class="hljs-string">&#x27;usp_SearchPostsToAnswer&#x27;</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1000</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span> <span class="hljs-comment">/* Parallel */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">250</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span> <span class="hljs-comment">/* Uh oh (doesn&#x27;t need to finish) */</span>
GO

<span class="hljs-comment">-- Automatic tuning is supposed to fix this:</span>
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span>
<span class="hljs-keyword">SET</span> AUTOMATIC_TUNING ( FORCE_LAST_GOOD_PLAN <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span> ); 
GO

<span class="hljs-comment">-- Start with the single-threaded small data plan so that we have a &quot;good&quot; plan in history: */</span>
sp_recompile <span class="hljs-string">&#x27;usp_SearchPostsToAnswer&#x27;</span>
GO
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
GO <span class="hljs-number">5</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">250</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>
GO <span class="hljs-number">5</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1000</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>
GO <span class="hljs-number">5</span>

<span class="hljs-comment">-- Rebuild an index, which also updates stats, which also frees the plan from cache:</span>
<span class="hljs-keyword">ALTER</span> INDEX CreationDate_Score <span class="hljs-keyword">ON</span> dbo.Posts REBUILD;
GO

<span class="hljs-comment">-- Now put the parallel plan in cache:</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1000</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>
GO <span class="hljs-number">5</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">250</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>
GO <span class="hljs-number">5</span>

<span class="hljs-comment">-- But unfortunately, this will take several minutes... or will it?</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsToAnswer <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
GO <span class="hljs-number">5</span>

<span class="hljs-comment">-- Go check out top resource consuming queries in the Query Store reports. */</span>

<span class="hljs-comment">/* See what automatic tuning is up to: */</span>
<span class="hljs-keyword">SELECT</span> reason, score,
      script <span class="hljs-operator">=</span> <span class="hljs-built_in">JSON_VALUE</span>(details, <span class="hljs-string">&#x27;$.implementationDetails.script&#x27;</span>),
      planForceDetails.<span class="hljs-operator">*</span>,
      estimated_gain <span class="hljs-operator">=</span> (regressedPlanExecutionCount <span class="hljs-operator">+</span> recommendedPlanExecutionCount)
                  <span class="hljs-operator">*</span> (regressedPlanCpuTimeAverage <span class="hljs-operator">-</span> recommendedPlanCpuTimeAverage)<span class="hljs-operator">/</span><span class="hljs-number">1000000</span>,
      error_prone <span class="hljs-operator">=</span> IIF(regressedPlanErrorCount <span class="hljs-operator">&gt;</span> recommendedPlanErrorCount, <span class="hljs-string">&#x27;YES&#x27;</span>,<span class="hljs-string">&#x27;NO&#x27;</span>)
<span class="hljs-keyword">FROM</span> sys.dm_db_tuning_recommendations
<span class="hljs-keyword">CROSS</span> APPLY OPENJSON (Details, <span class="hljs-string">&#x27;$.planForceDetails&#x27;</span>)
    <span class="hljs-keyword">WITH</span> (  [query_id] <span class="hljs-type">int</span> <span class="hljs-string">&#x27;$.queryId&#x27;</span>,
            regressedPlanId <span class="hljs-type">int</span> <span class="hljs-string">&#x27;$.regressedPlanId&#x27;</span>,
            recommendedPlanId <span class="hljs-type">int</span> <span class="hljs-string">&#x27;$.recommendedPlanId&#x27;</span>,
            regressedPlanErrorCount <span class="hljs-type">int</span>,
            recommendedPlanErrorCount <span class="hljs-type">int</span>,
            regressedPlanExecutionCount <span class="hljs-type">int</span>,
            regressedPlanCpuTimeAverage <span class="hljs-type">float</span>,
            recommendedPlanExecutionCount <span class="hljs-type">int</span>,
            recommendedPlanCpuTimeAverage <span class="hljs-type">float</span>
          ) <span class="hljs-keyword">AS</span> planForceDetails;
GO
</code></pre>
<p>What to take away from this demo:
Automatic Tuning aka Automatic Plan Forcing requires:</p>
<ul>
<li>Query Store turned on for the database</li>
<li>AUTOMATIC_TUNING ( FORCE_LAST_GOOD_PLAN = ON ) for the database</li>
<li>At least 2 different query plans in Query Store's captured history</li>
</ul>
<p>Then, when a query uses way more CPU:</p>
<ul>
<li>The query has to finish executing (this doesn't change mid-flight)</li>
<li>Query Store will try forcing one of the previous plans</li>
</ul>
<p>But Automatic Tuning doesn't work as well when:</p>
<ul>
<li>Anything changes about the query - because it'll have a new hash, and the previous plans won't be linked to it - which also means forced plans are time bombs for developers.</li>
<li>You only have one plan in the history</li>
<li>You've never run those outlier parameters before</li>
<li>When there isn't one plan that works well for all of the parameters (which is what we typically run into in this class)</li>
<li>You can't turn on Query Store</li>
</ul>
<h1 id="lab-4">LAB 4</h1>
<h2 id="dbousp_searchpostsbyposttype">[dbo].[usp_SearchPostsByPostType]</h2>
<pre><code class="language-sql">USE [StackOverflow]
GO
<span class="hljs-comment">/****** Object:  StoredProcedure [dbo].[usp_SearchPostsByPostType]    Script Date: 1/30/2025 2:14:51 PM ******/</span>
<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO


<span class="hljs-keyword">ALTER</span>   PROC [dbo].[usp_SearchPostsByPostType] 
  <span class="hljs-variable">@PostType</span> NVARCHAR(<span class="hljs-number">50</span>),
  <span class="hljs-variable">@StartDate</span> DATETIME, 
  <span class="hljs-variable">@EndDate</span> DATETIME,
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP (<span class="hljs-variable">@ResultsToShow</span>) p.CreationDate, p.Score, <span class="hljs-built_in">COALESCE</span>(p.Title, pParent.Title) <span class="hljs-keyword">AS</span> Title, u.DisplayName <span class="hljs-keyword">AS</span> OwnerDisplayName
  <span class="hljs-keyword">FROM</span> dbo.PostTypes pt
  <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> pt.Id <span class="hljs-operator">=</span> p.PostTypeId
  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pParent <span class="hljs-keyword">ON</span> p.ParentId <span class="hljs-operator">=</span> pParent.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> pt.Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostType</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&lt;=</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate;
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- Parameters</span>
DBCC FREEPROCCACHE

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;ModeratorNomination&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WITH</span> RECOMPILE;


<span class="hljs-comment">-- Changes on Proc [dbo].[usp_SearchPostsByPostType_Tune_0]</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchPostsByPostType_Tune_0] 
  <span class="hljs-variable">@PostType</span> NVARCHAR(<span class="hljs-number">50</span>),
  <span class="hljs-variable">@StartDate</span> DATETIME, 
  <span class="hljs-variable">@EndDate</span> DATETIME,
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExec</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;
  SELECT /* usp_SearchPostsByPostsType */ TOP (@ResultsToShow) p.CreationDate, p.Score, COALESCE(p.Title, pParent.Title) AS Title, u.DisplayName AS OwnerDisplayName
  FROM dbo.PostTypes pt
  INNER JOIN dbo.Posts p ON pt.Id = p.PostTypeId
  LEFT OUTER JOIN dbo.Posts pParent ON p.ParentId = pParent.Id
  INNER JOIN dbo.Users u ON p.OwnerUserId = u.Id
  WHERE pt.Type = @PostType
    AND p.CreationDate &gt;= @StartDate
    AND p.CreationDate &lt;= @EndDate
  ORDER BY p.CreationDate;&#x27;</span>

  IF DATEDIFF (dd, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">90</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; /* Big date range */ &#x27;</span>

  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExec</span>, N<span class="hljs-string">&#x27;@PostType NVARCHAR(50), @StartDate DATETIME, @EndDate DATETIME, @ResultsToShow INT&#x27;</span>,
  <span class="hljs-variable">@PostType</span>, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>, <span class="hljs-variable">@ResultsToShow</span>
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- Parameters</span>
DBCC FREEPROCCACHE

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_0] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;ModeratorNomination&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_0] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_0] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_0] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;


<span class="hljs-comment">-- Changes on Proc [dbo].[usp_SearchPostsByPostType_Tune_1]</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchPostsByPostType_Tune_1] 
  <span class="hljs-variable">@PostType</span> NVARCHAR(<span class="hljs-number">50</span>),
  <span class="hljs-variable">@StartDate</span> DATETIME, 
  <span class="hljs-variable">@EndDate</span> DATETIME,
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@PostTypeId</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> Id <span class="hljs-keyword">FROM</span> dbo.PostTypes <span class="hljs-keyword">WHERE</span> Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostType</span>);

  <span class="hljs-keyword">SELECT</span> TOP (<span class="hljs-variable">@ResultsToShow</span>) p.CreationDate, p.Score, <span class="hljs-built_in">COALESCE</span>(p.Title, pParent.Title) <span class="hljs-keyword">AS</span> Title, u.DisplayName <span class="hljs-keyword">AS</span> OwnerDisplayName
  <span class="hljs-keyword">FROM</span> dbo.Posts p 
  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pParent 
  <span class="hljs-keyword">ON</span> p.ParentId <span class="hljs-operator">=</span> pParent.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> p.PostTypeId <span class="hljs-operator">=</span> <span class="hljs-variable">@PostTypeId</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&lt;=</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate OPTION(RECOMPILE);
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- Parameters</span>
DBCC FREEPROCCACHE

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_1] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;ModeratorNomination&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_1] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_1] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_1] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;


<span class="hljs-comment">-- Changes on Proc [dbo].[usp_SearchPostsByPostType_Tune_2]</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchPostsByPostType_Tune_2] 
  <span class="hljs-variable">@PostType</span> NVARCHAR(<span class="hljs-number">50</span>),
  <span class="hljs-variable">@StartDate</span> DATETIME, 
  <span class="hljs-variable">@EndDate</span> DATETIME,
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@PostTypeId</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> Id <span class="hljs-keyword">FROM</span> dbo.PostTypes <span class="hljs-keyword">WHERE</span> Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostType</span>);

  <span class="hljs-keyword">SELECT</span> TOP (<span class="hljs-variable">@ResultsToShow</span>) p.CreationDate, p.Score, <span class="hljs-built_in">COALESCE</span>(p.Title, pParent.Title) <span class="hljs-keyword">AS</span> Title, u.DisplayName <span class="hljs-keyword">AS</span> OwnerDisplayName
  <span class="hljs-keyword">FROM</span> dbo.Posts p 
  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pParent 
  <span class="hljs-keyword">ON</span> p.ParentId <span class="hljs-operator">=</span> pParent.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> p.PostTypeId <span class="hljs-operator">=</span> <span class="hljs-variable">@PostTypeId</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&lt;=</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate OPTION(RECOMPILE);
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- Parameters</span>
DBCC FREEPROCCACHE

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_2] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;ModeratorNomination&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_2] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_2] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_2] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;


<span class="hljs-comment">-- Changes on Proc [dbo].[usp_SearchPostsByPostType_Tune_3]</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchPostsByPostType_Tune_3] 
  <span class="hljs-variable">@PostType</span> NVARCHAR(<span class="hljs-number">50</span>),
  <span class="hljs-variable">@StartDate</span> DATETIME, 
  <span class="hljs-variable">@EndDate</span> DATETIME,
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@PostTypeId</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> Id <span class="hljs-keyword">FROM</span> dbo.PostTypes <span class="hljs-keyword">WHERE</span> Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostType</span>);

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExec</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;
  SELECT TOP (@ResultsToShow) p.CreationDate, p.Score, COALESCE(p.Title, pParent.Title) AS Title, u.DisplayName AS OwnerDisplayName
  FROM dbo.Posts p 
  LEFT OUTER JOIN dbo.Posts pParent 
  ON p.ParentId = pParent.Id
  JOIN dbo.Users u ON p.OwnerUserId = u.Id
  WHERE p.PostTypeId = @PostTypeId
    AND p.CreationDate &gt;= @StartDate
    AND p.CreationDate &lt;= @EndDate
  ORDER BY p.CreationDate;&#x27;</span>
  
  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExec</span>, N<span class="hljs-string">&#x27;@PostType NVARCHAR(50), @StartDate DATETIME, @EndDate DATETIME, @ResultsToShow INT&#x27;</span>,
  <span class="hljs-variable">@PostTypeId</span>, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>, <span class="hljs-variable">@ResultsToShow</span>
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- Parameters</span>
DBCC FREEPROCCACHE

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_3] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;ModeratorNomination&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_3] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_3] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_3] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;


<span class="hljs-comment">-- Changes on Proc [dbo].[usp_SearchPostsByPostType_Tune_4]</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchPostsByPostType_Tune_4] 
  <span class="hljs-variable">@PostType</span> NVARCHAR(<span class="hljs-number">50</span>),
  <span class="hljs-variable">@StartDate</span> DATETIME, 
  <span class="hljs-variable">@EndDate</span> DATETIME,
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@PostTypeId</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> Id <span class="hljs-keyword">FROM</span> dbo.PostTypes <span class="hljs-keyword">WHERE</span> Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostType</span>);

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExec</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;
  SELECT /* usp_SearchPostsByPostType for PostTypeId &#x27;</span> 
    <span class="hljs-operator">+</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-variable">@postTypeId</span> <span class="hljs-keyword">AS</span> NVARCHAR(<span class="hljs-number">50</span>)) <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; */ 
  TOP (@ResultsToShow) p.CreationDate, p.Score, COALESCE(p.Title, pParent.Title) AS Title, u.DisplayName AS OwnerDisplayName
  FROM dbo.Posts p 
  LEFT OUTER JOIN dbo.Posts pParent 
  ON p.ParentId = pParent.Id
  JOIN dbo.Users u ON p.OwnerUserId = u.Id
  WHERE p.PostTypeId = @PostTypeId
    AND p.CreationDate &gt;= @StartDate
    AND p.CreationDate &lt;= @EndDate
  ORDER BY p.CreationDate;&#x27;</span>
  
  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExec</span>, N<span class="hljs-string">&#x27;@PostType NVARCHAR(50), @StartDate DATETIME, @EndDate DATETIME, @ResultsToShow INT&#x27;</span>,
  <span class="hljs-variable">@PostType</span>, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>, <span class="hljs-variable">@ResultsToShow</span>
<span class="hljs-keyword">END</span>


<span class="hljs-comment">-- Parameters</span>
DBCC FREEPROCCACHE

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_4] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;ModeratorNomination&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_4] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_4] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;PrivilegeWiki&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_4] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;



<span class="hljs-comment">-- Changes on Proc [dbo].[usp_SearchPostsByPostType_Tune_5]</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchPostsByPostType_Tune_5] 
  <span class="hljs-variable">@PostType</span> NVARCHAR(<span class="hljs-number">50</span>),
  <span class="hljs-variable">@StartDate</span> DATETIME, 
  <span class="hljs-variable">@EndDate</span> DATETIME,
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@PostTypeId</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> Id <span class="hljs-keyword">FROM</span> dbo.PostTypes <span class="hljs-keyword">WHERE</span> Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostType</span>);

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExec</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;
  SELECT /* usp_SearchPostsByPostType for PostTypeId &#x27;</span> 
    <span class="hljs-operator">+</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-variable">@postTypeId</span> <span class="hljs-keyword">AS</span> NVARCHAR(<span class="hljs-number">50</span>)) <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; &#x27;</span>
    <span class="hljs-operator">+</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> DATEDIFF(dd, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">90</span> <span class="hljs-keyword">THEN</span> N<span class="hljs-string">&#x27; for big date range&#x27;</span>
      <span class="hljs-keyword">ELSE</span> N<span class="hljs-string">&#x27; for small date range &#x27;</span>
      <span class="hljs-keyword">END</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; */ 
  TOP (@ResultsToShow) p.CreationDate, p.Score, COALESCE(p.Title, pParent.Title) AS Title, u.DisplayName AS OwnerDisplayName
  FROM dbo.Posts p 
  LEFT OUTER JOIN dbo.Posts pParent 
  ON p.ParentId = pParent.Id
  JOIN dbo.Users u ON p.OwnerUserId = u.Id
  WHERE p.PostTypeId = @PostTypeId
    AND p.CreationDate &gt;= @StartDate
    AND p.CreationDate &lt;= @EndDate
  ORDER BY p.CreationDate;&#x27;</span>
  
  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExec</span>, N<span class="hljs-string">&#x27;@PostType NVARCHAR(50), @StartDate DATETIME, @EndDate DATETIME, @ResultsToShow INT&#x27;</span>,
  <span class="hljs-variable">@PostType</span>, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>, <span class="hljs-variable">@ResultsToShow</span>
<span class="hljs-keyword">END</span>


<span class="hljs-comment">-- Parameters</span>
DBCC FREEPROCCACHE

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_5] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;ModeratorNomination&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_5] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_5] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;PrivilegeWiki&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_5] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;


<span class="hljs-comment">-- Changes on Proc [dbo].[usp_SearchPostsByPostType_Tune_6]</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchPostsByPostType_Tune_6]
  <span class="hljs-variable">@PostType</span> NVARCHAR(<span class="hljs-number">50</span>),
  <span class="hljs-variable">@StartDate</span> DATETIME, 
  <span class="hljs-variable">@EndDate</span> DATETIME,
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@PostTypeId</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> Id <span class="hljs-keyword">FROM</span> dbo.PostTypes <span class="hljs-keyword">WHERE</span> Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostType</span>);

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExec</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;
  SELECT /* usp_SearchPostsByPostType_Tune_6 &#x27;</span> 
    <span class="hljs-operator">+</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-variable">@PostType</span> <span class="hljs-keyword">IN</span> (N<span class="hljs-string">&#x27;Question&#x27;</span>, N<span class="hljs-string">&#x27;Answer&#x27;</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27; for big PostType &#x27;</span>
      <span class="hljs-keyword">ELSE</span> N<span class="hljs-string">&#x27; for small PostType &#x27;</span> <span class="hljs-keyword">END</span>
    <span class="hljs-operator">+</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> DATEDIFF(dd, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">90</span> <span class="hljs-keyword">THEN</span> N<span class="hljs-string">&#x27; for big date range&#x27;</span>
      <span class="hljs-keyword">ELSE</span> N<span class="hljs-string">&#x27; for small date range &#x27;</span>
      <span class="hljs-keyword">END</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; */ 
  TOP (@ResultsToShow) p.CreationDate, p.Score, COALESCE(p.Title, pParent.Title) AS Title, u.DisplayName AS OwnerDisplayName
  FROM dbo.Posts p 
  LEFT OUTER JOIN dbo.Posts pParent 
  ON p.ParentId = pParent.Id
  JOIN dbo.Users u ON p.OwnerUserId = u.Id
  WHERE p.PostTypeId = @PostTypeId
    AND p.CreationDate &gt;= @StartDate
    AND p.CreationDate &lt;= @EndDate
  ORDER BY p.CreationDate;&#x27;</span>
  
  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExec</span>, N<span class="hljs-string">&#x27;@PostType NVARCHAR(50), @StartDate DATETIME, @EndDate DATETIME, @ResultsToShow INT&#x27;</span>,
  <span class="hljs-variable">@PostType</span>, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>, <span class="hljs-variable">@ResultsToShow</span>
<span class="hljs-keyword">END</span>


<span class="hljs-comment">-- Parameters</span>
DBCC FREEPROCCACHE

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_6] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;ModeratorNomination&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_6] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-30 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_6] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;PrivilegeWiki&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByPostType_Tune_6] 
  <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2013-12-31 00:00:00&#x27;</span>, 
  <span class="hljs-variable">@PostType</span>  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>, 
  <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;


<span class="hljs-comment">-- Analysis</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.PostTypes <span class="hljs-comment">-- 8 Types Answer, ModeratorNomination, PrivilegeWiki, Question, TagWiki, TagWikiExerpt, Wiki, WikiPlaceholder</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> dbo.PostTypes

<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> Posts <span class="hljs-comment">-- 40.700.647</span>
<span class="hljs-keyword">SELECT</span> Type, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> Posts P
<span class="hljs-keyword">JOIN</span> PostTypes PT <span class="hljs-keyword">ON</span> P.PostTypeId <span class="hljs-operator">=</span> PT.Id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> Type
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">DESC</span>

Answer				<span class="hljs-number">24.676</span><span class="hljs-number">.333</span>
Question			<span class="hljs-number">15.930</span><span class="hljs-number">.617</span>
TagWiki				<span class="hljs-number">46.606</span>
TagWikiExerpt		<span class="hljs-number">46.606</span>
ModeratorNomination	<span class="hljs-number">312</span>
Wiki				<span class="hljs-number">167</span>
WikiPlaceholder		<span class="hljs-number">4</span>
PrivilegeWiki		<span class="hljs-number">2</span>
</code></pre>
<h2 id="dbousp_rptusersleaderboard">[dbo].[usp_RptUsersLeaderboard]</h2>
<pre><code class="language-sql"><span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

sp_recompile <span class="hljs-string">&#x27;usp_RptUsersLeaderboard&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptUsersLeaderboard] <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;San Diego, CA, USA&#x27;</span> <span class="hljs-comment">/* 143882 */</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptUsersLeaderboard] <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;India&#x27;</span> <span class="hljs-comment">/* 143882 */</span>

sp_recompile <span class="hljs-string">&#x27;usp_RptUsersLeaderboard&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptUsersLeaderboard] <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;India&#x27;</span> <span class="hljs-comment">/* 33250 */</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptUsersLeaderboard] <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;San Diego, CA, USA&#x27;</span> <span class="hljs-comment">/* 7.122.630 */</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptUsersLeaderboard] <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;India&#x27;</span> <span class="hljs-comment">/* 394 */</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptUsersLeaderboard] <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;San Diego, CA, USA&#x27;</span> <span class="hljs-comment">/* 8828 */</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptUsersLeaderboard] <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;San Diego, CA, USA&#x27;</span> <span class="hljs-comment">/* 8828 */</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptUsersLeaderboard] <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;India&#x27;</span> <span class="hljs-comment">/* 394 */</span>


<span class="hljs-comment">/* Update the Index */</span>
<span class="hljs-keyword">CREATE</span> INDEX [IX_Reputation_Includes]
  <span class="hljs-keyword">ON</span> [StackOverflow].[dbo].[Users] ([Reputation])
  INCLUDE ([Views], [Location])
  <span class="hljs-keyword">WITH</span>(DROP_EXISTING <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>)
</code></pre>
<h2 id="dbousp_gettagsforuser">[dbo].[usp_GetTagsForUser]</h2>
<pre><code class="language-sql">sp_recompile <span class="hljs-string">&#x27;usp_GetTagsForUser&#x27;</span>
<span class="hljs-comment">-- &#x27;Brent&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_GetTagsForUser] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">26837</span> <span class="hljs-keyword">WITH</span> RECOMPILE
  <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">0</span>, logical <span class="hljs-keyword">reads</span>		    <span class="hljs-number">3</span>, physical <span class="hljs-keyword">reads</span> <span class="hljs-number">0</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span>		 <span class="hljs-number">0</span>
  <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>. Scan count <span class="hljs-number">5</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">11.220</span><span class="hljs-number">.985</span>, physical <span class="hljs-keyword">reads</span> <span class="hljs-number">5</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span> <span class="hljs-number">10495119</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_GetTagsForUser] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">22656</span> <span class="hljs-keyword">WITH</span> RECOMPILE <span class="hljs-comment">-- &#x27;Jon&#x27;</span>
  <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">0</span>, logical <span class="hljs-keyword">reads</span>		  <span class="hljs-number">3</span>, physical <span class="hljs-keyword">reads</span>   <span class="hljs-number">1</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span>        <span class="hljs-number">0</span>
  <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>. Scan count <span class="hljs-number">5</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">11382968</span>, physical <span class="hljs-keyword">reads</span> <span class="hljs-number">102</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span> <span class="hljs-number">11178463</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_GetTagsForUser] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">-100</span> <span class="hljs-keyword">WITH</span> RECOMPILE <span class="hljs-comment">-- &#x27;not valid&#x27;</span>
  <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">0</span>, logical <span class="hljs-keyword">reads</span>        <span class="hljs-number">3</span>, physical <span class="hljs-keyword">reads</span>   <span class="hljs-number">1</span>, read<span class="hljs-operator">-</span>ahead <span class="hljs-keyword">reads</span>		 <span class="hljs-number">0</span>

<span class="hljs-comment">-- </span>
USE [StackOverflow]
GO
<span class="hljs-keyword">CREATE</span> NONCLUSTERED INDEX [<span class="hljs-operator">&lt;</span>Name <span class="hljs-keyword">of</span> Missing Index, sysname,<span class="hljs-operator">&gt;</span>]
<span class="hljs-keyword">ON</span> [dbo].[Posts] ([OwnerUserId])
INCLUDE ([ParentId],[Score],[Tags])
GO 
</code></pre>
<h2 id="dbousp_rptquestionsansweredforuse">[dbo].[usp_RptQuestionsAnsweredForUse]</h2>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> [dbo].[usp_RptQuestionsAnsweredForUser] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">22656</span>   <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptQuestionsAnsweredForUser] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">8863714</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

sp_recompile <span class="hljs-string">&#x27;usp_RptQuestionsAnsweredForUser&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptQuestionsAnsweredForUser] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">22656</span>  
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptQuestionsAnsweredForUser] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">8863714</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptQuestionsAnsweredForUser] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptQuestionsAnsweredForUser] <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">-10000</span>
</code></pre>
<p>Nothing changed this sp is working fine</p>
<h2 id="dbousp_rptavganswertimebytag">[dbo].[usp_RptAvgAnswerTimeByTag]</h2>
<pre><code class="language-sql">USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptAvgAnswerTimeByTag]
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@Tag</span> NVARCHAR(<span class="hljs-number">50</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-comment">/* Changelog:
    2020/05/29 James Randell - fixing bugs left over from Bilbo
    2020/05/28 Bilbo Baggins - find out when fast answers are coming in
  */</span>

  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> 
    <span class="hljs-keyword">YEAR</span>(QuestionDate) <span class="hljs-keyword">AS</span> QuestionYear,
    <span class="hljs-keyword">MONTH</span>(QuestionDate) <span class="hljs-keyword">AS</span> QuestionMonth,
    <span class="hljs-built_in">AVG</span>(ResponseTimeSeconds <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span>) <span class="hljs-keyword">AS</span> AverageResponseTimeSeconds
  <span class="hljs-keyword">FROM</span> dbo.AverageAnswerResponseTime r
  <span class="hljs-keyword">WHERE</span> r.QuestionDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
  <span class="hljs-keyword">AND</span>   r.QuestionDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   r.Tags <span class="hljs-operator">=</span> <span class="hljs-variable">@Tag</span>
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">YEAR</span>(QuestionDate), <span class="hljs-keyword">MONTH</span>(QuestionDate)
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">YEAR</span>(QuestionDate), <span class="hljs-keyword">MONTH</span>(QuestionDate);

<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- Create new index</span>
<span class="hljs-keyword">EXEC</span> master..sp_BlitzIndex
  <span class="hljs-variable">@DatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;StackOverflow&#x27;</span>,
  <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>

<span class="hljs-keyword">CREATE</span> INDEX PostTypeId_Tags_CreationDate
  <span class="hljs-keyword">ON</span> dbo.Posts(PostTypeId, Tags, CreationDate)
  INCLUDE (Id, AcceptedAnswerId)

<span class="hljs-comment">-- EXEC</span>
sp_recompile <span class="hljs-string">&#x27;usp_RptAvgAnswerTimeByTag&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptAvgAnswerTimeByTag] <span class="hljs-variable">@EndDate</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-10-25 00:00:00&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-10-24 00:00:00&#x27;</span>, <span class="hljs-variable">@Tag</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptAvgAnswerTimeByTag] <span class="hljs-variable">@EndDate</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-10-25 00:00:00&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-10-24 00:00:00&#x27;</span>, <span class="hljs-variable">@Tag</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptAvgAnswerTimeByTag] <span class="hljs-variable">@EndDate</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-10-25 00:00:00&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-10-24 00:00:00&#x27;</span>, <span class="hljs-variable">@Tag</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Brent&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptAvgAnswerTimeByTag] <span class="hljs-variable">@EndDate</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-10-25 00:00:00&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-10-24 00:00:00&#x27;</span>, <span class="hljs-variable">@Tag</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;androi&gt;&#x27;</span>

</code></pre>
<h2 id="dbousp_dashboardfromtopusers">[dbo].[usp_DashboardFromTopUsers]</h2>
<pre><code class="language-SQL">USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span>  PROC [dbo].[usp_DashboardFromTopUsers] <span class="hljs-variable">@AsOf</span> DATETIME <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2018-06-03&#x27;</span> 
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* 
    Changelog:
    2020/05/28 DamnTank - last 10 posts by the top 10 posters
  */</span>
  <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> #RecentlyActiveUsers (
      Id <span class="hljs-type">INT</span>
    , DisplayName NVARCHAR(<span class="hljs-number">40</span>)
    , Location NVARCHAR(<span class="hljs-number">100</span>));

  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> #RecentlyActiveUsers
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> u.Id, u.DisplayName, u.Location
    <span class="hljs-keyword">FROM</span> dbo.Users u
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> 
            <span class="hljs-keyword">FROM</span> dbo.Posts 
            <span class="hljs-keyword">WHERE</span> OwnerUserId <span class="hljs-operator">=</span> u.Id
              <span class="hljs-keyword">AND</span> CreationDate <span class="hljs-operator">&gt;=</span> DATEADD(<span class="hljs-keyword">DAY</span>, <span class="hljs-number">-7</span>, <span class="hljs-variable">@AsOf</span>))
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> u.Reputation <span class="hljs-keyword">DESC</span>;

  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> u.DisplayName, u.Location, pAnswer.Body, pAnswer.Score, pAnswer.CreationDate
    <span class="hljs-keyword">FROM</span> #RecentlyActiveUsers u
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pAnswer <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> pAnswer.OwnerUserId
    <span class="hljs-keyword">WHERE</span> pAnswer.CreationDate <span class="hljs-operator">&gt;=</span> DATEADD(<span class="hljs-keyword">DAY</span>, <span class="hljs-number">-7</span>, <span class="hljs-variable">@AsOf</span>) 
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pAnswer.CreationDate <span class="hljs-keyword">DESC</span>;

<span class="hljs-keyword">END</span>


<span class="hljs-comment">/* Analisys */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> u.Id, u.DisplayName, u.Location
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> 
        <span class="hljs-keyword">FROM</span> dbo.Posts 
        <span class="hljs-keyword">WHERE</span> OwnerUserId <span class="hljs-operator">=</span> u.Id
          <span class="hljs-keyword">AND</span> CreationDate <span class="hljs-operator">&gt;=</span> DATEADD(<span class="hljs-keyword">DAY</span>, <span class="hljs-number">-7</span>, <span class="hljs-string">&#x27;2020-01-01&#x27;</span>))
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> u.Reputation <span class="hljs-keyword">DESC</span>;

<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> u.Id, u.DisplayName, u.Location
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> 
        <span class="hljs-keyword">FROM</span> dbo.Posts 
        <span class="hljs-keyword">WHERE</span> OwnerUserId <span class="hljs-operator">=</span> u.Id
          <span class="hljs-keyword">AND</span> CreationDate <span class="hljs-operator">&gt;=</span> DATEADD(<span class="hljs-keyword">DAY</span>, <span class="hljs-number">-7</span>, <span class="hljs-string">&#x27;2015-01-01&#x27;</span>))
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> u.Reputation <span class="hljs-keyword">DESC</span>;

<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> u.Id, u.DisplayName, u.Location
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> 
        <span class="hljs-keyword">FROM</span> dbo.Posts 
        <span class="hljs-keyword">WHERE</span> OwnerUserId <span class="hljs-operator">=</span> u.Id
          <span class="hljs-keyword">AND</span> CreationDate <span class="hljs-operator">&gt;=</span> DATEADD(<span class="hljs-keyword">DAY</span>, <span class="hljs-number">-7</span>, <span class="hljs-string">&#x27;2010-01-01&#x27;</span>))
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> u.Reputation <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Exec Proc</span>
sp_recompile <span class="hljs-string">&#x27;usp_DashboardFromTopUsers&#x27;</span>
[dbo].[usp_DashboardFromTopUsers] <span class="hljs-variable">@AsOf</span>  <span class="hljs-operator">=</span>  <span class="hljs-string">&#x27;2020-01-01&#x27;</span>
[dbo].[usp_DashboardFromTopUsers] <span class="hljs-variable">@AsOf</span>  <span class="hljs-operator">=</span>  <span class="hljs-string">&#x27;2015-01-01&#x27;</span>
[dbo].[usp_DashboardFromTopUsers] <span class="hljs-variable">@AsOf</span>  <span class="hljs-operator">=</span>  <span class="hljs-string">&#x27;2010-01-01&#x27;</span>


<span class="hljs-keyword">EXEC</span> master..sp_BlitzIndex
  <span class="hljs-variable">@DatabaseNAme</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Stackoverflow&#x27;</span>
  , <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>

<span class="hljs-keyword">CREATE</span> INDEX [IX_OwnerUserId]
  <span class="hljs-keyword">ON</span> dbo.Posts(OwnerUserId, CreationDate)
  <span class="hljs-keyword">WITH</span>(ONLINE <span class="hljs-operator">=</span> OFF, DROP_EXISTING <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>, MAXDOP <span class="hljs-operator">=</span> <span class="hljs-number">0</span>)


<span class="hljs-comment">-- Tune 1</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span>  PROC [dbo].[usp_DashboardFromTopUsers_Tune_0] <span class="hljs-variable">@AsOf</span> DATETIME <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2018-06-03&#x27;</span> 
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* 
    Changelog:
    2020/05/28 DamnTank - last 10 posts by the top 10 posters
  */</span>
  <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> #RecentlyActiveUsers (
      Id <span class="hljs-type">INT</span>
    , DisplayName NVARCHAR(<span class="hljs-number">40</span>)
    , Location NVARCHAR(<span class="hljs-number">100</span>));

  IF <span class="hljs-keyword">EXISTS</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> dbo.Posts <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">&gt;=</span> DATEADD(<span class="hljs-keyword">DAY</span>, <span class="hljs-number">-7</span>, <span class="hljs-variable">@AsOf</span>))
  <span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> #RecentlyActiveUsers
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> u.Id, u.DisplayName, u.Location
      <span class="hljs-keyword">FROM</span> dbo.Users u
      <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> 
              <span class="hljs-keyword">FROM</span> dbo.Posts 
              <span class="hljs-keyword">WHERE</span> OwnerUserId <span class="hljs-operator">=</span> u.Id
                <span class="hljs-keyword">AND</span> CreationDate <span class="hljs-operator">&gt;=</span> DATEADD(<span class="hljs-keyword">DAY</span>, <span class="hljs-number">-7</span>, <span class="hljs-variable">@AsOf</span>))
      <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> u.Reputation <span class="hljs-keyword">DESC</span>;
  <span class="hljs-keyword">END</span>

  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> u.DisplayName, u.Location, pAnswer.Body, pAnswer.Score, pAnswer.CreationDate
    <span class="hljs-keyword">FROM</span> #RecentlyActiveUsers u
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pAnswer <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> pAnswer.OwnerUserId
    <span class="hljs-keyword">WHERE</span> pAnswer.CreationDate <span class="hljs-operator">&gt;=</span> DATEADD(<span class="hljs-keyword">DAY</span>, <span class="hljs-number">-7</span>, <span class="hljs-variable">@AsOf</span>) 
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pAnswer.CreationDate <span class="hljs-keyword">DESC</span>;

<span class="hljs-keyword">END</span>
</code></pre>
<h2 id="dbousp_rptpostleaderboard">[dbo].[usp_RptPostLeaderboard]</h2>
<pre><code class="language-sql">USE [StackOverflow]
GO
<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptPostLeaderboard] 
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@PostTypeName</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>)  <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-comment">/* Changelog:
    2020/05/29 Jonathan9375 - make it work for multiple PostTypes
    2020/05/28 AbusedSysadmin - New social media project to display viral questions.
  */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">250</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> dbo.PostTypes pt 
  <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> pt.Id <span class="hljs-operator">=</span> p.PostTypeId
  <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
  <span class="hljs-keyword">AND</span>   p.CreationDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   pt.Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostTypeName</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> AnswerCount <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>



<span class="hljs-comment">-- EXEC PROC</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptPostLeaderboard] <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-17 00:00:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-18 00:00:00&#x27;</span>, <span class="hljs-variable">@PostTypeName</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptPostLeaderboard] <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-17 00:00:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-18 00:00:00&#x27;</span>, <span class="hljs-variable">@PostTypeName</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Question&#x27;</span>


USE [StackOverflow]
GO
<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptPostLeaderboard_Tune_1] 
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@PostTypeName</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>)  <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-comment">/* Changelog:
    2020/05/29 Jonathan9375 - make it work for multiple PostTypes
    2020/05/28 AbusedSysadmin - New social media project to display viral questions.
  */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">250</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> dbo.PostTypes pt 
  <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> pt.Id <span class="hljs-operator">=</span> p.PostTypeId
  <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
  <span class="hljs-keyword">AND</span>   p.CreationDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   pt.Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostTypeName</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> AnswerCount <span class="hljs-keyword">DESC</span>
  OPTION (USE HINT (<span class="hljs-string">&#x27;ENABLE_PARALLEL_PLAN_PREFERENCE&#x27;</span>), MAXDOP <span class="hljs-number">4</span>);
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- EXEC PROC</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptPostLeaderboard_Tune_1] <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-17 00:00:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-18 00:00:00&#x27;</span>, <span class="hljs-variable">@PostTypeName</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptPostLeaderboard_Tune_1] <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-17 00:00:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-18 00:00:00&#x27;</span>, <span class="hljs-variable">@PostTypeName</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Question&#x27;</span>



USE [StackOverflow]
GO
<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptPostLeaderboard_Tune_2] 
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@PostTypeName</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>)  <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-comment">/* Changelog:
    2020/05/29 Jonathan9375 - make it work for multiple PostTypes
    2020/05/28 AbusedSysadmin - New social media project to display viral questions.
  */</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@PostTypeId</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> Id <span class="hljs-keyword">FROM</span> dbo.PostTypes <span class="hljs-keyword">WHERE</span> Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostTypeName</span>)

  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">250</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> dbo.PostTypes pt 
  <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> pt.Id <span class="hljs-operator">=</span> p.PostTypeId
  <span class="hljs-keyword">WHERE</span> p.CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
  <span class="hljs-keyword">AND</span>   p.CreationDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-comment">-- AND   pt.Type = @PostTypeName</span>
  <span class="hljs-keyword">AND</span> pt.Id <span class="hljs-operator">=</span> <span class="hljs-variable">@PostTypeId</span> 
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> AnswerCount <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- EXEC PROC</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptPostLeaderboard_Tune_2] <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-17 00:00:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-18 00:00:00&#x27;</span>, <span class="hljs-variable">@PostTypeName</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptPostLeaderboard_Tune_2] <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-17 00:00:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-07-18 00:00:00&#x27;</span>, <span class="hljs-variable">@PostTypeName</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Question&#x27;</span>
</code></pre>
<h2 id="dbousp_searchpostsbylocation">[dbo].[usp_SearchPostsByLocation]</h2>
<pre><code class="language-sql">USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchPostsByLocation] 
  <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME 

<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Find the most recent posts from an area */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    u.DisplayName, p.Title, p.Id, p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span>   p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> 
      u.Location     <span class="hljs-keyword">LIKE</span>    <span class="hljs-variable">@Location</span>
  <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- --------------------------------------------------------------------------------</span>
<span class="hljs-comment">-- --------------------------------------------------------------------------------</span>

<span class="hljs-comment">-- Find outlier</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> 
  Location
  , <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> recs
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> Location
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- EXEC with outliers</span>
<span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>
sp_recompile <span class="hljs-string">&#x27;usp_SearchPostsByLocation&#x27;</span>

<span class="hljs-comment">-- Big Data</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByLocation] 
    <span class="hljs-variable">@Location</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Willemstad, Curacao&#x27;</span>
  , <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00.000&#x27;</span> 
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01 00:00:00.000&#x27;</span>

<span class="hljs-comment">-- Big Data</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByLocation] 
    <span class="hljs-variable">@Location</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;India&#x27;</span>
  , <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00.000&#x27;</span> 
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01 00:00:00.000&#x27;</span>

<span class="hljs-comment">-- Small Data</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByLocation] 
    <span class="hljs-variable">@Location</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Filadelfia, Paraguay&#x27;</span>
  , <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00.000&#x27;</span> 
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01 00:00:00.000&#x27;</span>



<span class="hljs-comment">-- Analysis</span>
If India goes <span class="hljs-keyword">first</span> everything explote
If Willemstad <span class="hljs-keyword">or</span> FIladelfia goes <span class="hljs-keyword">first</span> everything <span class="hljs-keyword">is</span> fine. So we will try <span class="hljs-keyword">to</span> tune the Willemstad <span class="hljs-keyword">and</span> try <span class="hljs-keyword">to</span> aply that EP
<span class="hljs-keyword">to</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">of</span> them

DBCC FREEPROCCACHE
<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByLocation] 
    <span class="hljs-variable">@Location</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Willemstad, Curacao&#x27;</span>
  , <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00.000&#x27;</span> 
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01 00:00:00.000&#x27;</span>

<span class="hljs-comment">-- Big Data</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByLocation] 
    <span class="hljs-variable">@Location</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;India&#x27;</span>
  , <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00.000&#x27;</span> 
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01 00:00:00.000&#x27;</span>


<span class="hljs-keyword">EXEC</span> master..sp_BlitzIndex
  <span class="hljs-variable">@DatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;StackoverFlow&#x27;</span>
  , <span class="hljs-variable">@TableName</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Users&#x27;</span>

<span class="hljs-keyword">EXEC</span> master..sp_BlitzIndex
  <span class="hljs-variable">@DatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;StackoverFlow&#x27;</span>
  , <span class="hljs-variable">@TableName</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>

<span class="hljs-keyword">CREATE</span> INDEX Location_DisplayName <span class="hljs-keyword">ON</span> dbo.Users(Location, DisplayName)
<span class="hljs-keyword">DROP</span> INDEX dbo.Users.IX_LastAccessDate
<span class="hljs-keyword">DROP</span> INDEX dbo.Users.[<span class="hljs-operator">&lt;</span>Name <span class="hljs-keyword">of</span> Missing Index, sysname,<span class="hljs-operator">&gt;</span>]
<span class="hljs-keyword">DROP</span> INDEX dbo.Users.Location_DisplayName  

<span class="hljs-keyword">CREATE</span> INDEX [_dta_index_Posts_5_85575343__K14_K16_K1_K2 (<span class="hljs-number">10</span>)]
<span class="hljs-keyword">ON</span> dbo.Posts (OwnerUserId, PostTypeId, Id, AcceptedAnswerId)
INCLUDE(CreationDate)
<span class="hljs-keyword">WITH</span>(DROP_EXISTING <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>)


<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchPostsByLocation_Tune_0]
  <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME 

<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> #RowsIWant(DisplayName NVARCHAR(<span class="hljs-number">40</span>), PostId <span class="hljs-type">INT</span>, CreationDate DATETIME)
  
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> #RowsIWant(DisplayName, PostId, CreationDate)
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    u.DisplayName, p.Id, p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span>   p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> 
      u.Location     <span class="hljs-keyword">LIKE</span>    <span class="hljs-variable">@Location</span>
  <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>;


  <span class="hljs-comment">/* Find the most recent posts from an area */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    r.DisplayName, p.Title, r.PostId, r.CreationDate
  <span class="hljs-keyword">FROM</span> #RowsIWant r
  <span class="hljs-keyword">JOIN</span> dbo.Posts p
  <span class="hljs-keyword">ON</span>   r.PostId <span class="hljs-operator">=</span> p.Id
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.CreationDate <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>

DBCC FREEPROCCACHE
<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByLocation_Tune_0] 
    <span class="hljs-variable">@Location</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Willemstad, Curacao&#x27;</span>
  , <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00.000&#x27;</span> 
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01 00:00:00.000&#x27;</span>

<span class="hljs-comment">-- Big Data</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByLocation_Tune_0] 
    <span class="hljs-variable">@Location</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;India&#x27;</span>
  , <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00.000&#x27;</span> 
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01 00:00:00.000&#x27;</span>


<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchPostsByLocation_Tune_1]
  <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME 

<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> #RowsIWant(DisplayName NVARCHAR(<span class="hljs-number">40</span>), PostId <span class="hljs-type">INT</span>, CreationDate DATETIME)
  
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> #RowsIWant(DisplayName, PostId, CreationDate)
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
    u.DisplayName, p.Id, p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">JOIN</span> dbo.Users u 
  <span class="hljs-keyword">ON</span>   p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> 
      u.Location     <span class="hljs-keyword">LIKE</span>    <span class="hljs-variable">@Location</span>
  <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>
  OPTION (OPTIMIZE <span class="hljs-keyword">FOR</span>(
      <span class="hljs-variable">@Location</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Willemstad, Curacao&#x27;</span>
    , <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00.000&#x27;</span> 
    , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01 00:00:00.000&#x27;</span>		
  ));


  <span class="hljs-comment">/* Find the most recent posts from an area */</span>
  <span class="hljs-keyword">SELECT</span>
    r.DisplayName, p.Title, r.PostId, r.CreationDate
  <span class="hljs-keyword">FROM</span> #RowsIWant r
  <span class="hljs-keyword">JOIN</span> dbo.Posts p
  <span class="hljs-keyword">ON</span>   r.PostId <span class="hljs-operator">=</span> p.Id
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.CreationDate <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>

DBCC FREEPROCCACHE
<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByLocation_Tune_1] 
    <span class="hljs-variable">@Location</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Willemstad, Curacao&#x27;</span>
  , <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00.000&#x27;</span> 
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01 00:00:00.000&#x27;</span>

<span class="hljs-comment">-- Big Data</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchPostsByLocation_Tune_1] 
    <span class="hljs-variable">@Location</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;India&#x27;</span>
  , <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01 00:00:00.000&#x27;</span> 
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01 00:00:00.000&#x27;</span>
</code></pre>
<h2 id="dbousp_searchusers">[dbo].[usp_SearchUsers]</h2>
<pre><code class="language-sql">USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchUsers]
    <span class="hljs-variable">@CreationDateStart</span>	DATETIME <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
  , <span class="hljs-variable">@CreationDateEnd</span>		DATETIME <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
  , <span class="hljs-variable">@LastAccessDateStart</span>	DATETIME <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
  , <span class="hljs-variable">@LastAccessDateEnd</span>	DATETIME <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
  , <span class="hljs-variable">@OrderBy</span>				NVARCHAR(<span class="hljs-number">50</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span> 

<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExecute</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;SELECT TOP 1000 Id, DisplayName, Location, WebsiteUrl, 
    PostsOwned = (SELECT COUNT(*) FROM dbo.Posts p WHERE p.OwnerUserId = u.Id) 
    FROM dbo.Users u WHERE 1 = 1 &#x27;</span>;

  IF <span class="hljs-variable">@CreationDateStart</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND CreationDate &gt; &#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-variable">@CreationDateStart</span> <span class="hljs-keyword">AS</span> NVARCHAR(<span class="hljs-number">100</span>)) <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;&#x27;&#x27; &#x27;</span>;

  IF <span class="hljs-variable">@CreationDateEnd</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND CreationDate &lt;= &#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-variable">@CreationDateEnd</span> <span class="hljs-keyword">AS</span> NVARCHAR(<span class="hljs-number">100</span>)) <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;&#x27;&#x27; &#x27;</span>;

  IF <span class="hljs-variable">@LastAccessDateStart</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND LastAccessDate &gt; &#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-variable">@LastAccessDateStart</span> <span class="hljs-keyword">AS</span> NVARCHAR(<span class="hljs-number">100</span>)) <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;&#x27;&#x27; &#x27;</span>;

  IF <span class="hljs-variable">@LastAccessDateEnd</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND LastAccessDate &lt;= &#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-variable">@LastAccessDateEnd</span> <span class="hljs-keyword">AS</span> NVARCHAR(<span class="hljs-number">100</span>)) <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;&#x27;&#x27; &#x27;</span>;

  IF <span class="hljs-variable">@OrderBy</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; ORDER BY &#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-variable">@OrderBy</span>;

  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExecute</span>;
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------</span>
<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------</span>

<span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

sp_recompile <span class="hljs-string">&#x27;usp_SearchUsers&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchUsers]
  <span class="hljs-variable">@CreationDateStart</span>	<span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
, <span class="hljs-variable">@CreationDateEnd</span>		<span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
, <span class="hljs-variable">@LastAccessDateStart</span>	<span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
, <span class="hljs-variable">@LastAccessDateEnd</span>	<span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
, <span class="hljs-variable">@OrderBy</span>				<span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>


<span class="hljs-keyword">EXEC</span> [dbo].[usp_SearchUsers]
  <span class="hljs-variable">@CreationDateStart</span>	<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Nov 28 2017 12:00AM&#x27;</span>
, <span class="hljs-variable">@CreationDateEnd</span>		<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;May 28 2018 12:00AM&#x27;</span>
, <span class="hljs-variable">@OrderBy</span>				<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Reputation&#x27;</span>


<span class="hljs-keyword">EXEC</span> master..sp_BlitzIndex 
  <span class="hljs-variable">@DatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;StackOverflow&#x27;</span>
  , <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Users&#x27;</span>

<span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_CreationDate
<span class="hljs-keyword">ON</span> dbo.Users (Reputation, CreationDate)



USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SearchUsers_Tune_0]
    <span class="hljs-variable">@CreationDateStart</span>	DATETIME <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
  , <span class="hljs-variable">@CreationDateEnd</span>		DATETIME <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
  , <span class="hljs-variable">@LastAccessDateStart</span>	DATETIME <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
  , <span class="hljs-variable">@LastAccessDateEnd</span>	DATETIME <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>
  , <span class="hljs-variable">@OrderBy</span>				NVARCHAR(<span class="hljs-number">50</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span> 

<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>

  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExecute</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;SELECT TOP 1000 Id, DisplayName, Location, WebsiteUrl, 
    PostsOwned = (SELECT COUNT(*) FROM dbo.Posts p WHERE p.OwnerUserId = u.Id) 
    FROM dbo.Users u WHERE 1 = 1 &#x27;</span>;

  IF <span class="hljs-variable">@CreationDateStart</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND CreationDate &gt; @CreationDateStart &#x27;</span>;

  IF <span class="hljs-variable">@CreationDateEnd</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND CreationDate &lt;= @CreationDateEnd &#x27;</span>;

  IF <span class="hljs-variable">@LastAccessDateStart</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND LastAccessDate &gt; @LastAccessDateStart &#x27;</span>;

  IF <span class="hljs-variable">@LastAccessDateEnd</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND LastAccessDate &lt;= @LastAccessDateEnd &#x27;</span>;

  IF <span class="hljs-variable">@OrderBy</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
  <span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; ORDER BY &#x27;</span> <span class="hljs-operator">+</span> 
      <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-variable">@OrderBy</span> <span class="hljs-keyword">LIKE</span> N<span class="hljs-string">&#x27;Id%&#x27;</span> <span class="hljs-keyword">THEN</span> N<span class="hljs-string">&#x27; u.Id &#x27;</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-variable">@OrderBy</span> <span class="hljs-keyword">LIKE</span> N<span class="hljs-string">&#x27;DisplayName%&#x27;</span> <span class="hljs-keyword">THEN</span> N<span class="hljs-string">&#x27; u.DisplayName &#x27;</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-variable">@OrderBy</span> <span class="hljs-keyword">LIKE</span> N<span class="hljs-string">&#x27;Location%&#x27;</span> <span class="hljs-keyword">THEN</span> N<span class="hljs-string">&#x27; u.Location &#x27;</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-variable">@OrderBy</span> <span class="hljs-keyword">LIKE</span> N<span class="hljs-string">&#x27;WebsiteUrl%&#x27;</span> <span class="hljs-keyword">THEN</span> N<span class="hljs-string">&#x27; u.WebsiteUrl &#x27;</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-variable">@OrderBy</span> <span class="hljs-keyword">LIKE</span> N<span class="hljs-string">&#x27;PostsOwned%&#x27;</span> <span class="hljs-keyword">THEN</span> N<span class="hljs-string">&#x27; 5 &#x27;</span>
        <span class="hljs-keyword">WHEN</span> <span class="hljs-variable">@OrderBy</span> <span class="hljs-keyword">LIKE</span> N<span class="hljs-string">&#x27;Reputation%&#x27;</span> <span class="hljs-keyword">THEN</span> N<span class="hljs-string">&#x27; u.Reputation&#x27;</span>
      <span class="hljs-keyword">ELSE</span> N<span class="hljs-string">&#x27; u.Id&#x27;</span>
      <span class="hljs-keyword">END</span>
      <span class="hljs-operator">+</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-variable">@OrderBy</span> <span class="hljs-keyword">LIKE</span> N<span class="hljs-string">&#x27;% DESC%&#x27;</span> <span class="hljs-keyword">THEN</span> N<span class="hljs-string">&#x27; DESC &#x27;</span>
        <span class="hljs-keyword">ELSE</span> N<span class="hljs-string">&#x27; ASC &#x27;</span> 
        <span class="hljs-keyword">END</span>;
  <span class="hljs-keyword">END</span>

  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExecute</span>,
  N<span class="hljs-string">&#x27;@CreationDateStart DATETIME, @CreationDateEnd DATETIME, @LastAccessDateStart DATETIME, @LastAccessDateEnd DATETIME&#x27;</span>,
  <span class="hljs-variable">@CreationDateStart</span>, <span class="hljs-variable">@CreationDateEnd</span>, <span class="hljs-variable">@LastAccessDateStart</span>, <span class="hljs-variable">@LastAccessDateEnd</span>;
<span class="hljs-keyword">END</span>

</code></pre>
<h2 id="dbousp_rptfastestanswers">[dbo].[usp_RptFastestAnswers]</h2>
<pre><code class="language-sql"><span class="hljs-comment">/* 
VIDEO 1
First I try with just query changes:
*/</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptFastestAnswers]
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@Tag</span> NVARCHAR(<span class="hljs-number">50</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Changelog:
    2020/05/28 Gabriele D&#x27;Onufrio - looking for the fastest answer fingers in the West, possibly fraud
  */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> 
    r.ResponseTimeSeconds, pQuestion.Title, pQuestion.CreationDate, pQuestion.Body, uQuestion.DisplayName <span class="hljs-keyword">AS</span> Questioner_DisplayName, 
    uQuestion.Reputation <span class="hljs-keyword">AS</span> Questioner_Reputation,pAnswer.Body <span class="hljs-keyword">AS</span> Answer_Body, pAnswer.Score <span class="hljs-keyword">AS</span> Answer_Score,
    uAnswer.DisplayName <span class="hljs-keyword">AS</span> Answerer_DisplayName, uAnswer.Reputation <span class="hljs-keyword">AS</span> Answerer_Reputation
  <span class="hljs-keyword">FROM</span> dbo.AverageAnswerResponseTime r
  <span class="hljs-keyword">JOIN</span> dbo.Posts pQuestion <span class="hljs-keyword">ON</span> r.Id <span class="hljs-operator">=</span> pQuestion.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users uQuestion <span class="hljs-keyword">ON</span> pQuestion.OwnerUserId <span class="hljs-operator">=</span> uQuestion.Id
  <span class="hljs-keyword">JOIN</span> dbo.Posts pAnswer <span class="hljs-keyword">ON</span> pQuestion.AcceptedAnswerId <span class="hljs-operator">=</span> pAnswer.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users uAnswer <span class="hljs-keyword">ON</span> pAnswer.OwnerUserId <span class="hljs-operator">=</span> uAnswer.Id
  <span class="hljs-keyword">WHERE</span> r.QuestionDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
  <span class="hljs-keyword">AND</span>   r.QuestionDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   r.Tags <span class="hljs-operator">=</span> <span class="hljs-variable">@Tag</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.ResponseTimeSeconds <span class="hljs-keyword">ASC</span>;
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>

sp_recompile <span class="hljs-string">&#x27;usp_RptFastestAnswers&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-09-21 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-10-21 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-09-21 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-09-21 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-09-21 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-21 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-09-21 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-21 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;javascript&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-09-21 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-21 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;javascript&gt;&#x27;</span>


<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> Tags, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> recs
<span class="hljs-keyword">FROM</span> dbo.AverageAnswerResponseTime
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> Tags
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">DESC</span>;

<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> dbo.AverageAnswerResponseTime r
<span class="hljs-keyword">WHERE</span>
  r.QuestionDate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2017-09-21 00:00:00.000&#x27;</span>
<span class="hljs-keyword">AND</span> r.QuestionDate <span class="hljs-operator">&lt;</span> <span class="hljs-string">&#x27;2017-12-21 00:01:00.000&#x27;</span>
<span class="hljs-keyword">AND</span> r.Tags         <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.ResponseTimeSeconds <span class="hljs-keyword">ASC</span>

<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>

USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptFastestAnswers_SmallDateRange]
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@Tag</span> NVARCHAR(<span class="hljs-number">50</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Changelog:
    2020/05/28 Gabriele D&#x27;Onufrio - looking for the fastest answer fingers in the West, possibly fraud
  */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> 
    r.ResponseTimeSeconds, pQuestion.Title, pQuestion.CreationDate, pQuestion.Body, uQuestion.DisplayName <span class="hljs-keyword">AS</span> Questioner_DisplayName, 
    uQuestion.Reputation <span class="hljs-keyword">AS</span> Questioner_Reputation,pAnswer.Body <span class="hljs-keyword">AS</span> Answer_Body, pAnswer.Score <span class="hljs-keyword">AS</span> Answer_Score,
    uAnswer.DisplayName <span class="hljs-keyword">AS</span> Answerer_DisplayName, uAnswer.Reputation <span class="hljs-keyword">AS</span> Answerer_Reputation
  <span class="hljs-keyword">FROM</span> dbo.AverageAnswerResponseTime r
  <span class="hljs-keyword">JOIN</span> dbo.Posts pQuestion <span class="hljs-keyword">ON</span> r.Id <span class="hljs-operator">=</span> pQuestion.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users uQuestion <span class="hljs-keyword">ON</span> pQuestion.OwnerUserId <span class="hljs-operator">=</span> uQuestion.Id
  <span class="hljs-keyword">JOIN</span> dbo.Posts pAnswer <span class="hljs-keyword">ON</span> pQuestion.AcceptedAnswerId <span class="hljs-operator">=</span> pAnswer.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users uAnswer <span class="hljs-keyword">ON</span> pAnswer.OwnerUserId <span class="hljs-operator">=</span> uAnswer.Id
  <span class="hljs-keyword">WHERE</span> r.QuestionDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
  <span class="hljs-keyword">AND</span>   r.QuestionDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   r.Tags <span class="hljs-operator">=</span> <span class="hljs-variable">@Tag</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.ResponseTimeSeconds <span class="hljs-keyword">ASC</span>;
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>

USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptFastestAnswers_BigDateRange]
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@Tag</span> NVARCHAR(<span class="hljs-number">50</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Changelog:
    2020/05/28 Gabriele D&#x27;Onufrio - looking for the fastest answer fingers in the West, possibly fraud
  */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> 
    r.ResponseTimeSeconds, pQuestion.Title, pQuestion.CreationDate, pQuestion.Body, uQuestion.DisplayName <span class="hljs-keyword">AS</span> Questioner_DisplayName, 
    uQuestion.Reputation <span class="hljs-keyword">AS</span> Questioner_Reputation,pAnswer.Body <span class="hljs-keyword">AS</span> Answer_Body, pAnswer.Score <span class="hljs-keyword">AS</span> Answer_Score,
    uAnswer.DisplayName <span class="hljs-keyword">AS</span> Answerer_DisplayName, uAnswer.Reputation <span class="hljs-keyword">AS</span> Answerer_Reputation
  <span class="hljs-keyword">FROM</span> dbo.AverageAnswerResponseTime r
  <span class="hljs-keyword">JOIN</span> dbo.Posts pQuestion <span class="hljs-keyword">ON</span> r.Id <span class="hljs-operator">=</span> pQuestion.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users uQuestion <span class="hljs-keyword">ON</span> pQuestion.OwnerUserId <span class="hljs-operator">=</span> uQuestion.Id
  <span class="hljs-keyword">JOIN</span> dbo.Posts pAnswer <span class="hljs-keyword">ON</span> pQuestion.AcceptedAnswerId <span class="hljs-operator">=</span> pAnswer.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users uAnswer <span class="hljs-keyword">ON</span> pAnswer.OwnerUserId <span class="hljs-operator">=</span> uAnswer.Id
  <span class="hljs-keyword">WHERE</span> r.QuestionDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
  <span class="hljs-keyword">AND</span>   r.QuestionDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   r.Tags <span class="hljs-operator">=</span> <span class="hljs-variable">@Tag</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.ResponseTimeSeconds <span class="hljs-keyword">ASC</span>;
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>

USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptFastestAnswers_Tune]
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@Tag</span> NVARCHAR(<span class="hljs-number">50</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>	
  IF DATEDIFF(dd, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">60</span>
    <span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers_BigDateRange] <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StartDate</span> , <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@EndDate</span> , <span class="hljs-variable">@Tag</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Tag</span> 
  <span class="hljs-keyword">ELSE</span>
    <span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers_SmallDateRange] <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StartDate</span> , <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@EndDate</span> , <span class="hljs-variable">@Tag</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Tag</span> 
<span class="hljs-keyword">END</span>

sp_recompile <span class="hljs-string">&#x27;usp_RptFastestAnswers_Tune&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers_Tune]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-09-21 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-12-21 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers_Tune]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-09-21 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2018-12-21 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;javascript&gt;&#x27;</span>

</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* 
VIDEO 2
Second I try with just index changes:
*/</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptFastestAnswers]
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@Tag</span> NVARCHAR(<span class="hljs-number">50</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Changelog:
    2020/05/28 Gabriele D&#x27;Onufrio - looking for the fastest answer fingers in the West, possibly fraud
  */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> 
    r.ResponseTimeSeconds, pQuestion.Title, pQuestion.CreationDate, pQuestion.Body, uQuestion.DisplayName <span class="hljs-keyword">AS</span> Questioner_DisplayName, 
    uQuestion.Reputation <span class="hljs-keyword">AS</span> Questioner_Reputation,pAnswer.Body <span class="hljs-keyword">AS</span> Answer_Body, pAnswer.Score <span class="hljs-keyword">AS</span> Answer_Score,
    uAnswer.DisplayName <span class="hljs-keyword">AS</span> Answerer_DisplayName, uAnswer.Reputation <span class="hljs-keyword">AS</span> Answerer_Reputation
  <span class="hljs-keyword">FROM</span> dbo.AverageAnswerResponseTime r
  <span class="hljs-keyword">JOIN</span> dbo.Posts pQuestion <span class="hljs-keyword">ON</span> r.Id <span class="hljs-operator">=</span> pQuestion.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users uQuestion <span class="hljs-keyword">ON</span> pQuestion.OwnerUserId <span class="hljs-operator">=</span> uQuestion.Id
  <span class="hljs-keyword">JOIN</span> dbo.Posts pAnswer <span class="hljs-keyword">ON</span> pQuestion.AcceptedAnswerId <span class="hljs-operator">=</span> pAnswer.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users uAnswer <span class="hljs-keyword">ON</span> pAnswer.OwnerUserId <span class="hljs-operator">=</span> uAnswer.Id
  <span class="hljs-keyword">WHERE</span> r.QuestionDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
  <span class="hljs-keyword">AND</span>   r.QuestionDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   r.Tags <span class="hljs-operator">=</span> <span class="hljs-variable">@Tag</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.ResponseTimeSeconds <span class="hljs-keyword">ASC</span>;
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>

sp_recompile <span class="hljs-string">&#x27;usp_RptFastestAnswers&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-02-04 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-02-05 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-03-08 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-04-08 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-04-08 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-10-08 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-04-08 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2024-10-08 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;javascript&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-04-08 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2024-10-08 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;android&gt;&#x27;</span>


<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span>
  pQ.Id, pQ.Tags, pQ.CreationDate <span class="hljs-keyword">AS</span> QuestionDate, 
  DATEDIFF(<span class="hljs-keyword">SECOND</span>, pQ.CreationDate, pA.CreationDate) <span class="hljs-keyword">AS</span> ResponseTimeSeconds
<span class="hljs-keyword">FROM</span> dbo.Posts pQ
<span class="hljs-keyword">JOIN</span> dbo.Posts pA <span class="hljs-keyword">ON</span> pQ.AcceptedAnswerId <span class="hljs-operator">=</span> pA.Id
<span class="hljs-keyword">WHERE</span> pQ.PostTypeId <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">AND</span>   pQ.CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2017-03-08 00:00:00.000&#x27;</span>
<span class="hljs-keyword">AND</span>   pQ.CreationDate <span class="hljs-operator">&lt;</span>  <span class="hljs-string">&#x27;2017-04-08 00:00:00.000&#x27;</span>
<span class="hljs-keyword">AND</span>   pQ.Tags		  <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>

<span class="hljs-comment">-- kipply</span>
USE [StackOverflow]
GO


<span class="hljs-keyword">EXEC</span> master.dbo.sp_BlitzIndex
  <span class="hljs-variable">@DatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;StackoverFlow&#x27;</span>
  , <span class="hljs-variable">@TableName</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>

<span class="hljs-keyword">DROP</span> INDEX [IX_PostTypeId] <span class="hljs-keyword">ON</span> [StackoverFlow].[dbo].[Posts];
<span class="hljs-keyword">DROP</span> INDEX [_dta_index_Posts_5_85575343__K16_K7_K5_K14_17] <span class="hljs-keyword">ON</span> [StackoverFlow].[dbo].[Posts];

<span class="hljs-keyword">CREATE</span> NONCLUSTERED INDEX IX_PostTypeId
<span class="hljs-keyword">ON</span> [dbo].[Posts] ([PostTypeId],[Tags],[CreationDate])
INCLUDE ([AcceptedAnswerId])
<span class="hljs-keyword">WITH</span>(MAXDOP <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, ONLINE <span class="hljs-operator">=</span> OFF)

</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* 
VIDEO 3
And in a third class, I tried to reduce the stench by letting small date ranges get their own plan, but force large date ranges to do a table scan without screwing other users.
*/</span>
USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptFastestAnswers]
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@Tag</span> NVARCHAR(<span class="hljs-number">50</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">/* Changelog:
    2020/05/28 Gabriele D&#x27;Onufrio - looking for the fastest answer fingers in the West, possibly fraud
  */</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> 
    r.ResponseTimeSeconds, pQuestion.Title, pQuestion.CreationDate, pQuestion.Body, uQuestion.DisplayName <span class="hljs-keyword">AS</span> Questioner_DisplayName, 
    uQuestion.Reputation <span class="hljs-keyword">AS</span> Questioner_Reputation,pAnswer.Body <span class="hljs-keyword">AS</span> Answer_Body, pAnswer.Score <span class="hljs-keyword">AS</span> Answer_Score,
    uAnswer.DisplayName <span class="hljs-keyword">AS</span> Answerer_DisplayName, uAnswer.Reputation <span class="hljs-keyword">AS</span> Answerer_Reputation
  <span class="hljs-keyword">FROM</span> dbo.AverageAnswerResponseTime r
  <span class="hljs-keyword">JOIN</span> dbo.Posts pQuestion <span class="hljs-keyword">ON</span> r.Id <span class="hljs-operator">=</span> pQuestion.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users uQuestion <span class="hljs-keyword">ON</span> pQuestion.OwnerUserId <span class="hljs-operator">=</span> uQuestion.Id
  <span class="hljs-keyword">JOIN</span> dbo.Posts pAnswer <span class="hljs-keyword">ON</span> pQuestion.AcceptedAnswerId <span class="hljs-operator">=</span> pAnswer.Id
  <span class="hljs-keyword">JOIN</span> dbo.Users uAnswer <span class="hljs-keyword">ON</span> pAnswer.OwnerUserId <span class="hljs-operator">=</span> uAnswer.Id
  <span class="hljs-keyword">WHERE</span> r.QuestionDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
  <span class="hljs-keyword">AND</span>   r.QuestionDate <span class="hljs-operator">&lt;</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">AND</span>   r.Tags <span class="hljs-operator">=</span> <span class="hljs-variable">@Tag</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.ResponseTimeSeconds <span class="hljs-keyword">ASC</span>;
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>

sp_recompile <span class="hljs-string">&#x27;usp_RptFastestAnswers&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-02 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-01-03 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-05-11 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-06-11 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>


<span class="hljs-comment">-- OutLier</span>
sp_recompile <span class="hljs-string">&#x27;usp_RptFastestAnswers&#x27;</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-05-11 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-05-11 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;xxxxxx&gt;&#x27;</span>

<span class="hljs-comment">/*BIG*/</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-05-11 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-06-11 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>


<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2005-05-11 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2025-05-11 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;xxxxxxx&gt;&#x27;</span>

<span class="hljs-comment">/*BIG*/</span>
<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-05-11 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-06-11 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;andriod&gt;&#x27;</span>

<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="hljs-comment">-- ------------------------------------------------------------------------------------------------------------------------------------------------</span>

USE [StackOverflow]
GO

<span class="hljs-keyword">SET</span> ANSI_NULLS <span class="hljs-keyword">ON</span>
GO
<span class="hljs-keyword">SET</span> QUOTED_IDENTIFIER <span class="hljs-keyword">ON</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_RptFastestAnswers_Tune_0]
  <span class="hljs-variable">@StartDate</span> DATETIME, <span class="hljs-variable">@EndDate</span> DATETIME, <span class="hljs-variable">@Tag</span> NVARCHAR(<span class="hljs-number">50</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  
  <span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExec</span> NVARCHAR(<span class="hljs-number">4000</span>) <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;
  SELECT TOP 10 
    r.ResponseTimeSeconds, pQuestion.Title, pQuestion.CreationDate, pQuestion.Body, uQuestion.DisplayName AS Questioner_DisplayName, 
    uQuestion.Reputation AS Questioner_Reputation,pAnswer.Body AS Answer_Body, pAnswer.Score AS Answer_Score,
    uAnswer.DisplayName AS Answerer_DisplayName, uAnswer.Reputation AS Answerer_Reputation
  FROM dbo.AverageAnswerResponseTime r
  JOIN dbo.Posts pQuestion ON r.Id = pQuestion.Id
  JOIN dbo.Users uQuestion ON pQuestion.OwnerUserId = uQuestion.Id
  JOIN dbo.Posts pAnswer ON pQuestion.AcceptedAnswerId = pAnswer.Id
  JOIN dbo.Users uAnswer ON pAnswer.OwnerUserId = uAnswer.Id
  WHERE r.QuestionDate &gt;= @StartDate
  AND   r.QuestionDate &lt; @EndDate
  AND   r.Tags = @Tag
  ORDER BY r.ResponseTimeSeconds ASC&#x27;</span>

  IF DATEDIFF(dd, <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">90</span>
    <span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExec</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; /* Big date range */&#x27;</span>

  <span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExec</span>,N<span class="hljs-string">&#x27;@StartDate DATETIME, @EndDate DATETIME, @Tag NVARCHAR(50)&#x27;</span>, 
    <span class="hljs-variable">@StartDate</span>, <span class="hljs-variable">@EndDate</span>, <span class="hljs-variable">@Tag</span> 
<span class="hljs-keyword">END</span>

<span class="hljs-comment">-- OutLier</span>
sp_recompile <span class="hljs-string">&#x27;usp_RptFastestAnswers_Tune_0&#x27;</span>
DBCC FREEPROCCACHE

<span class="hljs-keyword">EXEC</span> [dbo].[usp_RptFastestAnswers_Tune_0]
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-05-11 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-05-11 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;xxxxxx&gt;&#x27;</span>

<span class="hljs-comment">/*BIG*/</span>
<span class="hljs-keyword">EXEC</span> [dbo].usp_RptFastestAnswers_Tune_0
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-05-11 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-06-11 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;sql-server&gt;&#x27;</span>


<span class="hljs-keyword">EXEC</span> [dbo].usp_RptFastestAnswers_Tune_0
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2005-05-11 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2025-05-11 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;xxxxxxx&gt;&#x27;</span>

<span class="hljs-comment">/*BIG*/</span>
<span class="hljs-keyword">EXEC</span> [dbo].usp_RptFastestAnswers_Tune_0
    <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-05-11 00:00:00.000&#x27;</span>
  , <span class="hljs-variable">@EndDate</span>   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2017-06-11 00:01:00.000&#x27;</span>
  , <span class="hljs-variable">@Tag</span>       <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;&lt;andriod&gt;&#x27;</span>
</code></pre>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>