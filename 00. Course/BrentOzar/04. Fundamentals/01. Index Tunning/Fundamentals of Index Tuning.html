<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Brent Ozar Course Notes</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ startOnLoad: true });
    </script>
            
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="brent-ozar-course-notes">Brent Ozar Course Notes</h1>
<style>
r { color: red }
o { color: Orange }
g { color: Green }
lg { color: lightgreen }
b { color: Blue }
lb { color: lightblue }
</style>
<pre><code class="language-sql"></code></pre>
<ul>
<li>
<p>Initial Page</p>
<p><a href="https://training.brentozar.com/courses/">https://training.brentozar.com/courses/</a></p>
</li>
</ul>
<hr>
<h1 id="1-fundamentals-of-index-tuning">1. Fundamentals of Index Tuning</h1>
<ul>
<li>Index
<ul>
<li>
<p><a href="#Folder-Structrure">Folder Structure</a></p>
</li>
<li>
<p><a href="#Learn-how-to-visualize-an-index's-contets">Learn hot to visualize an index's contets</a></p>
</li>
<li>
<p><a href="#WHERE">WHERE</a></p>
<ul>
<li><a href="#With-1-equility-search">With 1 equility search</a></li>
<li><a href="#With-2-equeality-searches">With 2 equeality searches</a></li>
<li><a href="#With-both-%22equality%22-and-%22inequality%22-searches">With both &quot;equality&quot; and &quot;inequality&quot; searches</a></li>
<li><a href="#RECAP">RECAP</a></li>
<li><a href="#LAB-2">LAB 2</a></li>
</ul>
</li>
<li>
<p><a href="#ORDER-BY">ORDER BY</a></p>
<ul>
<li><a href="#After-2-Equality-searches">After 2 Equality searches</a></li>
<li><a href="#After-an-InEquality-seraches">After an InEquality seraches</a></li>
</ul>
</li>
<li>
<p><a href="#TOP">TOP</a></p>
<ul>
<li><a href="#Design-and-index-for-this-:">Design and index for this:</a></li>
<li><a href="#RECAP">RECAP</a></li>
<li><a href="#LAB-4">LAB 4</a></li>
</ul>
</li>
<li>
<p><a href="#JOINs">JOINs</a></p>
<ul>
<li><a href="#Design-and-index-for-this-:">One Join (never in the real life)</a></li>
<li><a href="#JOIN-+-ORDER-BY">JOIN + ORDER BY</a></li>
<li><a href="#MIXING-JOINS-AND-FILTERS">MIXING JOINS AND FILTERS)</a></li>
<li><a href="#LOTS-OF-JOINS">LOTS OF JOINS</a></li>
<li><a href="#WHERE-EXISTS">WHERE EXISTS</a></li>
<li><a href="#RECAP">RECAP</a></li>
<li><a href="#LAB-6">LAB 6</a></li>
</ul>
</li>
<li>
<p><a href="#The-built-in-missing-index-recommendations">The built-in missing index recommendations</a></p>
<ul>
<li><a href="#Index-hints-are-a-gift">Index hints are a gift</a></li>
<li><a href="#Let%E2%80%99s-see-how-he-does-it">Let’s see how he does it</a></li>
<li><a href="#So-far-,-not-bad">So far, not bad</a></li>
<li><a href="#He-is-focus-on-WHERE-,-not-GROUP-BY-or-ORDER-BY">He is focus on WHERE, not GROUP BY or ORDER BY</a></li>
<li><a href="#Addeding-Clippy/s-indexes-can-even-make-things-worse">Addeding Clippy/s indexes can even make things worse</a></li>
<li><a href="#RECAP">RECAP</a></li>
<li><a href="#LAB-7">LAB 7</a></li>
</ul>
</li>
<li>
<p><a href="#Recap-of-what-we-learned-and-what-to-do-next">Recap of what we learned and what to do next</a></p>
<ul>
<li><a href="#">Selectivity isn’t just uniquenesst</a>Selectivity-isn’t-just-uniquenesst)</li>
<li><a href="#Visualize-indexes-with-a-query">Visualize indexes with a query</a></li>
<li><a href="#The-first-round-is-the-easy-button">The first round is the easy button</a></li>
<li><a href="#The-wrong-nonclustered-indexes">The wrong nonclustered indexes</a></li>
<li><a href="#My-D.E.A.T.H.-Method">My D.E.A.T.H. Method</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="folder-structure">Folder Structure</h2>
<ol>
<li>
<p>Images
Will have the images that I take from the course.</p>
</li>
<li>
<p>PDF
Will have the document download from Brent Ozar oficial course.</p>
</li>
<li>
<p>Script
Will have the document download from Brent Ozar oficial course.</p>
</li>
</ol>
<h2 id="learn-how-to-visualize-an-indexs-contets">Learn how to visualize an index's contets</h2>
<p>If we create the below index:</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> INDEX IX_LastAccessDate_ID
<span class="hljs-keyword">ON</span> dbo.Users(DisplatName, ID)
GO
</code></pre>
<p>You can see how this look likes executing the following SELECT:</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> LastAccessDate, ID
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName, ID
</code></pre>
<p>Other example</p>
<pre><code class="language-sql"><span class="hljs-comment">-- Create Index</span>
<span class="hljs-keyword">CREATE</span> INDEX IX_LastAccessDate_ID_DisplayName_Age
<span class="hljs-keyword">ON</span> dbo.Users(DisplatName, ID)
INCLUDE (DisplayName, Age)

<span class="hljs-comment">-- See how the index look like</span>
<span class="hljs-keyword">SELECT</span>
    LastAccessDate, DisplatName, ID, DisplayName, Age
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplatName, Id
</code></pre>
<p><strong><span style="color:red;">Use this process as you work</span></strong>
When you are designing indexes, write a query with a matching SELECT and WHERE. Review the data that comes out and think like the engine. This Index will help execute the query that I am trying to tune?</p>
<h2 id="where">WHERE</h2>
<ul>
<li>
<p>With 1 equility search
Design an index for this query</p>
<pre><code class="language-sql"><span class="hljs-comment">/* FIRST LAB CHALLENGE: design the right index for this: */</span>
<span class="hljs-keyword">SELECT</span> Id, DisplatName, Location
<span class="hljs-keyword">FROM</span>   dbo.Users
<span class="hljs-keyword">WHERE</span>  DisplayName <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Alex&#x27;</span>;
GO

<span class="hljs-comment">/* The index */</span>
<span class="hljs-keyword">CREATE</span> NONCLUSTERED DisplayName_Location
    <span class="hljs-keyword">ON</span> dbo.Users(DisplayName)
    INCLUDE(Location)
</code></pre>
<ul>
<li>Should you include Id?
How to Think Like the Engine explained that the clustering key on a table is always included. There’s no extra cost whether you include it or not:
it doesn’t get stored twice. I only include it if my query needs it in the output, and I suspect somebody’s gonna come behind me and  change the clustering key later.
Here, I’m fine either way.</li>
</ul>
<p><r>The diff between the Key and the INCLUDE is that on the INCLUDE the data is not ordered</r></p>
<pre><code class="language-sql"><span class="hljs-comment">/* To check the index organization you can run */</span>
<span class="hljs-keyword">SELECT</span> DisplayName, Location, Id
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName
</code></pre>
</li>
<li>
<p>With 2 equeality searches
Design an index for this query</p>
<pre><code class="language-sql"><span class="hljs-comment">/* FIRST LAB CHALLENGE: design the right index for this: */</span>
<span class="hljs-keyword">SELECT</span> Id, DisplatName, Location
<span class="hljs-keyword">FROM</span>   dbo.Users
<span class="hljs-keyword">WHERE</span>  DisplayName <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Alex&#x27;</span>
<span class="hljs-keyword">AND</span>    Location    <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Seattle, WA&#x27;</span>;
GO

<span class="hljs-comment">/* The old index 
SQL Server can use that last index we created.
*/</span>
</code></pre>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Images\With2Equality_1.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Images\With2Equality_2.png" alt="alt text"></p>
<pre><code class="language-sql"><span class="hljs-comment">/* The new index */</span>
<span class="hljs-keyword">CREATE</span> NONCLUSTERED DisplayName_Location
    <span class="hljs-keyword">ON</span> dbo.Users(DisplayName, Location)

<span class="hljs-keyword">CREATE</span> NONCLUSTERED Location_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users(Location, DisplayName)
</code></pre>
<ul>
<li>Test ‘em
I don’t like index hints for long-term usage because your query will simply fail if the index disappears or is renamed. Hints are great for checking logical reads though.</li>
</ul>
<p>RESULT
Index                           Logical Reads
Clustered index (white pages)   45,184
IX_DisplayName_Includes             16
IX_DisplayName_Location              4
IX_Location_DisplayName              5</p>
<p>But don’t quibble over a handful of logical reads. All of the indexes are pretty good!</p>
</li>
<li>
<p>With both &quot;equality&quot; and &quot;inequality&quot; searches</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\EquaAndINequaTable.png" alt="alt text"></p>
<p>Now try this query.</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> Id, DisplayName, Location
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> DisplayName <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;alex&#x27;</span>
<span class="hljs-keyword">AND</span> Location <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;Seattle, WA&#x27;</span>;
</code></pre>
<p>The &lt;&gt; is really important: it changes the game</p>
<p>Think back to your 2 earlier indexes.
<img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\EqueAndINequaSELECT_1.png" alt="alt text">
<img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\EqueAndINequaSELECT_2.png" alt="alt text">
<img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\EqueAndINequaSELECT_3.png" alt="alt text"></p>
<p>Survey says...
Index                           Logical Reads     Total Pages in the Index
Clustered index (white pages)   45,184            45,184
IX_DisplayName_Includes             16            12,577
IX_DisplayName_Location             13            12,701
IX_Location_DisplayName          4,566            13,183</p>
<ul>
<li>
<p>So what’s the lesson?
When you have both equality and inequality searches, you might think it’s important to put the equality fields first in the index key order so that you can seek directly to the rows you want.
WHERE DisplayName = 'alex'
AND Location &lt;&gt; 'Seattle, WA’;
But that’s not necessarily true. Hold that thought.</p>
</li>
<li>
<p>Field order isn’t about equality.
Field order is about selectivity, the ability to reduce the amount of work we’re about to do. Sometimes that’s about reducing row counts by filtering down the number of rows we’re going to pass on to the next operator in a plan. Other times, it’s about pre-sorting data to avoid sorts.</p>
</li>
<li>
<p><r>What selectivity really means</r>
<r>It’s not about how unique each row is by itself. It’s about your query, and how small a percentage of the table you’re searching for.</r>
<r>When evaluating column order for indexes, don’t think about how unique each column is. Think about what percentage you’re searching for.</r></p>
</li>
<li>
<p>Testing it out</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> Id, LastAccessDate, DownVotes
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> LastAccessDate <span class="hljs-operator">&lt;=</span> GETDATE()
<span class="hljs-keyword">AND</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
</code></pre>
</li>
<li>
<p>RECAP
If your queries only have equality searches, key field order isn’t all that important. When you have inequality searches, though, key field order matters a LOT. The first fields in the key need to help reduce the amount of rows you scan. Just because you see a “seek” doesn’t mean you’re seeking to a specific row: residual predicates indicate
a seek, followed by a scan of an area of the index.</p>
<p>Picking key order</p>
<ul>
<li>Fields in the WHERE clause usually (We’ll break this rule in the next module) need to go first.</li>
<li>Selective query filters go first: reduce the amount of data you’re searching through.</li>
<li>Commonly filtered-on fields go first: maximize the number of queries that can use an index.</li>
</ul>
<p>Testing it out
When designing indexes for a query, craft a separate SELECT query for each filter in the WHERE clause, and test to see how selective it is.</p>
</li>
</ul>
<ul>
<li>
<p>LAB 2</p>
<pre><code class="language-sql"><span class="hljs-comment">/* FIRST LAB CHALLENGE: design the right index for this: */</span>
<span class="hljs-keyword">SELECT</span> DisplatName, Id
<span class="hljs-keyword">FROM</span>   dbo.Users
<span class="hljs-keyword">WHERE</span>  WebsiteUrl <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;http://127.0.0.1&#x27;</span>
<span class="hljs-keyword">AND</span>    Location   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;United States&#x27;</span>;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
	<span class="hljs-keyword">In</span> this <span class="hljs-keyword">case</span> it does <span class="hljs-keyword">not</span> matter, because the <span class="hljs-keyword">WHERE</span> clause <span class="hljs-keyword">is</span> an EQUALITY <span class="hljs-keyword">WHERE</span> clause<span class="hljs-operator">!</span><span class="hljs-operator">!</span>
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?
	WebsiteUrl <span class="hljs-keyword">is</span> more selective

<span class="hljs-comment">/*REPONSE:*/</span>
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> WebsiteUrl <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;http://127.0.0.1&#x27;</span>;
	WebSiteUrl <span class="hljs-operator">=</span> <span class="hljs-number">105</span>   records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>

	<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Location   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;United States&#x27;</span>;
	Location   <span class="hljs-operator">=</span> <span class="hljs-number">8.704</span> records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">8704</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.35</span>

<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_WebsiteURL_Location 
    <span class="hljs-keyword">ON</span> dbo.Users (WebsiteURL, Location)  INCLUDE (DisplayName);		
	
    <span class="hljs-keyword">CREATE</span> INDEX IX_Location_WebsiteURL 
    <span class="hljs-keyword">ON</span> dbo.Users (Location , WebsiteURL) INCLUDE (DisplayName);

<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

	<span class="hljs-keyword">SELECT</span> DisplatName, Id
	<span class="hljs-keyword">FROM</span>   dbo.Users	<span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
	<span class="hljs-keyword">WHERE</span>  WebsiteUrl <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;http://127.0.0.1&#x27;</span>
	<span class="hljs-keyword">AND</span>    Location   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;United States&#x27;</span>;

	<span class="hljs-keyword">SELECT</span> DisplatName, Id
	<span class="hljs-keyword">FROM</span>   dbo.Users	<span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> IX_WebsiteURL_Location)
	<span class="hljs-keyword">WHERE</span>  WebsiteUrl <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;http://127.0.0.1&#x27;</span>
	<span class="hljs-keyword">AND</span>    Location   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;United States&#x27;</span>;

	<span class="hljs-keyword">SELECT</span> DisplatName, Id
	<span class="hljs-keyword">FROM</span>   dbo.Users	<span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> IX_Location_WebsiteURL)
	<span class="hljs-keyword">WHERE</span>  WebsiteUrl <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;http://127.0.0.1&#x27;</span>
	<span class="hljs-keyword">AND</span>    Location   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;United States&#x27;</span>;

	<span class="hljs-keyword">SELECT</span> DisplatName, Id
	<span class="hljs-keyword">FROM</span>   dbo.Users
	<span class="hljs-keyword">WHERE</span>  WebsiteUrl <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;http://127.0.0.1&#x27;</span>
	<span class="hljs-keyword">AND</span>    Location   <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;United States&#x27;</span>;
    <span class="hljs-comment">---------------------------------------------------------------------------------------</span>
    (INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)					     <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44.530</span>
	(INDEX <span class="hljs-operator">=</span> IX_WebsiteURL_Location) <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">30</span>
	(INDEX <span class="hljs-operator">=</span> IX_Location_WebsiteURL) <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">30</span>
	ENGINE							 <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">30</span>

<span class="hljs-number">4.</span> VISUALIZATION INDEX
    INDEX <span class="hljs-number">1</span>

    INDEX <span class="hljs-number">2</span>    
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* NEXT EXERCISE: design the right index to find the nicest people: */</span>
<span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
<span class="hljs-keyword">FROM</span>   dbo.Users
<span class="hljs-keyword">WHERE</span>  DownVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">AND</span>    UpVotes   <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
(<span class="hljs-number">25695</span> <span class="hljs-keyword">rows</span> affected)
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>, physical <span class="hljs-keyword">reads</span> <span class="hljs-number">3</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?

<span class="hljs-comment">/*REPONSE:*/</span> 
<span class="hljs-number">5.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> DownVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">SELECT</span> (<span class="hljs-number">2231034</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2465713</span> <span class="hljs-operator">=</span> <span class="hljs-number">90</span><span class="hljs-operator">%</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> UpVotes   <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;
    <span class="hljs-keyword">SELECT</span> (<span class="hljs-number">143668</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2465713</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-operator">%</span>    

<span class="hljs-number">6.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_UpVotes_DownVotes_INCLUDE_DisplayName_Location 
    <span class="hljs-keyword">ON</span> dbo.Users (UpVotes, DownVotes) INCLUDE (DisplayName, Location);	

    <span class="hljs-keyword">CREATE</span> INDEX IX_DownVotes_UpVotes_INCLUDE_DisplayName_Location 
    <span class="hljs-keyword">ON</span> dbo.Users (DownVotes, UpVotes) INCLUDE (DisplayName, Location);

<span class="hljs-number">7.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

    <span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users <span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
    <span class="hljs-keyword">WHERE</span>  DownVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span>    UpVotes   <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;

    <span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users <span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> IX_UpVotes_DownVotes_INCLUDE_DisplayName_Location)
    <span class="hljs-keyword">WHERE</span>  DownVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span>    UpVotes   <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;

    <span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users <span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> IX_DownVotes_UpVotes_INCLUDE_DisplayName_Location)
    <span class="hljs-keyword">WHERE</span>  DownVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span>    UpVotes   <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;

    <span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">WHERE</span>  DownVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span>    UpVotes   <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;
    <span class="hljs-comment">---------------------------------------------------------------------------------------</span>
    INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>							   <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>
    IX_UpVotes_DownVotes_INCLUDE_DisplayName_Location  <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">1123</span>
    IX_DownVotes_UpVotes_INCLUDE_DisplayName_Location  <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">189</span>
    ENGINE								   <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">189</span>

<span class="hljs-number">8.</span> VISUALIZATION INDEX
    INDEX <span class="hljs-number">1</span>				
    <span class="hljs-keyword">CREATE</span> INDEX IX_UpVotes_DownVotes_INCLUDE_DisplayName_Location 
    <span class="hljs-keyword">ON</span> dbo.Users (UpVotes  , DownVotes) INCLUDE (DisplayName, Location);		
    
    <span class="hljs-comment">-- This bring the index data doing an Index Scan</span>
    <span class="hljs-keyword">SELECT</span> UpVotes, DownVotes, DisplayName, Location
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> UpVotes, DownVotes

    <span class="hljs-comment">-- We are going to similate the query</span>
    <span class="hljs-keyword">SELECT</span> UpVotes, DownVotes, DisplayName, Location
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">WHERE</span>  UpVotes <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> UpVotes, DownVotes

    <span class="hljs-comment">/***********************************************************************************
    SQL server bomp into UpVotes = 100 and start reading. That is why is reading 143.668
    rows. Because we have UpVotes = 100 and
    DownVotes = 0 but then we have UpVotes = 100  with DownVotes = 2. Then if you
    continue checking the data we have UpVotes = 101
    with DownVotes = 0 and so on ....
    ***********************************************************************************/</span>

    INDEX <span class="hljs-number">2</span>
    <span class="hljs-keyword">CREATE</span> INDEX IX_DownVotes_UpVotes_INCLUDE_DisplayName_Location 
    <span class="hljs-keyword">ON</span> dbo.Users (DownVotes, UpVotes)   
    INCLUDE (DisplayName, Location);

    <span class="hljs-comment">-- This bring the index data doing an Index Scan</span>
    <span class="hljs-keyword">SELECT</span> DownVotes, UpVotes, DisplayName, Location
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DownVotes, UpVotes

    <span class="hljs-comment">-- We are going to similate the query </span>
    <span class="hljs-keyword">SELECT</span> DownVotes, UpVotes, DisplayName, Location
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">WHERE</span>  DownVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-comment">-- AND UpVotes &gt; 100</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DownVotes, UpVotes
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* NEXT EXERCISE: find German people with a high reputation: */</span>
<span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%Germany%&#x27;</span>
<span class="hljs-keyword">AND</span>   Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">100000</span>;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
(<span class="hljs-number">37</span> <span class="hljs-keyword">rows</span> affected)
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>, physical <span class="hljs-keyword">reads</span> <span class="hljs-number">3</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?

<span class="hljs-comment">/*REPONSE:*/</span> 
<span class="hljs-number">9.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%Germany%&#x27;</span>;
    <span class="hljs-keyword">SELECT</span> (<span class="hljs-number">20411</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2465713</span> <span class="hljs-operator">=</span> <span class="hljs-number">90</span><span class="hljs-operator">%</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">100000</span>;
    <span class="hljs-keyword">SELECT</span> (<span class="hljs-number">613</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2465713</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-operator">%</span>    

<span class="hljs-number">10.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-comment">-- SQL Server can&#x27;t handle Location LIKE &#x27;%Germany%&#x27; because you can have Germany or East Germany, </span>
    <span class="hljs-comment">-- West Germany or Berlin, Germany or etc. So we have to create an Index using Reputation for sure</span>
    <span class="hljs-comment">-- To have a good order</span>

    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation 
    <span class="hljs-keyword">ON</span> dbo.Users(Reputation)

    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Location 
    <span class="hljs-keyword">ON</span> dbo.Users(Reputation, Location)

    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Location 
    <span class="hljs-keyword">ON</span> dbo.Users(Reputation, Location)
	INCLUDE (DisplayName)

    <span class="hljs-comment">-- Location is not in order so we can put that column into the INCLUDE</span>
    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Location 
    <span class="hljs-keyword">ON</span> dbo.Users(Reputation)
	INCLUDE (Location)

    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Location_INCLUDE_DisplayName_Id
	<span class="hljs-keyword">ON</span> dbo.Users(Reputation, Location)
	INCLUDE (DisplatName, ID)

	<span class="hljs-keyword">CREATE</span> INDEX IX_Location_Reputation_INCLUDE_DisplayName_Id
	<span class="hljs-keyword">ON</span> dbo.Users(Location, Reputation)
	INCLUDE (DisplatName, ID)

<span class="hljs-number">11.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

    <span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
	<span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
	<span class="hljs-keyword">WHERE</span> Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%Germany%&#x27;</span>
	<span class="hljs-keyword">AND</span>   Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">100000</span>;

	<span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
	<span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> IX_Reputation_Location_INCLUDE_DisplayName_Id)
	<span class="hljs-keyword">WHERE</span> Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%Germany%&#x27;</span>
	<span class="hljs-keyword">AND</span>   Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">100000</span>;

	<span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
	<span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> IX_Location_Reputation_INCLUDE_DisplayName_Id)
	<span class="hljs-keyword">WHERE</span> Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%Germany%&#x27;</span>
	<span class="hljs-keyword">AND</span>   Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">100000</span>;

	<span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
	<span class="hljs-keyword">FROM</span> dbo.Users
	<span class="hljs-keyword">WHERE</span> Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%Germany%&#x27;</span>
	<span class="hljs-keyword">AND</span>   Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">100000</span>;
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>						   <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>
    IX_UpVotes_DownVotes_INCLUDE_ ...  <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">10</span>
    IX_DownVotes_UpVotes_INCLUDE_ ...  <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">14029</span>
    ENGINE							   <span class="hljs-operator">=</span> <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">10</span>

<span class="hljs-number">12.</span> VISUALIZATION INDEX
    INDEX <span class="hljs-number">1</span>				
    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Location_INCLUDE_DisplayName_Id
	<span class="hljs-keyword">ON</span> dbo.Users(Reputation, Location)
	INCLUDE (DisplatName, ID)		
    
    <span class="hljs-comment">-- This bring the index data doing an Index Scan</span>
    <span class="hljs-keyword">SELECT</span> Reputation, Location
	<span class="hljs-keyword">FROM</span>   dbo.Users
	<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation, Location

    <span class="hljs-comment">-- We are going to similate the query</span>
    <span class="hljs-keyword">SELECT</span> Reputation, Location
	<span class="hljs-keyword">FROM</span>   dbo.Users
	<span class="hljs-keyword">WHERE</span>  Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">100000</span>
	<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation, Location

    <span class="hljs-keyword">SELECT</span> Reputation, Location
	<span class="hljs-keyword">FROM</span>   dbo.Users
	<span class="hljs-keyword">WHERE</span>  Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%Germany%&#x27;</span>
	<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Location, Reputation

    <span class="hljs-keyword">SELECT</span> Reputation, Location
	<span class="hljs-keyword">FROM</span>   dbo.Users
	<span class="hljs-keyword">WHERE</span>  Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%Germany%&#x27;</span>
	<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Location, Reputation

    <span class="hljs-comment">/***********************************************************************************
    SQL server bomp into Reputation &gt; 100000 and start reading. 
    Then read the recidual Location LIKE &#x27;%Germany%&#x27;.
    It&#x27;s a Recidual Predica because the Index is organize only on the First column 
    in this case (Reputation)
    ***********************************************************************************/</span>

    INDEX <span class="hljs-number">2</span>
    <span class="hljs-keyword">CREATE</span> INDEX IX_Location_Reputation_INCLUDE_DisplayName_Id
	<span class="hljs-keyword">ON</span> dbo.Users(Location, Reputation)
	INCLUDE (DisplatName, ID)

    <span class="hljs-comment">-- This bring the index data doing an Index Scan</span>
    <span class="hljs-keyword">SELECT</span> DownVotes, UpVotes, DisplayName, Location
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DownVotes, UpVotes

    <span class="hljs-comment">-- We are going to similate the query </span>
    <span class="hljs-keyword">SELECT</span> DownVotes, UpVotes, DisplayName, Location
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">WHERE</span>  DownVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-comment">-- AND UpVotes &gt; 100</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DownVotes, UpVotes
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* LET&#x27;S MIX THINGS UP: 
You&#x27;ve created a few indexes so far. Pick one of them, and write 3 queries:

* One that will scan the index (and only that index, not touching any others)
* Write a query that will do an index seek (but again, not touching any others)
* Write a query that will use that index, but then get a residual predicate
(Reminder: that&#x27;s a query that uses the index to do a seek, but then has to
do an additional filter, like maybe going over to the clustered index to do a
key lookup, and do additional filtering there)
*/</span>
<span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Location_INCLUDE_DisplayName_Id
<span class="hljs-keyword">ON</span> dbo.Users(Reputation, Location)
INCLUDE (DisplatName, ID)		

<span class="hljs-comment">-- Index Scan</span>
<span class="hljs-keyword">SELECT</span>
	Reputation, Location, DisplatName, Id
<span class="hljs-keyword">FROM</span> dbo.Users

<span class="hljs-comment">-- Index Seek		</span>
<span class="hljs-keyword">SELECT</span>
	Reputation, Location, DisplatName, Id
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> 
	Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">130000</span>	

<span class="hljs-comment">-- Index Seek + Predicate</span>
<span class="hljs-keyword">SELECT</span>
	Reputation, Location, DisplatName, Id
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> 
	Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">130000</span>	
<span class="hljs-keyword">AND</span> Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Arizona&#x27;</span>

<span class="hljs-comment">-- Brent took</span>
    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Location
    <span class="hljs-keyword">ON</span> dbo.Users(Reputation, Location)
	INCLUDE (DisplayName)

    <span class="hljs-comment">-- Question 1</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(DisplayName)
    <span class="hljs-keyword">FROM</span>  dbo.Users

    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> Reputation, Location, DisplatName, iD
    <span class="hljs-keyword">FROM</span>  dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation, Location        

    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> Reputation, Location, DisplatName, iD
    <span class="hljs-keyword">FROM</span>  dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>, Location <span class="hljs-keyword">DESC</span>

    <span class="hljs-comment">-- Question 2</span>
    <span class="hljs-keyword">SELECT</span> Reputation, Location, DisplayName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">WHERE</span>  Reputation <span class="hljs-operator">=</span> <span class="hljs-number">8765309</span>

    <span class="hljs-comment">-- Question 3</span>
    <span class="hljs-keyword">SELECT</span> Reputation, Location, DisplayName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">WHERE</span>  Reputation <span class="hljs-operator">=</span> <span class="hljs-number">12345</span>
    <span class="hljs-keyword">AND</span>    DisplayName <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Brent Ozar&#x27;</span>

    <span class="hljs-keyword">SELECT</span> Reputation, Location, DisplayName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">WHERE</span>  Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span>    DisplayName <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Brent Ozar&#x27;</span>
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* NEXT UP: find people who match an unusual filter: */</span>
<span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Moscow, Russia&#x27;</span>
    <span class="hljs-keyword">OR</span> DisplayName <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;Dmitry%&#x27;</span>;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
(<span class="hljs-number">4311</span> <span class="hljs-keyword">rows</span> affected)
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>, physical <span class="hljs-keyword">reads</span> <span class="hljs-number">3</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?

<span class="hljs-comment">/*REPONSE:*/</span> 
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Moscow, Russia&#x27;</span>
    <span class="hljs-keyword">SELECT</span> (<span class="hljs-number">3021</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2465713</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.12</span><span class="hljs-operator">%</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> DisplayName <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;Dmitry%&#x27;</span>
    <span class="hljs-keyword">SELECT</span> (<span class="hljs-number">1346</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2465713</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.05</span><span class="hljs-operator">%</span>

<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_Location_DisplayName_Inclu_Reputation
    <span class="hljs-keyword">ON</span> dbo.Users (Location, DisplayName)
    INCLUDE (Reputation, Id)

    <span class="hljs-keyword">CREATE</span> INDEX IX_DisplayName_Location__Inclu_Reputation
    <span class="hljs-keyword">ON</span> dbo.Users (DisplayName, Location)
    INCLUDE (Reputation, Id)

<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

    <span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
    <span class="hljs-keyword">FROM</span>  dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
    <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Moscow, Russia&#x27;</span>
    <span class="hljs-keyword">OR</span> DisplayName <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;Dmitry%&#x27;</span>;

    <span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
    <span class="hljs-keyword">FROM</span>  dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_Location_DisplayName_Inclu_Reputation)
    <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Moscow, Russia&#x27;</span>
    <span class="hljs-keyword">OR</span> DisplayName <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;Dmitry%&#x27;</span>;

    <span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
    <span class="hljs-keyword">FROM</span>  dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_DisplayName_Location__Inclu_Reputation)
    <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Moscow, Russia&#x27;</span>
    <span class="hljs-keyword">OR</span> DisplayName <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;Dmitry%&#x27;</span>;

    <span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
    <span class="hljs-keyword">FROM</span>  dbo.Users 
    <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Moscow, Russia&#x27;</span>
    <span class="hljs-keyword">OR</span> DisplayName <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;Dmitry%&#x27;</span>;
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">14068</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">13600</span>

    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Worktable&#x27;</span>. Scan count <span class="hljs-number">0</span>, logical <span class="hljs-keyword">reads</span>  <span class="hljs-number">0</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.     Scan count <span class="hljs-number">2</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44</span>

<span class="hljs-number">4.</span> VISUALIZATION INDEX
    <span class="hljs-comment">-- INDEX 1 PK</span>
    <span class="hljs-keyword">SELECT</span> Id
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-comment">-- where id &gt; 1000</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id

    <span class="hljs-comment">-- INDEX 2 IX_Location_DisplayName_Inclu_Reputation</span>
    <span class="hljs-keyword">SELECT</span> Location, DisplayName, DisplatName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Moscow, Russia&#x27;</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Location, DisplayName, DisplatName, Id

    <span class="hljs-comment">-- INDEX 3 IX_DisplayName_Location__Inclu_Reputation</span>
    <span class="hljs-keyword">SELECT</span> DisplayName, Location, DisplatName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users
    <span class="hljs-keyword">WHERE</span> DisplayName <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;Dmitry%&#x27;</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName, Location, DisplatName, Id

<span class="hljs-comment">-- Brent Ozar</span>
<span class="hljs-keyword">CREATE</span> INDEX IX_Location <span class="hljs-keyword">ON</span> dbo.Users(Location) INCLUDE (DisplayName, Reputation)
<span class="hljs-keyword">CREATE</span> INDEX IX_DisplayName <span class="hljs-keyword">ON</span> dbo.Users(DisplayNAme) INCLUDE (Location, Reputation)
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* NEXT QUESTION: design the right index to find all of the people who created an account, but then never accessed the system again:  */</span>
<span class="hljs-keyword">SELECT</span> CreationDate, LastAccessDate, DisplatName, Id
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">=</span> LastAccessDate;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
(<span class="hljs-number">171516</span> <span class="hljs-keyword">rows</span> affected)
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?

<span class="hljs-comment">/*REPONSE:*/</span> 
<span class="hljs-number">5.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">=</span> LastAccessDate;
    <span class="hljs-keyword">SELECT</span> (<span class="hljs-number">171516</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2465713</span> <span class="hljs-operator">=</span> <span class="hljs-number">6.9</span><span class="hljs-operator">%</span>

<span class="hljs-number">6.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_CreationDate_Inl_LastAccessDate_DisplayName_Id
    <span class="hljs-keyword">ON</span> dbo.Users (CreationDate)
    INCLUDE (LastAccessDate, DisplatName, Id)

    <span class="hljs-keyword">CREATE</span> INDEX IX_LastAccessDate_Inl_CreationDate_DisplayName_Id
    <span class="hljs-keyword">ON</span> dbo.Users (LastAccessDate)
    INCLUDE (CreationDate, DisplatName, Id)

<span class="hljs-number">7.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

    <span class="hljs-keyword">SELECT</span> CreationDate, LastAccessDate, DisplatName, Id
    <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
    <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">=</span> LastAccessDate;
    GO

    <span class="hljs-keyword">SELECT</span> CreationDate, LastAccessDate, DisplatName, Id
    <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_CreationDate_Inl_LastAccessDate_DisplayName_Id)
    <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">=</span> LastAccessDate;
    GO

    <span class="hljs-keyword">SELECT</span> CreationDate, LastAccessDate, DisplatName, Id
    <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_LastAccessDate_Inl_CreationDate_DisplayName_Id)
    <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">=</span> LastAccessDate;
    GO

    <span class="hljs-keyword">SELECT</span> CreationDate, LastAccessDate, DisplatName, Id
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">=</span> LastAccessDate;
    GO
    <span class="hljs-comment">-----------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">15060</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">15060</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">15060</span>

<span class="hljs-number">8.</span> VISUALIZATION INDEX
    <span class="hljs-keyword">SELECT</span> CreationDate, LastAccessDate, DisplatName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users    
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-comment">-- , LastAccessDate, DisplatName, Id</span>

    <span class="hljs-keyword">SELECT</span> CreationDate, LastAccessDate, DisplatName, Id
    <span class="hljs-keyword">FROM</span>   dbo.Users 
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> LastAccessDate <span class="hljs-comment">-- , CreationDate , DisplatName, Id</span>

<span class="hljs-comment">-- Brent Ozar</span>
<span class="hljs-comment">-- Any index that has the CreationDate and LastAccessDate is going to be okay because the</span>
<span class="hljs-comment">-- order is not helpfull here.</span>
<span class="hljs-keyword">CREATE</span> INDEX DsiplayName <span class="hljs-keyword">ON</span> dbo.Users(DisplayName) INCLUDE(CreationDate, LastAccessDate)
</code></pre>
<pre><code class="language-sql">
<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
<span class="hljs-keyword">SELECT</span> CreationDate, DisplayName, Location
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>
    <span class="hljs-keyword">AND</span> CreationDate <span class="hljs-operator">&lt;</span> <span class="hljs-string">&#x27;2009-01-02&#x27;</span>
    <span class="hljs-keyword">AND</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?

<span class="hljs-comment">/*REPONSE:*/</span> 
<span class="hljs-number">9.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>
    <span class="hljs-keyword">SELECT</span> (<span class="hljs-number">2444024</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2465713</span> <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">&lt;</span>  <span class="hljs-string">&#x27;2009-01-02&#x27;</span>
    <span class="hljs-keyword">SELECT</span> (<span class="hljs-number">21731</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2465713</span> <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Reputation   <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">SELECT</span> (<span class="hljs-number">1090043</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2465713</span> <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>

<span class="hljs-number">10.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_CreationDate_Reputation_Inc_DisplayName_Location
    <span class="hljs-keyword">ON</span> dbo.Users(CreationDate, Reputation)
    INCLUDE (DisplayName, Location)

    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_CreationDate_Inc_DisplayName_Location
    <span class="hljs-keyword">ON</span> dbo.Users(Reputation, CreationDate)
    INCLUDE (DisplayName, Location)

<span class="hljs-number">11.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

    <span class="hljs-keyword">SELECT</span> CreationDate, DisplayName, Location
    <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
    <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>
        <span class="hljs-keyword">AND</span> CreationDate <span class="hljs-operator">&lt;</span> <span class="hljs-string">&#x27;2009-01-02&#x27;</span>
        <span class="hljs-keyword">AND</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    GO

    <span class="hljs-keyword">SELECT</span> CreationDate, DisplayName, Location
    <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_CreationDate_Reputation_Inc_DisplayName_Location)
    <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>
        <span class="hljs-keyword">AND</span> CreationDate <span class="hljs-operator">&lt;</span> <span class="hljs-string">&#x27;2009-01-02&#x27;</span>
        <span class="hljs-keyword">AND</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    GO

    <span class="hljs-keyword">SELECT</span> CreationDate, DisplayName, Location
    <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_Reputation_CreationDate_Inc_DisplayName_Location)
    <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>
        <span class="hljs-keyword">AND</span> CreationDate <span class="hljs-operator">&lt;</span> <span class="hljs-string">&#x27;2009-01-02&#x27;</span>
        <span class="hljs-keyword">AND</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    GO

    <span class="hljs-keyword">SELECT</span> CreationDate, DisplayName, Location
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">WHERE</span> CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>
        <span class="hljs-keyword">AND</span> CreationDate <span class="hljs-operator">&lt;</span> <span class="hljs-string">&#x27;2009-01-02&#x27;</span>
        <span class="hljs-keyword">AND</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    GO        
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">5</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">3</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">3</span>

<span class="hljs-number">12.</span> VISUALIZATION INDEX

</code></pre>
</li>
</ul>
<h2 id="order-by">ORDER BY</h2>
<ul>
<li>
<p>After 2 Equality searches
With equality search is on the WHERE put the ORDER BY on the KEY INDEX, at the end.</p>
<pre><code class="language-sql"><span class="hljs-comment">/* Bring some order around here. */</span>
<span class="hljs-keyword">SELECT</span> Id, DisplayName, Location
<span class="hljs-keyword">FROM</span>   dbo.Users
<span class="hljs-keyword">WHERE</span>  DisplayName <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;alex&#x27;</span>
<span class="hljs-keyword">AND</span>    Location    <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Seattle, WA&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation;

<span class="hljs-comment">/* Think back to your 2 earlier indexes */</span>
<span class="hljs-keyword">CREATE</span> INDEX IX_DisplayName_LocationON dbo.Users(DisplayName, Location);
<span class="hljs-keyword">CREATE</span> INDEX IX_Location_DisplayNameON dbo.Users(Location, DisplayName);

<span class="hljs-comment">/* Add new versions with Reputation */</span>
<span class="hljs-keyword">CREATE</span> INDEX IX_DisplayName_Location_Reputation <span class="hljs-keyword">ON</span> dbo.Users(DisplayName, Location, Reputation);
<span class="hljs-keyword">CREATE</span> INDEX IX_Location_DisplayName_Reputation <span class="hljs-keyword">ON</span> dbo.Users(Location, DisplayName, Reputation);
<span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_DisplayName_Location <span class="hljs-keyword">ON</span> dbo.Users(Reputation, DisplayName, Location);
</code></pre>
<p>Test them
<img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\ORDERBy_1.png" alt="alt text"></p>
<p>Survey says...
Index                                   Logical Reads   Total Pages in the Index
Clustered index (white pages)           45,184          45,184
IX_DisplayName_Location_Reputation           4          13,995
IX_Location_DisplayName_Reputation           4          14,486
IX_Reputation_DisplayName_Location      13,996          13,996</p>
<p>Ouch. Putting reputation first meant no seeking  at all, and we scanned the whole thing. (Still better than a table scan though.)</p>
</li>
<li>
<p>After an InEquality seraches
Let’s go anywhere BUT Seattle</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> Id, DisplayName, Location
<span class="hljs-keyword">FROM</span>   dbo.Users
<span class="hljs-keyword">WHERE</span>  DisplayName <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;alex&#x27;</span>
<span class="hljs-keyword">AND</span>    Location   <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;Seattle, WA&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation;
</code></pre>
<p>What’s the perfect index for this?, How selective is each part of the filter?</p>
<p>Survey says...
Index                               Logical Reads   Total Pages in the Index
Clustered index (white pages)       45,184          45,184
IX_DisplayName_Location_Reputation      13          13,995
IX_Location_DisplayName_Reputation   4,864          14,486
IX_Reputation_DisplayName_Location  13,996          13,996</p>
<p>Ouch. Putting reputation first meant no seeking at all, and we scanned the whole thing. (Still better than a table scan though.)</p>
<p>So the perfect index for it:</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> Id, DisplayName, Location
<span class="hljs-keyword">FROM</span>   dbo.Users
<span class="hljs-keyword">WHERE</span>  DisplayName <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;alex&#x27;</span>
<span class="hljs-keyword">AND</span>    Location   <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;Seattle, WA&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation;

<span class="hljs-keyword">CREATE</span> INDEX IX_DisplayName_Location_Reputation <span class="hljs-keyword">ON</span> 
dbo.Users(DisplayName, Location, Reputation);
</code></pre>
<p>Step 1: Seek to Alex
Step 2: Scan through, returning everyone EXCEPT Seattle
Step 3: Read them out sorted by Reputation, except...they are not.</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\ORDERBy_2.png" alt="alt text"></p>
<p>Write a query to visualize the INDEX</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> DisplayName, Location, Reputation, Id
<span class="hljs-keyword">FROM</span> dbo.USers
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName, Location, Reputation;
</code></pre>
<p>Reputation isn’t sorted. We’re going to skip everyone who isn’t in Seattle. That means we need all the Alexes on this screen, plus more. And they’re not sorted by
Reputation. The fact that Reputation is “sorted” isn’t helping here</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\ORDERBy_3.png" alt="alt text"></p>
<p>To prove it, create another index:</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> INDEX IX_DisplayName_Location_Reputation <span class="hljs-keyword">ON</span> dbo.Users (DisplayName, Location, Reputation);
<span class="hljs-keyword">CREATE</span> INDEX IX_DisplayName_Location_Includes   <span class="hljs-keyword">ON</span> dbo.Users (DisplayName, Location) INCLUDE (Reputation);
</code></pre>
<p>They both get the same plan. Use an index hint to test both indexes separately. Both do the sort. And both have the same number of logical reads.</p>
<p><r>Inequality searches make it tricky.</r>
WHERE DisplayName = 'alex'
AND Location &lt;&gt;'Seattle, WA'
ORDER BY Reputation;</p>
<p>After you do an inequality search on a field, the sorting of subsequent fields in the index are usually less useful. (That’s a mouthful.)</p>
<p>You have to move the ORDER BY up into the Key of the Index
<img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\ORDERBy_4.png" alt="alt text"></p>
<p><r>The sort is gone with this trick. Obscure trick. To get it, key on:</r>
<r>1. Equality fields, then</r>
<r>2. Sort fields, then</r>
<r>3. Inequality fields</r></p>
<ul>
<li>What we have learned so far:</li>
</ul>
<ol>
<li>Indexes helps pre-sorting rows to prep them for:
<ol>
<li>WHERE   : finding the rows we want</li>
<li>ORDER BY: sorting them on the way out the door</li>
<li>GROUP BY: FROM , JOINs, CTEs</li>
</ol>
</li>
<li>TRICK
Key on
<ol>
<li>EQUALITY fields, then</li>
<li>SORT Fields, then</li>
<li>INEQUALITY fields</li>
</ol>
</li>
</ol>
</li>
</ul>
<h2 id="top">TOP</h2>
<ul>
<li>
<p>Design and index for this:</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> Id, Reputation, CreationDate
<span class="hljs-keyword">FROM</span>  dbo.Users
<span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">ASC</span>;
</code></pre>
<p>Which field should we lead with?</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> Id, Reputation, CreationDate
<span class="hljs-keyword">FROM</span>   dbo.Users
<span class="hljs-keyword">WHERE</span>  Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">ASC</span>;

<span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_CreationDate <span class="hljs-keyword">ON</span> dbo.Users(Reputation  , CreationDate);
<span class="hljs-keyword">CREATE</span> INDEX IX_CreationDate_Reputation <span class="hljs-keyword">ON</span> dbo.Users(CreationDate, Reputation  );
</code></pre>
<p>If we lead with Reputation...
We seek to 2, but then we find 1.4M users that match! We have to sort ‘em all by CreationDate.</p>
<p>Visualize the index contents.
When the index is on Reputation, CreationDate, we can seek to 2, but...are the first 10 users we find the lowest CreationDates overall?
Or just the lowest for Reputation = 2?</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> Reputation, CreationDate, Id
<span class="hljs-keyword">FROM</span>   dbo.Users
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation, CreationDate;
</code></pre>
<p>It’s more obvious when we page down to higher Reputation numbers. The CreationDate keeps resetting with each new Reputation. The sort on the second field is less useful when we’re scanning.</p>
<p>What if we lead with CreationDate?
We “scan” the index, but... Remember from How to Think Like the Engine: scan just means we start at one end of the index, and we read until we find the rows that match.
And there’s no sort! The data is already sorted.</p>
<p>Visualize the index contents
When the index is on CreationDate, Reputation, we start reading, looking for 100 users with Reputation &gt; 1.
They almost all match! As soon as we read 100 rows that match, we’re done. No need to scan the whole index.</p>
<p>Survey says...
Index                           Logical Reads       Total Pages in the Index
Clustered index (white pages)   45,184              45,184
IX_Reputation_CreationDate       3,805               6,812
IX_CreationDate_Reputation           3               6,817</p>
<p>In this case, the ORDER BY field should go first in the index</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> Id, Reputation, CreationDate
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">ASC</span>;

<span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_CreationDate <span class="hljs-keyword">ON</span> dbo.Users(Reputation, CreationDate);
<span class="hljs-keyword">CREATE</span> INDEX IX_CreationDate_Reputation <span class="hljs-keyword">ON</span> dbo.Users(CreationDate, Reputation);
</code></pre>
<p>Remember SELECTIVITY. TOP is kinda like a WHERE clause:</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> ID, Reputation, CreationDate
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> (users <span class="hljs-keyword">is</span> <span class="hljs-keyword">in</span> the top <span class="hljs-number">100</span>) <span class="hljs-keyword">by</span> CreationDate;

DropIndexes;
<span class="hljs-keyword">CREATE</span> INDEX IX_CreationDate_Reputation
<span class="hljs-keyword">ON</span> dbo.Users(CreationDate, Reputation);
</code></pre>
<p>Now run this.</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> Id, Reputation, CreationDate
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000000</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">ASC</span>;
</code></pre>
<p>There aren’t a lot of rows with Reputation &gt; 1,000,000.</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\ORDERBy_5.png" alt="alt text"></p>
<p>Jon Skeet isn’t in the first 100.</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> Id, Reputation, CreationDate
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000000</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">ASC</span>;
</code></pre>
<p>The TOP 100 by CreationDate is only selective IF the person you’re looking for is in that list. In this case, WHERE Reputation &gt; 1000000 is much more selective – that should go first.</p>
</li>
<li>
<p>RECAP
If your WHERE clause is filtering just for equalities, then add the ORDER BY fields into the index key, and the index will handle all the sorting for you.
Out here in the real world, though, your query will have a mix of equality and inequalities.
Different parameter values affect key order too.
Our goal: get a good enough combination of keys to cover as many queries as practical.</p>
</li>
<li>
<p>LAB 4</p>
<pre><code class="language-sql"><span class="hljs-comment">/* FIRST LAB CHALLENGE: design the right index for this:*/</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> DisplayName, Location, WebsiteUrl, Reputation, Id
<span class="hljs-keyword">FROM</span>  dbo.Users
<span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-keyword">AND</span>   WebsiteUrl <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">9</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">45184</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
	<span class="hljs-keyword">In</span> this <span class="hljs-keyword">case</span> it does <span class="hljs-keyword">not</span> matter, because the <span class="hljs-keyword">WHERE</span> clause <span class="hljs-keyword">is</span> an EQUALITY <span class="hljs-keyword">WHERE</span> clause<span class="hljs-operator">!</span><span class="hljs-operator">!</span>
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?
	WebsiteUrl <span class="hljs-keyword">is</span> more selective

<span class="hljs-comment">/*REPONSE:*/</span>
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
	 <span class="hljs-operator">=</span> <span class="hljs-number">572362</span>   records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>
    
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> WebsiteUrl <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
	 <span class="hljs-operator">=</span> <span class="hljs-number">339977</span>   records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>

<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_WebsiteURL_Location_Reputation_INC_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users (WebsiteURL, Location, Reputation) INCLUDE (DisplayName)

    <span class="hljs-keyword">CREATE</span> INDEX IX_Location_WebsiteURL_Reputation_INC_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users (Location, WebsiteURL, Reputation) INCLUDE (DisplayName)

    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Location_WebsiteURL_INC_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users (Reputation, WebsiteURL, Location) INCLUDE (DisplayName)

    <span class="hljs-comment">-- B.O.</span>
    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Location_WebsiteURL_INC_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users (Reputation) INCLUDE (Location, WebsiteURL, DisplayName)

<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

	<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> DisplayName, Location, WebsiteUrl, Reputation, Id
    <span class="hljs-keyword">FROM</span>  dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
    <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
    <span class="hljs-keyword">AND</span>   WebsiteUrl <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>

    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> DisplayName, Location, WebsiteUrl, Reputation, Id
    <span class="hljs-keyword">FROM</span>  dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_WebsiteURL_Location_Reputation_INC_DisplayName)
    <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
    <span class="hljs-keyword">AND</span>   WebsiteUrl <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>

    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> DisplayName, Location, WebsiteUrl, Reputation, Id
    <span class="hljs-keyword">FROM</span>  dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_Location_WebsiteURL_Reputation_INC_DisplayName)
    <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
    <span class="hljs-keyword">AND</span>   WebsiteUrl <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>

    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> DisplayName, Location, WebsiteUrl, Reputation, Id
    <span class="hljs-keyword">FROM</span>  dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_Reputation_Location_WebsiteURL_INC_DisplayName)
    <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
    <span class="hljs-keyword">AND</span>   WebsiteUrl <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>

    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> DisplayName, Location, WebsiteUrl, Reputation, Id
    <span class="hljs-keyword">FROM</span>  dbo.Users 
    <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
    <span class="hljs-keyword">AND</span>   WebsiteUrl <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">&#x27;&#x27;</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">9</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">45184</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">2</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">4860</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">2</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">6552</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">40</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">40</span>

<span class="hljs-number">4.</span> VISUALIZATION INDEX
    <span class="hljs-keyword">SELECT</span> WebsiteURL, Location, Reputation, DisplayName
    <span class="hljs-keyword">FROM</span> dbo.Users 
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> WebsiteURL, Location, Reputation

    <span class="hljs-keyword">SELECT</span> Location, WebsiteURL, Reputation, DisplayName
    <span class="hljs-keyword">FROM</span> dbo.Users 
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Location, WebsiteURL, Reputation

    <span class="hljs-keyword">SELECT</span> Reputation, WebsiteURL, Location, DisplayName
    <span class="hljs-keyword">FROM</span> dbo.Users 
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation, WebsiteURL, Location

</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* NEXT UP: We want to start encouraging people to review other folks&#x27; work and upvote it. 
To do that, let&#x27;s find the most recently created users who haven&#x27;t cast an UpVote yet. 
Then, build the right index for it. You write the query. Go for it! */</span>

<span class="hljs-keyword">SELECT</span> Id, CreationDate, DisplayName, UpVotes  
<span class="hljs-keyword">FROM</span>   dbo.Users
<span class="hljs-keyword">WHERE</span>  UpVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">DESC</span>

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
	<span class="hljs-keyword">In</span> this <span class="hljs-keyword">case</span> it does <span class="hljs-keyword">not</span> matter, because the <span class="hljs-keyword">WHERE</span> clause <span class="hljs-keyword">is</span> an EQUALITY <span class="hljs-keyword">WHERE</span> clause<span class="hljs-operator">!</span><span class="hljs-operator">!</span>
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?
	WebsiteUrl <span class="hljs-keyword">is</span> more selective

<span class="hljs-comment">/*REPONSE:*/</span>
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> UpVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
	 <span class="hljs-operator">=</span> <span class="hljs-number">572362</span>   records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>

    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">DESC</span>
	 <span class="hljs-operator">=</span> <span class="hljs-number">572362</span>   records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>

<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_UpVotes_CreationDate_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users(UpVotes, CreationDate)
    INCLUDE (DisplayName)

    <span class="hljs-keyword">CREATE</span> INDEX IX_CreationDate_UpVotes_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users(CreationDate, UpVotes)
    INCLUDE (DisplayName)

    <span class="hljs-comment">-- B.O.</span>
    <span class="hljs-keyword">CREATE</span> INDEX IX_CreationDate_UpVotes_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users(CreationDate)
    INCLUDE (UpVotes)

    <span class="hljs-keyword">CREATE</span> INDEX IX_CreationDate_UpVotes_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users(UpVotes, CreationDate)

<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

	<span class="hljs-keyword">SELECT</span> Id, CreationDate, DisplayName, UpVotes  
    <span class="hljs-keyword">FROM</span>   dbo.Users <span class="hljs-keyword">WITH</span> (INDEX <span class="hljs-operator">=</span> <span class="hljs-number">1</span>)
    <span class="hljs-keyword">WHERE</span>  UpVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">DESC</span>

    <span class="hljs-keyword">SELECT</span> Id, CreationDate, DisplayName, UpVotes  
    <span class="hljs-keyword">FROM</span>   dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_UpVotes_CreationDate_DisplayName)
    <span class="hljs-keyword">WHERE</span>  UpVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">DESC</span>

    <span class="hljs-keyword">SELECT</span> Id, CreationDate, DisplayName, UpVotes  
    <span class="hljs-keyword">FROM</span>   dbo.Users <span class="hljs-keyword">WITH</span>(INDEX <span class="hljs-operator">=</span> IX_CreationDate_UpVotes_DisplayName)
    <span class="hljs-keyword">WHERE</span>  UpVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">DESC</span>

    <span class="hljs-keyword">SELECT</span> Id, CreationDate, DisplayName, UpVotes  
    <span class="hljs-keyword">FROM</span>   dbo.Users 
    <span class="hljs-keyword">WHERE</span>  UpVotes <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate <span class="hljs-keyword">DESC</span>
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">9</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">45184</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">10095</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">13839</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">10095</span>

<span class="hljs-number">4.</span> VISUALIZATION INDEX
    <span class="hljs-keyword">SELECT</span> UpVotes, CreationDate, DisplayName
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> UpVotes, CreationDate, DisplayName

    <span class="hljs-keyword">SELECT</span> CreationDate, UpVotes, DisplayName
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> CreationDate, UpVotes, DisplayName
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* NEXT CHALLENGE: User Id #22656 is lonely. Let&#x27;s build a dating service query to find all of the people who live in his country. 
   He&#x27;ll probably want to find friendly people, so let&#x27;s filter for a few things: */</span>
<span class="hljs-keyword">SELECT</span> DisplayName, Location, Reputation, WebsiteUrl, Id
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Age <span class="hljs-operator">&gt;</span> <span class="hljs-number">21</span>
    <span class="hljs-keyword">AND</span> (Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%United Kingdom%&#x27;</span> <span class="hljs-keyword">OR</span> Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%UK%&#x27;</span>)
    <span class="hljs-keyword">AND</span> DownVotes <span class="hljs-operator">&lt;</span> <span class="hljs-number">1000</span>
    <span class="hljs-keyword">AND</span> UpVotes <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>, Location;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?

<span class="hljs-comment">/*REPONSE:*/</span>
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Age <span class="hljs-operator">&gt;</span> <span class="hljs-number">21</span>
     <span class="hljs-operator">=</span> <span class="hljs-number">0</span>   records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%United Kingdom%&#x27;</span>
     <span class="hljs-operator">=</span> <span class="hljs-number">28719</span>   records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Location <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%UK%&#x27;</span>
     <span class="hljs-operator">=</span> <span class="hljs-number">12118</span>   records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>

    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> DownVotes <span class="hljs-operator">&lt;</span> <span class="hljs-number">1000</span>
     <span class="hljs-operator">=</span> <span class="hljs-number">2464327</span>   records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>
    
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> UpVotes   <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>
     <span class="hljs-operator">=</span> <span class="hljs-number">621154</span>   records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>

<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_Age_Location_UpVotes_DownVotes_Reputation_INC_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users(Age, Location, UpVotes, DownVotes, Reputation) INCLUDE (DisplayName, WebsiteUrl)

    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Age_Location_UpVotes_DownVotes_INC_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users(Reputation, Age, Location, UpVotes, DownVotes) INCLUDE (DisplayName, WebsiteUrl)

    <span class="hljs-keyword">CREATE</span> INDEX IX_Reputation_Location_Age_UpVotes_DownVotes_INC_DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users(Reputation, Location, Age, UpVotes, DownVotes) INCLUDE (DisplayName, WebsiteUrl)

    <span class="hljs-keyword">CREATE</span> INDEX IX_Age_INC_Location_UpVotes_DownVotes_Reputation__DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users(Age) INCLUDE (Location, UpVotes, DownVotes, Reputation, DisplayName, WebsiteUrl)

    <span class="hljs-comment">-- B.O.</span>
    <span class="hljs-keyword">CREATE</span> INDEX IX_Age_INC_Location_UpVotes_DownVotes_Reputation__DisplayName
    <span class="hljs-keyword">ON</span> dbo.Users(Age)

<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

    IX_Age_Location_UpVotes_DownVotes_Reputation_INC_DisplayName
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">3</span>

<span class="hljs-number">4.</span> VISUALIZATION INDEX
    <span class="hljs-keyword">SELECT</span> Age, Location, UpVotes, DownVotes, Reputation, DisplayName, WebsiteUrl
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation, Age, Location, UpVotes, DownVotes, DisplayName, WebsiteUrl

    <span class="hljs-keyword">SELECT</span> Reputation, Age, Location, UpVotes, DownVotes, DisplayName, WebsiteUrl
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation, Age, Location, UpVotes, DownVotes, DisplayName, WebsiteUrl

    <span class="hljs-keyword">SELECT</span> Reputation, Location, Age, UpVotes, DownVotes, DisplayName, WebsiteUrl
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation, Location, Age, UpVotes, DownVotes, DisplayName, WebsiteUrl

    <span class="hljs-keyword">SELECT</span> Age, Location, UpVotes, DownVotes, Reputation, DisplayName, WebsiteUrl
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Age, Location, UpVotes, DownVotes, Reputation, DisplayName, WebsiteUrl
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* NEXT CHALLENGE: User Id #22656 is lonely. Let&#x27;s build a dating service query to find all of the people who live in his country. 
   He&#x27;ll probably want to find friendly people, so let&#x27;s filter for a few things: */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> CreationDate, LastAccessDate, DisplayName, Reputation, Id
<span class="hljs-keyword">FROM</span>    dbo.Users
<span class="hljs-keyword">WHERE</span>   CreationDate <span class="hljs-operator">=</span> LastAccessDate
<span class="hljs-keyword">AND</span>     Reputation <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">9</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">45184</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?

<span class="hljs-comment">/*REPONSE:*/</span>
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> 
     <span class="hljs-operator">=</span>    records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>

<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> NONCLUSTERED INDEX [<span class="hljs-operator">&lt;</span>Name <span class="hljs-keyword">of</span> Missing Index, sysname,<span class="hljs-operator">&gt;</span>]
    <span class="hljs-keyword">ON</span> [dbo].[Users] ([Reputation])
    INCLUDE ([CreationDate],[DisplayName],[LastAccessDate])
    GO
    
<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>
    
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> CreationDate, LastAccessDate, DisplayName, Reputation, Id
    <span class="hljs-keyword">FROM</span>    dbo.Users
    <span class="hljs-keyword">WHERE</span>   CreationDate <span class="hljs-operator">=</span> LastAccessDate
    <span class="hljs-keyword">AND</span>     Reputation <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>;
    GO
    
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">595</span>

<span class="hljs-number">4.</span> VISUALIZATION INDEX
    <span class="hljs-keyword">SELECT</span> Reputation, CreationDate,DisplayName,LastAccessDate
    <span class="hljs-keyword">FROM</span> dbo.Users
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>
</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* BONUS QUESTION: you&#x27;ve created a few indexes so far. Now, looking at those indexes, try to craft a query that could 
maybe use those indexes, but won&#x27;t. For example, try to write one where the index doesn&#x27;t quite cover, and make
SQL Server choose between an index seek + key lookup, versus a table scan, and choose your filters carefully to make 
SQL Server think it&#x27;s going to find so much data that it&#x27;s better off just scanning the clustered index instead.
*/</span>

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">9</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">45184</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?

<span class="hljs-comment">/*REPONSE:*/</span>
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> 
     <span class="hljs-operator">=</span>    records <span class="hljs-operator">/</span> AVG <span class="hljs-number">2465713</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-operator">%</span> <span class="hljs-number">105</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0.004</span>

<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    
    
<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>
    
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">595</span>

<span class="hljs-number">4.</span> VISUALIZATION INDEX
    
</code></pre>
</li>
</ul>
<h2 id="joins">JOINs</h2>
<ul>
<li>
<p>One Join (never in the real life)
Show everyone’s comments</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> u.DisplayName, c.CreationDate, c.Text
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Comments c
<span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> c.UserId;
</code></pre>
<p>Don’t run this. It’ll take forever. And in reality, you’d never write this query. Just get the estimated plan</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\JOIN_1.png" alt="alt text"></p>
<p>A more realistic query:</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> u.DisplayName, c.CreationDate, c.Text
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Comments c
<span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> c.UserId
<span class="hljs-keyword">WHERE</span> u.DisplayName <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Brent Ozar&#x27;</span>;
</code></pre>
<p>Run this, get the actual plan, and add indexes to make it faster.</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\JOIN_2.png" alt="alt text"></p>
<p>These two indexes will help:</p>
<pre><code class="language-SQL"><span class="hljs-keyword">CREATE</span> INDEX IX_DisplayName <span class="hljs-keyword">ON</span> dbo.Users(DisplayName);
<span class="hljs-keyword">CREATE</span> INDEX IX_UserId <span class="hljs-keyword">ON</span> dbo.Comments(UserId);
</code></pre>
<p>Note that Clippy only suggested one index. (He ain’t perfect. More on that later.) Also note that I didn’t include Comments.Text.</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\JOIN_3.png" alt="alt text"></p>
</li>
<li>
<p>JOIN + ORDER BY
That was a JOIN with a WHERE.</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> u.DisplayName, c.CreationDate, c.Text
<span class="hljs-keyword">FROM</span>   dbo.Users u
<span class="hljs-keyword">JOIN</span>   dbo.Comments c
<span class="hljs-keyword">ON</span>     u.Id <span class="hljs-operator">=</span> c.UserId
<span class="hljs-keyword">WHERE</span>  u.DisplayName <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Brent Ozar&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.CreationDate;
</code></pre>
<p>What’s the right index on Comments?
With our current indexes... The plan added this new sort. Can we remove this with an index?. NO</p>
<p>SQL Server already has its data. It already got all the data it needed from:</p>
<ol>
<li>The index seek on Comments.UserId</li>
<li>The key lookup on the Comments clustered index
It won’t go back later and use another index to support a sort. It’s gotta already be sorted after we get it.</li>
</ol>
<p>Phone book example
“Find all the businesses that start with Smith%.”
“Then, alphabetize them by business type.”</p>
<p>Phone book example
“Find all the businesses that start with Smith%.”
First: use the white pages to find them.
“Then, alphabetize them by business type.”
Second: use the yellow pages to sort them?</p>
<p>Instead, change the existing index. We have an index on Comments.UserId. What if we just add CreationDate as a second key?</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> NONCLUSTERED IX_UserId_CreationDate
<span class="hljs-keyword">ON</span> dbo.Users(UserId_CreationDate,)
</code></pre>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\JOIN+ORDERBY_1.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\JOIN+ORDERBY_2.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\JOIN+ORDERBY_3.png" alt="alt text"></p>
<p>I love this query.
It’s a great, simple example of multiple challenges with indexing real-world queries:
• Filters
• Joins
• Ordering
It’s about experimentation and compromise.</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\JOIN+ORDERBY_4.png" alt="alt text"></p>
<p>And keep things in perspective:
Logical reads
Clustered indexes, filtering for Brent’s comments, order by CreationDate    1,079,417
Add index on Comments.UserId                                                   46,012
Add index on Users.DisplayName                                                    583
Tweak Comments.UserId index to also include CreationDate                          584</p>
<p>These are all huge improvements! Don’t get too hung up on the tiniest details.</p>
</li>
<li>
<p>MIXING JOINS AND FILTERS</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\MIXINGJOINSANDFILTERS_1.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\MIXINGJOINSANDFILTERS_2.png" alt="alt text"></p>
<p>But this opens a can of worms. In theory, how you write your query shouldn’t matter. In practice, it does:
<a href="http://michaeljswart.com/2013/01/joins-are-commutative-and-sql-server-knows-it/">http://michaeljswart.com/2013/01/joins-are-commutative-and-sql-server-knows-it/</a></p>
<p>The more complex your query becomes, the harder it is to figure out which operations should be done first. How the data comes out affects the next operation.</p>
</li>
<li>
<p>LOTS OF JOINS</p>
<p>Say I wanna find and render this comment at the bottom. I need:
• The question
• The answer
• The comment</p>
<p>Questions &amp; answers are both stored in dbo.Posts</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\LOTSOFJOINS_1.png" alt="alt text"></p>
<p>I’m filtering at both ends of the join:
• Users named Brent Ozar
• Questions titled “SQL Queries”</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\LOTSOFJOINS_2.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\LOTSOFJOINS_3.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\LOTSOFJOINS_4.png" alt="alt text"></p>
<ul>
<li>SELECTIVITY isavboutone more thing
How big is the forest?
SQL Server considers...
How big is the object we need to read?(Think number of 8KB pages, not rows or columns)
How selective are the query filters on this object?
When we read data out of this object, what order will it be in? Does that help the next operation?
(And much, much more.)</li>
</ul>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\LOTSOFJOINS_5.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\LOTSOFJOINS_6.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\LOTSOFJOINS_7.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\LOTSOFJOINS_8.png" alt="alt text"></p>
<p>What you thought would happen</p>
<ol>
<li>Find Questions where Title like ’SQL Queries%’</li>
<li>Find the Answers on those questions</li>
<li>Find the Comments on those answers</li>
<li>Look up the Users for each of those comments, and check to see if they’re Brent Ozar</li>
</ol>
<p>But that’s not what happened.</p>
<p>What actually happened
5. Find Questions where Title like ‘SQL Queries%’
Meanwhile, AT THE SAME TIME:
6. Find the users named Brent Ozar
7. Find the Comments they’ve left
8. Look up what Answers they were placed on
9. Then finally, join this to the SQL Query questions</p>
<p>Looking at the big picture
Logical Reads
Clustered index scans                       1,077,747
Add index on Posts.Title                    1,077,063
That, PLUS add index on Comments.UserId        46,600
That, PLUS add index on Users.DisplayName       1,165
Or what if we start over, and only add an index on Comments.UserId? 47,373</p>
<p><r>When you look at that query, your first instinct is probably to index the stuff in the WHERE clause. And that’s totally okay. That helps.</r>
<r>But indexing to support joins is super important too.</r></p>
<ul>
<li><r>Index your foreign keys</r>
That’s where this advice comes from. It’s not just about making it easier for SQL Server to enforce foreign key relationships (which helps too.) It’s also because you often join on these keys.</li>
</ul>
<p>It’s a good starting point when you have no idea what indexes to build on a table. It’s just not the finish line.</p>
</li>
<li>
<p>WHERE EXISTS</p>
<p>Exists is kinda like a join, too</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Antarctica&#x27;</span>
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">0</span> <span class="hljs-keyword">FROM</span> dbo.Comments c <span class="hljs-keyword">WHERE</span> u.Id <span class="hljs-operator">=</span> c.UserId)
</code></pre>
<p>What indexes do I need on these tables?</p>
<p>SQL Server’s thought process
“It’s easy for me to scan the small Users table and find all the few people in Antarctica.”
“However, once I’ve found their list of User Ids, it’s gonna be painful for me to scan the giant Comments table to find their comments.”
“The most efficient index would be on Comments.UserId.”</p>
<p>We created the index but then SQL request for another on Location.</p>
</li>
<li>
<p>RECAP
Joins are interesting.</p>
<ul>
<li>Joins are like filters: only show me the rows from Table1 that have a matching partner in Table2.</li>
<li>Their selectivity isn’t just about row count: also size.</li>
<li>Join operations can benefit from pre-sorting:
<ul>
<li>if I want to join two tables together, it can help if they’re already sorted in order.</li>
</ul>
</li>
<li>Join-supporting indexes radically change plan shape.</li>
</ul>
</li>
<li>
<p>LAB 6</p>
<pre><code class="language-sql"><span class="hljs-comment">/* THIS TIME, IT&#x27;S ALL YOU: you&#x27;ve learned a process, and now I&#x27;m going to leave it to you to work through the process.
You have one commandment though: you&#x27;re not allowed to index any &gt;200 byte fields, like NVARCHAR(500) or VARCHAR(500). 
Not allowed to use &#x27;em as includes, either. Here&#x27;s your first query: find the users in Antarctica, and list their highly
upvoted comments sorted from newest to oldest. */</span>
<span class="hljs-keyword">SELECT</span> u.DisplayName, u.Location, c.Score <span class="hljs-keyword">AS</span> CommentScore, c.Text <span class="hljs-keyword">AS</span> CommentText
<span class="hljs-keyword">FROM</span>  dbo.Users u
<span class="hljs-keyword">JOIN</span>  dbo.Comments c <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> c.UserId
<span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Antarctica&#x27;</span>
<span class="hljs-keyword">AND</span>   c.Score <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.CreationDate;
GO


<span class="hljs-comment">-- B.O</span>
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Antarctica&#x27;</span>
<span class="hljs-keyword">AND</span>   u.Id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> .....)

<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.USers <span class="hljs-keyword">WHERE</span> Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Antarctica&#x27;</span>

<span class="hljs-keyword">FROM</span> dbo.Comments c
<span class="hljs-keyword">WHERE</span> c.Score <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">AND</span>   cUserId <span class="hljs-keyword">IN</span> (<span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span> ....)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.CreationDate;

<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> dbo.Comments <span class="hljs-keyword">WHERE</span> Score <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>

<span class="hljs-keyword">CREATE</span> INDEX IX_UserId <span class="hljs-keyword">ON</span> dbo.Comments(UserId) INCLUDE(Score)

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.    Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>. Scan count <span class="hljs-number">9</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">1029372</span>, physical <span class="hljs-keyword">reads</span> <span class="hljs-number">298</span>


<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
	<span class="hljs-keyword">In</span> this <span class="hljs-keyword">case</span> it does <span class="hljs-keyword">not</span> matter, because the <span class="hljs-keyword">WHERE</span> clause <span class="hljs-keyword">is</span> an EQUALITY <span class="hljs-keyword">WHERE</span> clause<span class="hljs-operator">!</span><span class="hljs-operator">!</span>
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?
	WebsiteUrl <span class="hljs-keyword">is</span> more selective

<span class="hljs-comment">/*REPONSE:*/</span>
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY

<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_Location <span class="hljs-keyword">ON</span> dbo.Users(Location) INCLUDE (DisplayName)
    <span class="hljs-comment">-- CREATE INDEX IX_UserId ON dbo.Comments(UserId, Score) INCLUDE(CreationDate)</span>
    <span class="hljs-keyword">CREATE</span> INDEX IX_UserId <span class="hljs-keyword">ON</span> dbo.Comments(UserId) INCLUDE(Score) <span class="hljs-comment">-- From BO</span>

<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

    <span class="hljs-keyword">With</span> <span class="hljs-number">1</span> index (Comments)
    <span class="hljs-keyword">SELECT</span> u.DisplayName, u.Location
        , c.Score <span class="hljs-keyword">AS</span> CommentScore, c.Text <span class="hljs-keyword">AS</span> CommentText
    <span class="hljs-keyword">FROM</span>  dbo.Users u
    <span class="hljs-keyword">JOIN</span>  dbo.Comments c 
    <span class="hljs-keyword">ON</span>    u.Id <span class="hljs-operator">=</span> c.UserId
    <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Antarctica&#x27;</span>
    <span class="hljs-keyword">AND</span>   c.Score <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.CreationDate;
    GO

    <span class="hljs-operator">!</span>[alt text](image.png)

    <span class="hljs-keyword">With</span> <span class="hljs-number">2</span> indexes (Comments <span class="hljs-keyword">and</span> Users)
    <span class="hljs-keyword">SELECT</span> u.DisplayName, u.Location
        , c.Score <span class="hljs-keyword">AS</span> CommentScore, c.Text <span class="hljs-keyword">AS</span> CommentText
    <span class="hljs-keyword">FROM</span>  dbo.Users u
    <span class="hljs-keyword">JOIN</span>  dbo.Comments c
    <span class="hljs-keyword">ON</span>    u.Id <span class="hljs-operator">=</span> c.UserId
    <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Antarctica&#x27;</span>
    <span class="hljs-keyword">AND</span>   c.Score <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.CreationDate;
    GO

    <span class="hljs-operator">!</span>[alt text](image<span class="hljs-number">-1.</span>png)
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>. Scan count <span class="hljs-number">27</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">3057</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.    Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>

    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>. Scan count <span class="hljs-number">27</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">3030</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.    Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">3</span>
    

<span class="hljs-number">4.</span> VISUALIZATION INDEX

</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* NEXT CHALLENGE: take that same list of Antarctica comments, but now I also want to see the post that they 
commented on. I&#x27;m adding a join: */</span>
<span class="hljs-keyword">SELECT</span> u.DisplayName, u.Location, c.Score <span class="hljs-keyword">AS</span> CommentScore, c.Text <span class="hljs-keyword">AS</span> CommentText
<span class="hljs-keyword">FROM</span>  dbo.Users u
<span class="hljs-keyword">JOIN</span>  dbo.Comments c <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> c.UserId
<span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Antarctica&#x27;</span>
<span class="hljs-keyword">AND</span>   c.Score <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.CreationDate;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>. Scan count <span class="hljs-number">1</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">44530</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>. Scan count <span class="hljs-number">0</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">5574</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>. Scan count <span class="hljs-number">9</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">1029437</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
	<span class="hljs-keyword">In</span> this <span class="hljs-keyword">case</span> it does <span class="hljs-keyword">not</span> matter, because the <span class="hljs-keyword">WHERE</span> clause <span class="hljs-keyword">is</span> an EQUALITY <span class="hljs-keyword">WHERE</span> clause<span class="hljs-operator">!</span><span class="hljs-operator">!</span>
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?
	WebsiteUrl <span class="hljs-keyword">is</span> more selective

<span class="hljs-comment">/*REPONSE:*/</span>
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY


<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_Location <span class="hljs-keyword">ON</span> dbo.Users(Location) INCLUDE(DisplayName)
    <span class="hljs-keyword">CREATE</span> INDEX IX_UserId_Score <span class="hljs-keyword">ON</span> dbo.Comments(UserID, Score) INCLUDE(CreationDate)
    <span class="hljs-keyword">CREATE</span> INDEX IX_UserId_Score_CreationDate <span class="hljs-keyword">ON</span> dbo.Comments(UserID, Score, CreationDate)


<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>
    
    <span class="hljs-keyword">SELECT</span> u.DisplayName, u.Location
        , p.Title <span class="hljs-keyword">AS</span> PostTitle, p.Id <span class="hljs-keyword">AS</span> PostId
        , c.Score <span class="hljs-keyword">AS</span> CommentScore, c.Text <span class="hljs-keyword">AS</span> CommentText
    <span class="hljs-keyword">FROM</span> dbo.Users u
    <span class="hljs-keyword">JOIN</span> dbo.Comments c 
    <span class="hljs-keyword">ON</span>   u.Id <span class="hljs-operator">=</span> c.UserId
    <span class="hljs-keyword">JOIN</span> dbo.Posts p 
    <span class="hljs-keyword">ON</span>   c.PostId <span class="hljs-operator">=</span> p.Id

    <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Antarctica&#x27;</span>
    <span class="hljs-keyword">AND</span>   c.Score <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>

    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.CreationDate;
    GO	
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>.    Scan count <span class="hljs-number">0</span> , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">2946</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>. Scan count <span class="hljs-number">27</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">4025</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.    Scan count <span class="hljs-number">1</span> , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">3</span>
            

<span class="hljs-number">4.</span> VISUALIZATION INDEX

</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* NEXT CHALLENGE: in that Antarctica comment list, you probably noticed that some of the PostTitles are null.

That&#x27;s because at Stack, you can leave comments on both questions AND answers. To see it in action, look 
at the comments on the questions &amp; answers on this: https://stackoverflow.com/questions/923039

So let&#x27;s make our query a little more complex: I only want to see comments on answers, and I want the results 
to have:

* The question title
* The person who posted the question
* The answer text
* The person who posted the answer
* The comment text

So my query looks like this:  */</span>
<span class="hljs-keyword">SELECT</span> u.DisplayName, u.Location, 
Question.Title <span class="hljs-keyword">AS</span> QuestionTitle, Question.Id <span class="hljs-keyword">AS</span> QuestionId, 
QuestionUser.DisplayName <span class="hljs-keyword">AS</span> QuestionUserDisplayName,
Answer.Body <span class="hljs-keyword">AS</span> AnswerBody, AnswerUser.DisplayName <span class="hljs-keyword">AS</span> AnswerUserDisplayName,
c.Score <span class="hljs-keyword">AS</span> CommentScore, c.Text <span class="hljs-keyword">AS</span> CommentText, c.CreationDate
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Comments c <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> c.UserId
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts Answer <span class="hljs-keyword">ON</span> c.PostId <span class="hljs-operator">=</span> Answer.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.PostTypes pt <span class="hljs-keyword">ON</span> Answer.PostTypeId <span class="hljs-operator">=</span> pt.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users AnswerUser <span class="hljs-keyword">ON</span> Answer.OwnerUserId <span class="hljs-operator">=</span> AnswerUser.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts Question <span class="hljs-keyword">ON</span> Answer.ParentId <span class="hljs-operator">=</span> Question.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users QuestionUser <span class="hljs-keyword">ON</span> Question.OwnerUserId <span class="hljs-operator">=</span> QuestionUser.Id
<span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Antarctica&#x27;</span>
<span class="hljs-keyword">AND</span> c.Score <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">AND</span> pt.Type <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Answer&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.CreationDate;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>    
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;PostTypes&#x27;</span>.	Scan count <span class="hljs-number">1</span>  , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">2</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.		Scan count <span class="hljs-number">1</span>  , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">48042</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>.		Scan count <span class="hljs-number">723</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">5829</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>.	Scan count <span class="hljs-number">9</span>  , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">1029367</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
	<span class="hljs-keyword">In</span> this <span class="hljs-keyword">case</span> it does <span class="hljs-keyword">not</span> matter, because the <span class="hljs-keyword">WHERE</span> clause <span class="hljs-keyword">is</span> an EQUALITY <span class="hljs-keyword">WHERE</span> clause<span class="hljs-operator">!</span><span class="hljs-operator">!</span>
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?
	WebsiteUrl <span class="hljs-keyword">is</span> more selective

<span class="hljs-comment">/*REPONSE:*/</span>
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY

<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_Location <span class="hljs-keyword">ON</span> dbo.Users(Location) INCLUDE(DisplayName)
    <span class="hljs-keyword">CREATE</span> INDEX IX_UserId_Score <span class="hljs-keyword">ON</span> dbo.Comments(UserID, Score) INCLUDE(CreationDate)        
    <span class="hljs-keyword">CREATE</span> INDEX IX_Type <span class="hljs-keyword">ON</span> dbo.PostTypes(Type)

<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>        
    
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;PostTypes&#x27;</span>. Scan count <span class="hljs-number">0</span> , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">734</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.     Scan count <span class="hljs-number">1</span> , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">2253</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>.     Scan count <span class="hljs-number">0</span> , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">5838</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>.  Scan count <span class="hljs-number">27</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">3935</span>
            

    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;PostTypes&#x27;</span>. Scan count <span class="hljs-number">0</span> , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">734</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.     Scan count <span class="hljs-number">1</span> , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">2253</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>.     Scan count <span class="hljs-number">0</span> , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">5838</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>.  Scan count <span class="hljs-number">27</span>, logical <span class="hljs-keyword">reads</span> <span class="hljs-number">3030</span>
    

<span class="hljs-number">4.</span> VISUALIZATION INDEX

</code></pre>
<pre><code class="language-sql"><span class="hljs-comment">/* BONUS QUESTION: Hey, that wasn&#x27;t so bad, was it? Let&#x27;s just make one tiny change. Instead of Antarctica, 
let&#x27;s look for - oh I dunno, let&#x27;s say... */</span>
<span class="hljs-keyword">SELECT</span> u.DisplayName, u.Location, 
    Question.Title <span class="hljs-keyword">AS</span> QuestionTitle, Question.Id <span class="hljs-keyword">AS</span> QuestionId, 
    QuestionUser.DisplayName <span class="hljs-keyword">AS</span> QuestionUserDisplayName,
    Answer.Body <span class="hljs-keyword">AS</span> AnswerBody, AnswerUser.DisplayName <span class="hljs-keyword">AS</span> AnswerUserDisplayName,
    c.Score <span class="hljs-keyword">AS</span> CommentScore, c.Text <span class="hljs-keyword">AS</span> CommentText, c.CreationDate
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Comments c <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> c.UserId
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts Answer <span class="hljs-keyword">ON</span> c.PostId <span class="hljs-operator">=</span> Answer.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.PostTypes pt <span class="hljs-keyword">ON</span> Answer.PostTypeId <span class="hljs-operator">=</span> pt.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users AnswerUser <span class="hljs-keyword">ON</span> Answer.OwnerUserId <span class="hljs-operator">=</span> AnswerUser.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts Question <span class="hljs-keyword">ON</span> Answer.ParentId <span class="hljs-operator">=</span> Question.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users QuestionUser <span class="hljs-keyword">ON</span> Question.OwnerUserId <span class="hljs-operator">=</span> QuestionUser.Id
<span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;United States&#x27;</span>
    <span class="hljs-keyword">AND</span> c.Score <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span> pt.Type <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Answer&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> c.CreationDate;
GO

<span class="hljs-comment">/*DATA PERFORM FROM ORIGINAL:*/</span>    
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;PostTypes&#x27;</span>. Scan count <span class="hljs-number">1</span>     , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">2</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.     Scan count <span class="hljs-number">9</span>     , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">475705</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>.  Scan count <span class="hljs-number">9</span>     , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">1029657</span>
<span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>.     Scan count <span class="hljs-number">97570</span> , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">1209111</span>

<span class="hljs-comment">/*QUESTION*/</span>
Which field should go <span class="hljs-keyword">first</span> <span class="hljs-keyword">in</span> the <span class="hljs-keyword">WHERE</span> clause?
	<span class="hljs-keyword">In</span> this <span class="hljs-keyword">case</span> it does <span class="hljs-keyword">not</span> matter, because the <span class="hljs-keyword">WHERE</span> clause <span class="hljs-keyword">is</span> an EQUALITY <span class="hljs-keyword">WHERE</span> clause<span class="hljs-operator">!</span><span class="hljs-operator">!</span>
Which <span class="hljs-keyword">filter</span> <span class="hljs-keyword">is</span> more selective?
	WebsiteUrl <span class="hljs-keyword">is</span> more selective

<span class="hljs-comment">/*REPONSE:*/</span>
<span class="hljs-number">1.</span> <span class="hljs-keyword">CHECK</span> SELECTIVITY

<span class="hljs-number">2.</span> <span class="hljs-keyword">CREATE</span> INDEXES
    <span class="hljs-keyword">CREATE</span> INDEX IX_Location <span class="hljs-keyword">ON</span> dbo.Users(Location) INCLUDE(DisplayName)
    <span class="hljs-keyword">CREATE</span> INDEX IX_UserId_Score <span class="hljs-keyword">ON</span> dbo.Comments(UserID, Score) INCLUDE(CreationDate)

<span class="hljs-number">3.</span> TEST INDEXES
    <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>
    <span class="hljs-comment">------------------------------------------------------------------------------------</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;PostTypes&#x27;</span>. Scan count <span class="hljs-number">1</span>     , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">2</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Users&#x27;</span>.     Scan count <span class="hljs-number">9</span>     , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">428692</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Posts&#x27;</span>.     Scan count <span class="hljs-number">97570</span> , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">629318</span>
    <span class="hljs-keyword">Table</span> <span class="hljs-string">&#x27;Comments&#x27;</span>.  Scan count <span class="hljs-number">8704</span>  , logical <span class="hljs-keyword">reads</span> <span class="hljs-number">562573</span>


<span class="hljs-number">4.</span> VISUALIZATION INDEX

</code></pre>
</li>
</ul>
<h2 id="the-built-in-missing-index-recommendations">The built-in missing index recommendations</h2>
<ul>
<li>
<p>Index hints are a gift
They’re a byproduct of plan compilation, but they’re not the main deliverable.
• Shown in execution plans
• Tracked over time in DMVs like sys.dm_db_missing_index_details
• Shown in tools like sp_BlitzIndex</p>
<p>But they’re not perfect gifts.
Suggests super wide indexes
Doesn’t de-duplicate requests
Don’t get thrown for all queries
Get cleared at tricky times
Doesn’t recommend filtered, columnstore, indexed views, XML, spatial, in-memory OLTP</p>
</li>
<li>
<p>Let’s see how he does it
<img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_1.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_2.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_3.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_4.png" alt="alt text"></p>
</li>
<li>
<p>So far, not bad
<img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_5.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_6.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_7.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_8.png" alt="alt text"></p>
<p>It’s just a little bit more complex...Clippy picks key order using:
• Equality searches (=, IS NULL, IN a list of 1) ordered by the column they are in the table.
• Inequality search columns (&lt;, &gt;, LIKE, IS NOT NULL, IN a list of 2 or more) ordered by the column they are in the table.</p>
<p>Clippy can’t consider:
How often you filter on a field
How selective your filter clause is
The size of the field
What you do further upstream (joining, grouping, ordering)</p>
</li>
<li>
<p>He is focus on WHERE, not GROUP BY or ORDER BY
Order the whole table</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> Id <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">ORDER</span> BYDisplayName;
</code></pre>
<p>Filter, then order by</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> Id <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Location  <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;India&#x27;</span> <span class="hljs-keyword">ORDER</span> BYDisplayName;
</code></pre>
<p>Clippy just INCLUDEs DisplayName, figuring he’s going to sort all of the people in India by name, every single time this query runs. Another blind spot.</p>
<p>What’s he suggest for this?</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> Location, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> Location
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">DESC</span>;
</code></pre>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_9.png" alt="alt text"></p>
<p>Try creating one by hand.</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> INDEX IX_Location <span class="hljs-keyword">ON</span> dbo.Users(Location);
</code></pre>
<p>He uses the index Way faster. Single-threaded. Great estimates. No spills to disk</p>
</li>
<li>
<p>Addeding Clippy/s indexes can even make things worse
<img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_10.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_11.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_12.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_13.png" alt="alt text"></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\BuiltInMI_14.png" alt="alt text"></p>
<p>We create it. It doesn’t get used!
Drop the old IX_CreationDate...And the index gets used, but...that sort!
Now we’re sorting 1M rows. CPU time, elapsed time, and logical reads are all WORSE than the original query.
Clippy was on to something. An index tweak will help – just not the index Clippy wanted. Key on both fields, and the sort is gone.</p>
<p>What we saw
A query wasn’t terribly slow, but SQL Server asked for an index
If this was a frequent query, that index might seem attractive
But the requested index had the ORDER BY column as an include, when it really needs to be sorted
The query was much better with that column in the key</p>
<p>How to identify it
Look for high average CPU and reads on top plans
Dig into every operator
In the real world on big plans, this is time consuming
You have to rule out other things that may be the issue, such as parameter sniffing and inefficient or out of date statistics</p>
</li>
<li>
<p>RECAP
You don’t always get missing index requests. Even when you do, Clippy’s not putting much work in:
• Equality searches first, then inequality searches
• Fields ordered by their position in the table
• He’s completely focused on the WHERE</p>
</li>
<li>
<p>LAB 7</p>
<pre><code class="language-sql"><span class="hljs-comment">/* (I don&#x27;t teach this during the regular live classes anymore - I&#x27;ve expanded the other material so it ends up taking more than a 
day - but I leave it in the recordings in case folks are interested in doing it.) Now, it’s your turn: take the below queries and 
run them all at once without looking at ’em. Then, use sp_BlitzIndex to read the missing index recommendations, interpret them, 
and try to craft better indexes WITHOUT LOOKING  AT THE QUERIES. 
Then, after you’ve made the list of indexes you want to create, go through the queries and try to guess which query triggered 
which missing index request – and whether your index is a good fit. */</span>

<span class="hljs-comment">/* This stored procedure drops all nonclustered indexes: */</span>
DropIndexes;
GO

<span class="hljs-keyword">SET</span> STATISTICS IO, <span class="hljs-type">TIME</span> OFF;
GO
<span class="hljs-comment">/* Which badges are earned most often by people from Antarctica? */</span>
<span class="hljs-keyword">SELECT</span> b.Name, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> BadgesEarned
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Badges b <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> b.UserId
<span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Antarctica&#x27;</span>
    <span class="hljs-keyword">AND</span> b.Date <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">&#x27;2008/01/01&#x27;</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">&#x27;2008/12/31&#x27;</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> b.Name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">/* Who has earned the rarest badges? */</span>
<span class="hljs-keyword">WITH</span> RarestBadges <span class="hljs-keyword">AS</span> (<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> rare.Name, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> BadgesEarned
                        <span class="hljs-keyword">FROM</span> dbo.Badges rare
                        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> rare.Name
                        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>))
<span class="hljs-keyword">SELECT</span> r.Name <span class="hljs-keyword">AS</span> BadgeName, r.BadgesEarned PeopleWhoEarnedIt, u.DisplayName, u.Location, u.Reputation, u.Id <span class="hljs-keyword">AS</span> UserId
<span class="hljs-keyword">FROM</span> RarestBadges r
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Badges b <span class="hljs-keyword">ON</span> r.Name <span class="hljs-operator">=</span> b.Name
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> b.UserId <span class="hljs-operator">=</span> u.Id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.BadgesEarned, r.Name, u.DisplayName;

<span class="hljs-comment">/* What are the highest-scored SQL Server questions? */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> p.Score, p.Title, p.Tags, p.ViewCount
<span class="hljs-keyword">FROM</span> dbo.Posts p
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.PostTypes pt <span class="hljs-keyword">ON</span> p.PostTypeId <span class="hljs-operator">=</span> pt.Id
<span class="hljs-keyword">WHERE</span> pt.Type <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Question&#x27;</span>
    <span class="hljs-keyword">AND</span> p.Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server&gt;%&#x27;</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.Score <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">/* Who posts the most zero-score SQL Server questions? */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> u.DisplayName, u.Location, u.Id, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> Recs
<span class="hljs-keyword">FROM</span> dbo.Posts p
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.PostTypes pt <span class="hljs-keyword">ON</span> p.PostTypeId <span class="hljs-operator">=</span> pt.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
<span class="hljs-keyword">WHERE</span> p.Score <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span> pt.Type <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Question&#x27;</span>
    <span class="hljs-keyword">AND</span> p.Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server&gt;%&#x27;</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> u.DisplayName, u.Location, u.Id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">/* Awww, poor Gopal. Let&#x27;s see what he asked: */</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> dbo.Posts
<span class="hljs-keyword">WHERE</span> OwnerUserId <span class="hljs-operator">=</span> <span class="hljs-number">128071</span>
    <span class="hljs-keyword">AND</span> Score <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server&gt;%&#x27;</span>;

<span class="hljs-comment">/* Ouch, SQL Server 2000. Yeah, that explains that. 
Do questions about newer versions perform better than older ones? 
(If you&#x27;re using the Stack 2010 export, your case statement can be short.) */</span>
<span class="hljs-keyword">SELECT</span> SQLServerVersion <span class="hljs-operator">=</span> <span class="hljs-keyword">CASE</span> 
            <span class="hljs-keyword">WHEN</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server-2012&gt;%&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;SQL Server 2012&#x27;</span> 
            <span class="hljs-keyword">WHEN</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server-2008-r2&gt;%&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;SQL Server 2008 R2&#x27;</span>
            <span class="hljs-keyword">WHEN</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server-2008&gt;%&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;SQL Server 2008&#x27;</span>
            <span class="hljs-keyword">WHEN</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server-2005&gt;%&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;SQL Server 2005&#x27;</span>
            <span class="hljs-keyword">WHEN</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server-2000&gt;%&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;SQL Server 2000&#x27;</span>
            <span class="hljs-keyword">ELSE</span> <span class="hljs-string">&#x27;Not About SQL Server&#x27;</span>
            <span class="hljs-keyword">END</span>,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> Questions, <span class="hljs-built_in">AVG</span>(Score <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span>) <span class="hljs-keyword">AS</span> AvgScore, 
    <span class="hljs-built_in">AVG</span>(AnswerCount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span>) <span class="hljs-keyword">AS</span> AvgAnswers, <span class="hljs-built_in">AVG</span>(CommentCount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span>) <span class="hljs-keyword">AS</span> AvgComments
<span class="hljs-keyword">FROM</span> dbo.Posts
<span class="hljs-keyword">WHERE</span> Score <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">AND</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server%&#x27;</span>
    <span class="hljs-keyword">AND</span> PostTypeId <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">CASE</span> 
            <span class="hljs-keyword">WHEN</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server-2012&gt;%&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;SQL Server 2012&#x27;</span> 
            <span class="hljs-keyword">WHEN</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server-2008-r2&gt;%&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;SQL Server 2008 R2&#x27;</span>
            <span class="hljs-keyword">WHEN</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server-2008&gt;%&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;SQL Server 2008&#x27;</span>
            <span class="hljs-keyword">WHEN</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server-2005&gt;%&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;SQL Server 2005&#x27;</span>
            <span class="hljs-keyword">WHEN</span> Tags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&lt;sql-server-2000&gt;%&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;SQL Server 2000&#x27;</span>
            <span class="hljs-keyword">ELSE</span> <span class="hljs-string">&#x27;Not About SQL Server&#x27;</span>
            <span class="hljs-keyword">END</span>;

<span class="hljs-comment">/* Where are people earning the SQL Server badge from? */</span>
<span class="hljs-keyword">SELECT</span> u.Location, <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> u.Id) <span class="hljs-keyword">AS</span> BadgeEarnersInThisLocation
<span class="hljs-keyword">FROM</span> dbo.Badges b
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> b.UserId <span class="hljs-operator">=</span> u.Id
<span class="hljs-keyword">WHERE</span> b.Name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sql-server&#x27;</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> u.Location
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> u.Id) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">/* What is the most popular first word in Stack Overflow questions? */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> 
    <span class="hljs-built_in">SUBSTRING</span>(p.Title, <span class="hljs-number">1</span>, CHARINDEX(<span class="hljs-string">&#x27; &#x27;</span>, p.Title)) <span class="hljs-keyword">AS</span> FirstWord,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> p.Id) <span class="hljs-keyword">AS</span> Questions, <span class="hljs-built_in">AVG</span>(Score <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span>) <span class="hljs-keyword">AS</span> AvgScore,
    <span class="hljs-built_in">AVG</span>(CommentCount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span>) <span class="hljs-keyword">AS</span> AvgCommentCount, <span class="hljs-built_in">AVG</span>(AnswerCount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span>) <span class="hljs-keyword">AS</span> AvgAnswerCount,
    <span class="hljs-built_in">AVG</span>(ViewCount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span>) <span class="hljs-keyword">AS</span> AvgViewCount
<span class="hljs-keyword">FROM</span> dbo.Posts p
<span class="hljs-keyword">WHERE</span> p.PostTypeId <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">AND</span> CHARINDEX(<span class="hljs-string">&#x27; &#x27;</span>, p.Title) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">SUBSTRING</span>(p.Title, <span class="hljs-number">1</span>, CHARINDEX(<span class="hljs-string">&#x27; &#x27;</span>, p.Title))
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> p.Id) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">/* Is there one location that casts higher-bounty votes than others? */</span>
<span class="hljs-keyword">SELECT</span> u.Location, <span class="hljs-built_in">AVG</span>(v.BountyAmount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span>), <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> v.Id) <span class="hljs-keyword">AS</span> BountiesPosted
<span class="hljs-keyword">FROM</span> dbo.Votes v
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> v.UserId <span class="hljs-operator">=</span> u.Id
<span class="hljs-keyword">WHERE</span> v.BountyAmount <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> u.Location
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> v.Id) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">AVG</span>(v.BountyAmount <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span>) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">/* Whoa - who&#x27;s posting those high bounties? */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> v.BountyAmount, u.DisplayName, u.Location, 
    p.Title <span class="hljs-keyword">AS</span> QuestionTitle, p.Id <span class="hljs-keyword">AS</span> QuestionId, p.Tags
<span class="hljs-keyword">FROM</span> dbo.Votes v
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> v.UserId <span class="hljs-operator">=</span> u.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> v.PostId <span class="hljs-operator">=</span> p.Id
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> v.BountyAmount <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">/* Ah, 550 was the max bounty amount: 
https://meta.stackexchange.com/questions/45809/what-was-the-highest-bounty-ever-posted

Which brings an interesting question: who got cheap, and posted LESS than the
500 point bounty, but still high bounties? */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> v.BountyAmount, u.DisplayName, u.Location, 
    p.Title <span class="hljs-keyword">AS</span> QuestionTitle, p.Id <span class="hljs-keyword">AS</span> QuestionId, p.Tags
<span class="hljs-keyword">FROM</span> dbo.Votes v
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> v.UserId <span class="hljs-operator">=</span> u.Id
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> v.PostId <span class="hljs-operator">=</span> p.Id
<span class="hljs-keyword">WHERE</span> v.BountyAmount <span class="hljs-operator">&lt;</span> <span class="hljs-number">500</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> v.BountyAmount <span class="hljs-keyword">DESC</span>;
GO <span class="hljs-number">25</span>


My responses
master.dbo.sp_BlitzIndex
<span class="hljs-variable">@GetAllDatabases</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>

master.dbo.sp_BlitzIndex
    <span class="hljs-variable">@DatabaseName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;StackOverflow2013&#x27;</span>	
    , <span class="hljs-variable">@SchemaName</span> <span class="hljs-operator">=</span> dbo
    , <span class="hljs-variable">@TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Posts&#x27;</span>


<span class="hljs-keyword">CREATE</span> INDEX [PostTypeId_Score_Includes] 
<span class="hljs-keyword">ON</span> [StackOverflow2013].[dbo].[Posts] ([PostTypeId], [Score])  
INCLUDE ([OwnerUserId], [Tags],[AnswerCount], [CommentCount], [Title], [ViewCount]) 

<span class="hljs-keyword">CREATE</span> INDEX [UserId_Includes] 
<span class="hljs-keyword">ON</span> [StackOverflow2013].[dbo].[Votes] ([UserId])  
INCLUDE ([PostId], [BountyAmount]) 
</code></pre>
</li>
</ul>
<h2 id="recap-of-what-we-learned-and-what-to-do-next">Recap of what we learned and what to do next</h2>
<ul>
<li>
<p>Selectivity isn’t just uniqueness
It’s about what % of an object is matched by:
•Your WHERE clause
•Your JOIN relationships
•The ORDER BY, especially with a TOP</p>
<p>Isolate portions of your query and run ‘em separately to see how many rows will match.</p>
</li>
<li>
<p>Visualize indexes with a query
Stumped about why SQL Server refuses to use an index or is doing a sort?
Build a query to match the contents of the index, sorted in the same order.
Looking at that output will help you understand why a query will (or won’t) use the index, and why a sort will be required after the data comes out of the index.</p>
</li>
<li>
<p>The first round is the easy button
The first round of tuning tweaks is very effective: you can make a huge difference in a couple of hours.
Subsequent rounds are harder, and produce diminishing returns.
Work hard enough at tuning an application, and you start running out of free/easy options.
Management needs to hear that message: “We’ve already pushed all the easy buttons.”</p>
</li>
<li>
<p>The right nonclustered indexes</p>
</li>
</ul>
<ol>
<li>Reduce PAGEIOLATCH waits because we can grab a few pages from a tiny in-memory index rather than scanning an entire table from disk.</li>
<li>Reduce blocking by:
1. Letting us close transactions faster
2. Helping us find rows we want to update</li>
</ol>
<ul>
<li>
<p>The wrong nonclustered indexes
Slow down deletes, updates, and inserts because we have to lock and touch all these extra pages.
Reduce our memory effectiveness because we have to cache all these pages we don’t really need (since we’re touching them for DUIs.)
Slow down maintenance jobs: backups, checkdb, index rebuilds, stats updates.</p>
</li>
<li>
<p>My D.E.A.T.H. Method
Dedupe      near-identical indexes
Eliminate   unused indexes
Add         highly needed missing indexes
Tune        resource-intensive queries
Heaps       often need clustered indexes</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\01. Index\Image\DEATH_1.png" alt="alt text"></p>
</li>
</ul>

            
            
        </body>
        </html>