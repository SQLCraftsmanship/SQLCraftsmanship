<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Brent Ozar Course Notes</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="brent-ozar-course-notes">Brent Ozar Course Notes</h1>
<style>
r { color: red }
o { color: Orange }
g { color: Green }
lg { color: lightgreen }
b { color: Blue }
lb { color: lightblue }
</style>
<ul>
<li>
<p>Initial Page</p>
<p><a href="https://training.brentozar.com/courses/">https://training.brentozar.com/courses/</a></p>
</li>
</ul>
<hr>
<h1 id="1-fundamentals-of-parameter-sniffing">1. Fundamentals of Parameter Sniffing</h1>
<ul>
<li>Index
<ul>
<li><a href="#Folder-Structrure">Folder Structure</a></li>
<li><a href="#We-are-going-to-cover">We are going to cover</a>
<ul>
<li><a href="#What-Parameter-Sniffing-Is?">What Parameter Sniffing Is? (and isn't)</a></li>
<li><a href="#The-Kinds-of-Queries-That-Are-Vulnerable">The Kinds of Queries That Are Vulnerable</a></li>
<li><a href="#More-Plan-Choices-,-More-Problems">More Plan Choices, More Problems</a></li>
<li><a href="#Lab:-Write-a-Query-That-Suffers-From-Parameter-Sniffing">Lab: Write a Query That Suffers From Parameter Sniffing</a></li>
<li><a href="#The-Usual-Causes-of-Sniffing-Emergencies">The Usual Causes of Sniffing Emergencies</a></li>
<li><a href="#The-UNusual-causes">The UNusual causes</a></li>
<li><a href="#How-to-reac-to-a-Sniffing-Emergency">How to reac to a Sniffing Emergency</a></li>
<li><a href="#Lab:React-to-a-Sniffing-Emergency">Lab:React to a Sniffing Emergency</a></li>
<li><a href="#What-Parameter-Sniffing-ISN'T">What Parameter Sniffing ISN'T</a></li>
<li><a href="#How-SQL-Server-2022-Tries-Fixing-Parameter-Sniffing">How SQL Server 2022 Tries Fixing Parameter Sniffing</a></li>
<li><a href="#RECAP">RECAP</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="folder-structure">Folder Structure</h2>
<ol>
<li>
<p>Images
Will have the images that I take from the course.</p>
</li>
<li>
<p>PDF
Will have the document download from Brent Ozar oficial course.</p>
</li>
<li>
<p>Script
Will have the document download from Brent Ozar oficial course.</p>
</li>
</ol>
<h2 id="we-are-going-to-cover">We are going to cover</h2>
<ul>
<li>Understand what parameter sniffing is (and isn’t)</li>
<li>Analyze the kinds of queries that are susceptible</li>
<li>Lab: write a query that’s susceptible</li>
<li>See what triggers sniffing emergencies</li>
<li>Learn how to react to emergencies</li>
<li>Lab: tackle a sniffing emergency</li>
<li>See a few more examples of what sniffing isn’t</li>
</ul>
<h2 id="what-parameter-sniffing-is">What Parameter Sniffing Is?</h2>
<pre><code class="language-sql">USE StackOverflow2013;
GO
DropIndexes;
GO

<span class="hljs-comment">/* 2017, not 2019 yet */</span>
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">140</span>; 
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO

<span class="hljs-comment">/* Turn on actual execution plans and: */</span>
<span class="hljs-keyword">SET</span> STATISTICS IO, <span class="hljs-type">TIME</span> <span class="hljs-keyword">ON</span>;
GO

<span class="hljs-keyword">CREATE</span> INDEX IX_Reputation <span class="hljs-keyword">ON</span> dbo.Users(Reputation)
GO

<span class="hljs-comment">-- Small query</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10000</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Reputation<span class="hljs-operator">=</span><span class="hljs-number">2</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
GO

<span class="hljs-comment">-- Big query</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10000</span> <span class="hljs-operator">*</span> 
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Reputation<span class="hljs-operator">=</span><span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
GO
</code></pre>
<p><r>Notes</r></p>
<ul>
<li>
<p>La 1er query usa un Index Seek + Key Lookup y tiene un warning en el SELECT de asignacion de memoria. No es mucha asique no es problema.</p>
</li>
<li>
<p>La 2da query usa un Clusterd index Scan y a BO le da un Warning en el SELECT de asignacion de memoria pero de 4GB, esto es una animalada.
Mirando el plan se puede saber que el Clustered Index Scan estima que va a usar 4GB de memoria. Esto lo estima el engine porque asume
que todas las columnas van a estar completas en un 50%. Como tenemos columnas muy grandes de NVARCHAR(MAX) o NVARCHAR(XXX) la estimacion
que hace el engine es que va a necesitar 4GB de memoria cuando esto no es asi. No todas las columnas estan completas, muchas de ellas
ni siquiera tienen datos tienen NULL.</p>
</li>
<li>
<p>Every Key Lookup has x3 Reads</p>
</li>
<li>
<p>Execution plan dif</p>
<ol>
<li>One is execute on Parallel not the other</li>
<li>One returns 2k rows the second one 10k rows</li>
<li>The first use an Index Seek + Key Lookup and the other a Clustered Index Scan</li>
<li>The first one run in 0 seconds. The second one runs in 3 Seconds</li>
<li>The first one has a warning on the select for the memory</li>
</ol>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\03. Parameter Sniffing\Images\image.png" alt="alt text"></p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">PROCEDURE</span> dbo.usp_UsersByReputation
<span class="hljs-variable">@Reputation</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10000</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Reputation<span class="hljs-operator">=</span><span class="hljs-variable">@Reputation</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
GO

<span class="hljs-comment">-- Big query</span>
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">1</span>;
GO
<span class="hljs-comment">-- Small query</span>
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">2</span>;
GO
</code></pre>
<p>Notes</p>
<ul>
<li>Si ejecuto primero la query heavy y despues la small no tenemos ningun problema. Los usuarios estan contentos los DBA estan mal
porque el engine va a usar el 25% de la memoria. Es decir tanto para @Reputation = 1 como = 2 el engine usa el mismo plan de ejecucion. En teoria esto es parameter sniffing. Me esta usando el mismo plan para dos parametros diferentes. Pero como comentamos antes el usuario no se va a quejar.</li>
</ul>
<pre><code class="language-sql">DBCC FREEPROCCACHE
GO

<span class="hljs-comment">-- Small query</span>
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">2</span>;
GO
<span class="hljs-comment">-- Big query</span>
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">1</span>;
GO

sp_BlitzCache
</code></pre>
<p>NOTES</p>
<ul>
<li>
<p>Porque demora mas la Big query?
1ero. el Order By tiene un Warning de memoria. El engine le asigna solo los 10MB para hacer el ORDER BY y el resto lo tiene que hacer en disco. Le asigna, los 10MG porque son los que le asigno al 1er plan de ejecucion cuando @Reputation = 2</p>
<p>2do Porque hace mas de 1 millon de key lookups</p>
<p>3ero No esta usando el paralelismo. No lo usa porque esta usando el plan de ejecucion de @Reputation = 2 y este no usa paralelismo</p>
</li>
<li>
<p>When the small query goes first the users are not happy the DBA are. Because the DB don't check how many reads the query do the only thing that DBA take cares is if the TEMPDB is full or not.</p>
</li>
<li>
<p>Si tenemos poca memoria esto es un problema</p>
</li>
<li>
<p>Esto es un problema en Azure porque es caro asignarle mas memoria</p>
</li>
<li>
<p>Microsoft is trying to reduce de effect of parameter sniffing doing:</p>
<ul>
<li>
<p>In SQL 2019
There is something new call <r>Adaptive Memory Grant</r></p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\03. Parameter Sniffing\Images\image_2.png" alt="alt text"></p>
<p>If we execute the same query more than 1 the engine stars to adapt the amount of memory until see YesStable.</p>
</li>
<li>
<p>In SQL 2022
Cach 3 execution plan</p>
</li>
</ul>
</li>
<li>
<p><r>Para que se produzca parameter sniffing necesitamos de dos cosas:</p>
<ul>
<li><r>PARAMETROS en el sp</li>
<li><r>Tener diferentes planes de execucion para esos parametros.</li>
</ul>
</li>
</ul>
<h2 id="the-kinds-of-queries-that-are-vulnerable">The Kinds of Queries That Are Vulnerable</h2>
<pre><code class="language-sql"><span class="hljs-comment">/* Add a few indexes to let SQL Server choose: */</span>
<span class="hljs-keyword">CREATE</span> INDEX Location <span class="hljs-keyword">ON</span> dbo.Users(Location);
<span class="hljs-keyword">CREATE</span> INDEX OwnerUserId <span class="hljs-keyword">ON</span> dbo.Posts(OwnerUserId);
GO

<span class="hljs-comment">/* A bad query, but... */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">/* Find the most recent posts from an area */</span>
    <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> 
        u.DisplayName
        , p.Title
        , p.Id
        , p.CreationDate
    <span class="hljs-keyword">FROM</span> dbo.Posts p
    <span class="hljs-keyword">JOIN</span> dbo.Users u
    <span class="hljs-keyword">ON</span>   p.OwnerUserId <span class="hljs-operator">=</span> u.Id
    <span class="hljs-keyword">WHERE</span> <span class="hljs-built_in">UPPER</span>(u.Location) <span class="hljs-keyword">LIKE</span> <span class="hljs-built_in">UPPER</span>(<span class="hljs-variable">@Location</span>)
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">END</span>

<span class="hljs-comment">/* Big data */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

<span class="hljs-comment">/* Middle data */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

<span class="hljs-comment">/* Small data */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
GO
</code></pre>
<p>Notes</p>
<ul>
<li>
<p>In this case, all parameters produce the same execution plan.
Which means we get:</p>
<ul>
<li>Consistently bad estimates</li>
<li>Scans instead of seeks</li>
<li>Huge memory grants</li>
<li>Huge parallelism waits even to produce a tiny amount of rows</li>
</ul>
<p>And you would probably want to fix that. You could fix it by removing the explicit conversion since this database isn't case senstive anyway.</p>
<p>This isn't parameter sniffing: it's the exact OPPOSITE. We always get the SAME plan.</p>
<p>This isn't parameter sniffing: it's just a plain ol' bad execution plan because of the explicit conversion:
WHERE UPPER(u.Location) LIKE UPPER(@Location)</p>
</li>
<li>
<p>To solve this issue we have to introduce parameter sniffing, removing th UPPER function on the WHERE clause. Cuando tenes queries mal escritas el engine no entiende entonces podes insertar parameter sniffing para que el engine entienda mejor la query.</p>
</li>
<li>
<p>Use sp_recompile 'SP NAME' on prod in place of DBCC FREEPROCACHE. This only delete the execution plan for that particualr SP/</p>
</li>
</ul>
<p>Learning</p>
<ul>
<li>Cuando vos tenes un SP con parametros tenes y ya detectaste que el problema es el parameter sniffing, tenes que buscar cuales son los outlier para ese WHERE. Es decir con que parametros el query puede correr bien o mal.
Los parametros que podes usar son:</li>
</ul>
<ol>
<li>El mayor valor para ese where. Esto quiere decir el COUNT para ese where</li>
<li>El menor valor para ese where. Esto quiere decir el COUNT para ese where</li>
<li>Alguno en medio</li>
<li>Como las estadisticas se guardan en 1 sola pagina de 8K el engine solo mete hasta 201 bucket dentro de esta. Por lo cual si vos hacer un SELECT COUNT(*) FROM XXX WHERE XXX = @parametro. Por lo general en las estadisticas vas a encontrar que el engine creo 1 bucket por cada uno de los primeros 200 registros despues de eso seguramente no vas a encontrar un bucket para los demas valores. Como el SQL tiene poco lugar para guardar las estadisticas crea buchet solo para los valores grandes. Para el resto usa la ultima columna por lo que por lo general la estimacion no va ser la correcta.</li>
</ol>
<ul>
<li>The statistics work well for the 200 outliers</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Better version, but... */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-comment">/* Find the most recent posts from an area */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> u.DisplayName, p.Title, p.Id, p.CreationDate
<span class="hljs-keyword">FROM</span> dbo.Posts p
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
<span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>			<span class="hljs-comment">/* No explicit conversion */</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">END</span>
GO
</code></pre>
<ul>
<li>
<p>Some times is not a parameter sniffing problem it's just a bad estimation. How to identified this diference?</p>
<p>If you execute the SP with RECOMPILE and on the execution plan you see that the engine start doing a good estimation and then a bad estimation in the rest of the operators, that is a bad estimation and not a parameter sniffing issue.</p>
<p>e.g
What if SQL Server guessed the right number of Users, but:</p>
<ul>
<li>That location never posted any questions or answers (has no rows in Posts), or</li>
<li>That location posted WAY more questions or answers than average</li>
</ul>
<p>Let's find outliers: first, popular locations with no posts:</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> u.Location, <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> u.Id) <span class="hljs-keyword">AS</span> UserCount
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> p.OwnerUserId
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> u.Location
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> P.Id) <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> u.Id) <span class="hljs-keyword">DESC</span>;
GO

<span class="hljs-comment">/* And try a few of those: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Almaty, Almaty Region, Kazakhstan&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Surabaya, Republik Indonesia&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Yokohama&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
</code></pre>
<ul>
<li>
<p>Almaty, Almaty Region, Kazakhstan</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\03. Parameter Sniffing\Images\image-1.png" alt="alt text"></p>
</li>
<li>
<p>Surabaya, Republik Indonesia
Idem before</p>
</li>
<li>
<p>Yokohama
Idem before</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Then, one-person locations with a ton of posts: */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> Location, <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> u.Id) <span class="hljs-keyword">AS</span> UserCount, <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> p.Id) <span class="hljs-keyword">AS</span> PostCount 
<span class="hljs-keyword">FROM</span> dbo.Users u
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> u.Id <span class="hljs-operator">=</span> p.OwnerUserId
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> u.Location
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> u.Id) <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> p.Id) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">/* And try a few of those: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Forest of Dean, United Kingdom&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Västervåla, Sweden&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
</code></pre>
<ul>
<li>
<p>Willemstad, Curaçao
<img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\03. Parameter Sniffing\Images\image_3.png" alt="alt text"></p>
</li>
<li>
<p>Willemstad, Curaçao
Idem before</p>
</li>
<li>
<p>Västervåla, Sweden
Idem before</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* And try a few of those: */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Forest of Dean, United Kingdom&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Västervåla, Sweden&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

DBCC FREEPROCACHE
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Almaty, Almaty Region, Kazakhstan&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Surabaya, Republik Indonesia&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Yokohama&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Forest of Dean, United Kingdom&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Västervåla, Sweden&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE;

<span class="hljs-comment">/* Ah-ha! 
Now we have TWO separate problems:
1. Parameter sniffing
2. Incorrect estimates for SOME parameters

If India goes in first:
* The small locations suffer
* India does fine
* The outlier locations do fine

If the small locations go in first:
* The small locations do fine
* India suffers
* The outlier locations suffer

If the outlier locations go in first:
* The small locations do fine
* India suffers
* The outlier locations suffer
*/</span>
</code></pre>
<p><r>ESTA ULTIMA PARTE NO LA TERMINO DE ENTENDER BIEN. LA TENGO QUE RECHEQUEAR!!!!!!!!!!!!!!!</r></p>
</li>
</ul>
<h2 id="more-plan-choices-more-problems">More Plan Choices, More Problems</h2>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> INDEX CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate);
GO

<span class="hljs-comment">/* Here&#x27;s our proc text as a reminder - note that it&#x27;s ordering by CreationDate DESC: */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation <span class="hljs-variable">@Location</span> <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-comment">/* Find the most recent posts from an area */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> u.DisplayName, p.Title, p.Id, p.CreationDate
<span class="hljs-keyword">FROM</span> dbo.Posts p
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
<span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">/* Does this give us even more possible plans? Do any of these use the new index? */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Middle data */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier: few people, many posts */</span>
GO
</code></pre>
<ul>
<li>
<p>EXEC usp_SearchPostsByLocation 'India' WITH RECOMPILE; /* Big data */</p>
<p>(200 rows affected)</p>
<p>Table 'Users'. Scan count 0, logical reads 73.413</p>
<p>Table 'Posts'. Scan count 1, logical reads 97.453</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\03. Parameter Sniffing\Images\image_4.png" alt="alt text"></p>
</li>
</ul>
<p>Porque usa el Indice sobre CreationDate cuando tiene el indice por location?
Esto es porque el engine sabe que tiene muchas locaciones en India, entonces le resulta mas simple order por CreationDate y despues fijarse si el post es de la location India. Como la India tiene casi todos los post porque tiene muchisimos users, se puede suponer que vamos a encontrar los mach muy rapido. Y eso mismo es lo que pasa, por eso el engine descarta el Indice por location y usa el de CreationDate</p>
<ul>
<li>
<p>EXEC usp_SearchPostsByLocation 'Netherlands' WITH RECOMPILE; /* Middle data */</p>
<p>(200 rows affected)</p>
<p>Table 'Users'. Scan count 1   , logical reads 14018 , physical reads 0,</p>
<p>Table 'Posts'. Scan count 4558, logical reads 497543, physical reads 91</p>
<p>Para este el engine si usa el indice por location</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\03. Parameter Sniffing\Images\image_5.png" alt="alt text"></p>
<p>Porque es muy poca la gente que vive en Holanda 4558</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\03. Parameter Sniffing\Images\image_6.png" alt="alt text"></p>
<p>Ademas mirando el plan de ejecucion se puede ver que el sql ejecuta ahora un ORDER BY porque no esta usando el ix por creationdate</p>
</li>
<li>
<p>EXEC usp_SearchPostsByLocation 'Near Stonehenge' WITH RECOMPILE; /* Small data */
Same before</p>
</li>
<li>
<p>EXEC usp_SearchPostsByLocation 'Willemstad, Curaçao' WITH RECOMPILE; /* Outlier: few people, many posts */</p>
<p>(200 rows affected)</p>
<p>Table 'Posts'. Scan count 3, logical reads 89576, physical reads 13,</p>
<p>Table 'Users'. Scan count 1, logical reads 12   , physical reads 2</p>
<p>Use Location index but with a warnig on the order</p>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\03. Parameter Sniffing\Images\image_7.png" alt="alt text"></p>
</li>
<li>
<p>Cual seria el peor escenario???
Ahora que sumamos el indice por creationdate</p>
<pre><code class="language-sql"><span class="hljs-comment">-- Brent Ozar</span>
sp_recompile <span class="hljs-string">&#x27;usp_SearchPostsByLocation&#x27;</span>
<span class="hljs-comment">-- A el este le corre en 0 sec y usa el location ix</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>; <span class="hljs-comment">/* Small data */</span>
<span class="hljs-comment">-- A el este este corre en 5 sec y usa el location ix</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>; <span class="hljs-comment">/* Big data */</span>


sp_recompile <span class="hljs-string">&#x27;usp_SearchPostsByLocation&#x27;</span>
<span class="hljs-comment">-- A el le ejecuta in single thread no paralelism y usa el CrationDate ix</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>; <span class="hljs-comment">/* Big data */</span>
<span class="hljs-comment">-- A el le demora un monton. A el </span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>; <span class="hljs-comment">/* Small data */</span>
</code></pre>
<p>El peor escenario es ejecutar 1ero la india y despues Near Stonehenge. Porque con la India usa el indice de creationdate y despues se fija si el usuario es de la locacion correspondiente. Para la india eso esta bien. Pero para Near Stonhenge eso no sirve. Porque ejecuta el mismo plan de jecucion de la india y primero ordena por la fecha con el indice de creationdate y despues se fija si es de Near Stonhenge y ademas haciendo un Kee Lookup, pero en esta locacion NO HAY NADIE. Entonces no sirve.</p>
<p>Entonces no teniamos un problema de parameter sniffing hasta que nosotros creamos el nuevo indice.</p>
</li>
<li>
<p>Como resolver esto?
Eliminando el IX
Poniendo un HINT para forzar el uso del IX</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* And what if our stored procedure gets more complex? */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_SearchPostsByLocation 
	<span class="hljs-variable">@Location</span>  <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>), 
	<span class="hljs-variable">@StartDate</span> DATETIME, 
	<span class="hljs-variable">@EndDate</span>   DATETIME <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-comment">/* Find the most recent posts from an area */</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">200</span> u.DisplayName, p.Title, p.Id, p.CreationDate
  <span class="hljs-keyword">FROM</span> dbo.Posts p
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
  <span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-keyword">LIKE</span> <span class="hljs-variable">@Location</span>
    <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-keyword">BETWEEN</span> <span class="hljs-variable">@StartDate</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@EndDate</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-comment">-- India</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, small dates */</span>

<span class="hljs-comment">-- Netherlands</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Netherlands&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium data, small dates */</span>

<span class="hljs-comment">-- Near Stonehenge</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, small dates */</span>

<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-02-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, medium dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Willemstad, Curaçao&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier data, small dates */</span>
GO
</code></pre>
<ul>
<li>
<p>India
Para la India el engine usa el mismos plan en las 3 ejecuciones. Usa el indice por CreationDate y evita el Order By</p>
</li>
<li>
<p>Netherlands
Para Netherlands usa el Location para big y medium. Pero usa el CreationDate para el small. Este ultimo es el mismo plan que usa para la India, es raro!</p>
</li>
<li>
<p>Near Stonehenge
Para Near Stonehenge usa el Location para big y medium. Pero usa el CreationDate para el small. Este ultimo es el mismo plan que usa para la India, es raro!</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Si tomamos los dos extremos. El mas pesado y el mas chicos */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;India&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-01-01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big data, big dates */</span>
<span class="hljs-keyword">EXEC</span> usp_SearchPostsByLocation <span class="hljs-string">&#x27;Near Stonehenge&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:00&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2009-01-01 10:01&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Small data, small dates */</span>
</code></pre>
<ul>
<li>A BrentOzar le da el mismo plan. A mi la unica diferencia es que para la india lo hace en paralelo. Pero el plan es el mismo usa el CreationDate index</li>
</ul>
<p>Learn</p>
<ul>
<li>No solo nos tenemos que quedar con los parametros extremos como ser la India y Near Stonehenge. Tambien tenemos que buscar los intermedios.</li>
</ul>
<h2 id="lab-write-a-query-that-suffers-from-parameter-sniffing">Lab: Write a Query That Suffers From Parameter Sniffing</h2>
<ul>
<li>Now, it's your turn: using Stack Overflow database:
Write a query that's susceptible to parameter sniffing. Try to use just one table, and NOT the Users table. Let's mix it up.
You'll need to create at least one index to give SQL Server tough choices. Build the list of parameters that will produce widly different plans. Free tha plan cache, run it with one set of parameters, and then the other, and see wich one causes performance to become way worse.</li>
</ul>
<pre><code class="language-sql">  <span class="hljs-comment">-- My example</span>
  <span class="hljs-comment">/*
      * Use one table not dbo.Users
      * Create one index at least
      * Build the list of parameters that will produce a wildly different plan
      * Free cache and run them

      * Analyze the info first
          SELECT top 10 * FROM Badges
              SELECT COUNT(*) FROM Badges
                  -- 8.042.005
              SELECT Name, COUNT(*) FROM Badges GROUP BY Name ORDER BY COUNT(*) DESC

                  -- Max &#x27;Popular Question&#x27;, COUNT 1.286.465
                  -- Min &#x27;normalization&#x27;   , COUNT 1
                  -- Outlier &#x27;Tumbleweed&#x27;	 , COUNT 317744
                  -- Outlier &#x27;magento&#x27;	 , COUNT 50

              DBCC SHOW_STATISTICS (&#x27;dbo.Badges&#x27;,&#x27;_WA_Sys_00000002_7D78A4E7&#x27;)

          SELECT top 10 * FROM Votes
  */</span>

  DropIndexes;
  GO
  <span class="hljs-keyword">CREATE</span> INDEX ix_DateName <span class="hljs-keyword">ON</span> dbo.Badges ([<span class="hljs-type">Date</span>], [Name])
  GO

  <span class="hljs-comment">--CREATE INDEX ix_NameDate ON dbo.Badges ([Name], [Date])</span>
  <span class="hljs-comment">--GO</span>

  <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_GetBadge <span class="hljs-variable">@Name</span> NVARCHAR(<span class="hljs-number">40</span>)
  <span class="hljs-keyword">AS</span>
  <span class="hljs-keyword">BEGIN</span>
      <span class="hljs-keyword">SELECT</span> Id, Name, UserId, <span class="hljs-type">Date</span>
      <span class="hljs-keyword">FROM</span>   dbo.Badges
      <span class="hljs-keyword">WHERE</span>  Name <span class="hljs-operator">=</span> <span class="hljs-variable">@Name</span>
      <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-type">Date</span>;
  <span class="hljs-keyword">END</span>
  GO

  <span class="hljs-keyword">SET</span> STATISTICS IO <span class="hljs-keyword">ON</span>

  DBCC FREEPROCCACHE

  <span class="hljs-comment">-- Exec whitout index</span>
  <span class="hljs-keyword">BEGIN</span> 
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;Popular Question&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big    */</span> 
  <span class="hljs-comment">/* 
  Time		 : 6sec 
  Logical reads: 50.379 (Total Pages 49649)
  Plan		 : Clustered Index Scan
  Parallel     : Si
  Memory Grant : 154 MB
  Warning      : In Sort
  */</span> 
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;Tumbleweed&#x27;</span>		 <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium */</span>
  <span class="hljs-comment">/* 
  Time		 : 1sec 
  Logical reads: 50.379 (Total Pages 49649)
  Plan		 : Clustered Index Scan
  Parallel     : Si
  Memory Grant : 39 MB
  Warning      : Non Warning
  */</span> 
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;normalization&#x27;</span>    <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* small  */</span>
  <span class="hljs-comment">/* 
  Time		 : 0sec 
  Logical reads: 49.649 (Total Pages 49.649)
  Plan		 : Clustered Index Scan
  Parallel     : No
  Memory Grant : 1024 MB use 0
  Warning      : Non Warning
  */</span> 
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;magento&#x27;</span>			 <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier */</span>
  <span class="hljs-comment">/* 
  Time		 : 0sec 
  Logical reads: 49.649 (Total Pages 49.649)
  Plan		 : Clustered Index Scan
  Parallel     : No
  Memory Grant : 1024 MB use 16KB
  Warning      : Non Warning
  */</span> 

      <span class="hljs-comment">/*
      All together
          EXEC dbo.usp_GetBadge &#x27;Popular Question&#x27; WITH RECOMPILE; /* Big    */</span> 
          <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;Tumbleweed&#x27;</span>		 <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium */</span>
          <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;normalization&#x27;</span>    <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* small  */</span>
          <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;magento&#x27;</span>			 <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier */</span>
      <span class="hljs-operator">*</span><span class="hljs-operator">/</span>

  <span class="hljs-comment">-- Exec whitout index</span>
  <span class="hljs-keyword">END</span>

  <span class="hljs-comment">-- Exec with new index</span>
  <span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;Popular Question&#x27;</span> <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Big    */</span> 
  <span class="hljs-comment">/* 
  Time		 : 6sec 
  Logical reads: 50.379 (Total Pages 49649)
  Plan		 : Clustered Index Scan
  Parallel     : Si
  Memory Grant : 154 MB
  Warning      : In Sort
  */</span> 
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;Tumbleweed&#x27;</span>		 <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium */</span>
  <span class="hljs-comment">/* 
  Time		 : 1sec 
  Logical reads: 50.379 (Total Pages 49649)
  Plan		 : Clustered Index Scan
  Parallel     : Si
  Memory Grant : 39 MB
  Warning      : Non Warning
  */</span> 
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;normalization&#x27;</span>    <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* small  */</span>
  <span class="hljs-comment">/* 
  Time		 : 0sec 
  Logical reads: 42.729 (Total Pages 49.649)
  Plan		 : Index Scan + Key Lookup
  Parallel     : No
  Memory Grant : 0
  Warning      : Non Warning
  */</span> 
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;magento&#x27;</span>			 <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier */</span>
  <span class="hljs-comment">/* 
  Time		 : 0sec 
  Logical reads: 42.887 (Total Pages 49.649)
  Plan		 : Index Scan + Key Lookup
  Parallel     : No
  Memory Grant : 1024 MB use 16KB
  Warning      : Non Warning
  */</span> 

      <span class="hljs-comment">/*
      All together
          EXEC dbo.usp_GetBadge &#x27;Popular Question&#x27; WITH RECOMPILE; /* Big    */</span> 
          <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;Tumbleweed&#x27;</span>		 <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Medium */</span>
          <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;normalization&#x27;</span>    <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* small  */</span>
          <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;magento&#x27;</span>			 <span class="hljs-keyword">WITH</span> RECOMPILE; <span class="hljs-comment">/* Outlier */</span>
      <span class="hljs-operator">*</span><span class="hljs-operator">/</span>
  <span class="hljs-keyword">END</span>

  <span class="hljs-comment">-- Worse Scenario</span>
  sp_recompile <span class="hljs-string">&#x27;dbo.usp_GetBadge&#x27;</span>
  <span class="hljs-comment">-- If I put &#x27;normalization&#x27; first in cache and the &#x27;Popular Question&#x27;</span>
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;normalization&#x27;</span>; <span class="hljs-comment">/* small  */</span>
  <span class="hljs-comment">/* 
  Time		 : 0sec 
  Logical reads: 42.729 (Total Pages 49.649)
  Plan		 : Index Scan + Key Lookup
  Parallel     : No
  Memory Grant : 0
  Warning      : Non Warning
  */</span> 
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;Popular Question&#x27;</span>; <span class="hljs-comment">/* Big    */</span> 
  <span class="hljs-comment">/* 
  Time		 : 5sec 
  Logical reads: 3.982.533 (Total Pages 49649)
  Plan		 : Index Scan + Key Lookup
  Parallel     : No
  Memory Grant : 154 MB
  Warning      : In Sort
  */</span> 


  sp_recompile <span class="hljs-string">&#x27;dbo.usp_GetBadge&#x27;</span>
  <span class="hljs-comment">-- If I put &#x27;Popular Question&#x27; first in cache and the &#x27;normalization&#x27;</span>
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;Popular Question&#x27;</span>; <span class="hljs-comment">/* Big    */</span> 
  <span class="hljs-comment">/* 
  Time		 : 6sec 
  Logical reads: 50.379 (Total Pages 49649)
  Plan		 : Clustered Index Scan
  Parallel     : Si
  Memory Grant : 150 MB
  Warning      : In Sort
  */</span> 
  <span class="hljs-keyword">EXEC</span> dbo.usp_GetBadge <span class="hljs-string">&#x27;normalization&#x27;</span>; <span class="hljs-comment">/* small  */</span>
  <span class="hljs-comment">/* 
  Time		 : 0sec 
  Logical reads: 50.379 (Total Pages 49.649)
  Plan		 : Clustered Index Scan
  Parallel     : Si
  Memory Grant : 336MB use 0.38
  Warning      : Non Warning
  */</span> 
</code></pre>
<ul>
<li>This is an example almost similar to my. Execute</li>
</ul>
<p><img src="file:///c:\Perso\GitHub\LiberatoriLucas\Course\BrentOzar\04. Fundamentals\03. Parameter Sniffing\Images\image_8.png" alt="alt text"></p>
<p><r>ESTO LO TENGO QUE VER DESPUES Y PONERLO EN ESTE DOC. SON LOS ULTIMOS 15 MINUTOS DEL Lab:Brent Does it (21:43)</r></p>
<h2 id="the-usual-causes-of-sniffing-emergencies">The Usual Causes of Sniffing Emergencies</h2>
<ul>
<li>These things cause the plan cache to be evicted:</li>
</ul>
<ul>
<li>Restarting the operating system</li>
<li>Restarting the SQL Server service</li>
<li>Cluster failover</li>
<li>AG failover (since we're now on a different plan cache)</li>
<li>Database restore</li>
<li>Running RECONFIGURE after changing some server-level options</li>
<li>Changing some database-level options like MAXDOP</li>
<li>DBCC FREEPROCCACHE</li>
<li>Altering the stored proc</li>
<li>sp_recompile</li>
<li>Rebuilding an index</li>
<li>Updating statistics</li>
</ul>
<p>We'll demo the above by looking at:</p>
<ul>
<li>sp_BlitzCache's plan cache history warning</li>
<li>sp_Blitz's plan cache history warning</li>
<li>sp_BlitzFirst's warning about stats being updated</li>
<li>plan_generation_num in sys.dm_exec_query_stats</li>
</ul>
<pre><code class="language-sql">USE StackOverflow2013;
GO
DropIndexes;
GO
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">140</span>; <span class="hljs-comment">/* 2017, not 2019 yet */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO
<span class="hljs-keyword">SET</span> STATISTICS IO, <span class="hljs-type">TIME</span> <span class="hljs-keyword">ON</span>;
GO
<span class="hljs-keyword">CREATE</span> INDEX IX_Reputation <span class="hljs-keyword">ON</span> dbo.Users(Reputation)
GO
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">PROCEDURE</span> dbo.usp_UsersByReputation
  <span class="hljs-variable">@Reputation</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10000</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Reputation<span class="hljs-operator">=</span><span class="hljs-variable">@Reputation</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
GO

<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">1</span>; <span class="hljs-comment">--big</span>
GO
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">2</span>; <span class="hljs-comment">--small</span>
GO

DBCC FREEPROCCACHE
GO
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">2</span>;
GO
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">1</span>;
GO
sp_BlitzCache
GO


DBCC FREEPROCCACHE
GO
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">1</span>;
GO
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">1</span>;
GO
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">1</span>;
GO
<span class="hljs-keyword">SELECT</span> execution_count, total_worker_time, total_elapsed_time, plan_generation_num
<span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats <span class="hljs-keyword">WHERE</span> query_hash <span class="hljs-operator">=</span> <span class="hljs-number">0xA6F28073109D7278</span>;
GO

<span class="hljs-keyword">ALTER</span> INDEX IX_Reputation <span class="hljs-keyword">ON</span> dbo.Users REBUILD;
GO
<span class="hljs-keyword">SELECT</span> execution_count, total_worker_time, total_elapsed_time, plan_generation_num
<span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats <span class="hljs-keyword">WHERE</span> query_hash <span class="hljs-operator">=</span> <span class="hljs-number">0xA6F28073109D7278</span>;
GO
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
GO
<span class="hljs-keyword">SELECT</span> execution_count, total_worker_time, total_elapsed_time, plan_generation_num
<span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats <span class="hljs-keyword">WHERE</span> query_hash <span class="hljs-operator">=</span> <span class="hljs-number">0xA6F28073109D7278</span>;
</code></pre>
<p>QUESTION</p>
<ul>
<li><r>Mi unica duda aca que quiero repasar es el tema del plan_generation_num</r></li>
</ul>
<h2 id="the-uusual-causes">The Uusual causes</h2>
<ul>
<li>SQL puede almasenar desde 40.000 a 160.000 planes de ejecucion</li>
<li>WARNING
<r>TENGO QUE VER ESTE VIDEO DE NUEVO. SE ENTIENDE PERO ME PERDI EN ALGUNOS MOMENTOS</r></li>
<li>These 3 are specialized: let's demo the first two and talk about the 3rd.</li>
</ul>
<ul>
<li>Plan cache pressure due to unparameterized queries</li>
<li>Memory pressure</li>
<li>Plans aging out</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">1</span>;
GO
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">2</span>;
GO

DBCC FREEPROCCACHE
GO
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">2</span>;
GO
<span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">1</span>;
GO
sp_BlitzCache
GO

<span class="hljs-comment">/* How much plan cache history do we have? Originally published here:
https://www.brentozar.com/archive/2018/07/tsql2sday-how-much-plan-cache-history-do-you-have/
*/</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">50</span>
    creation_date <span class="hljs-operator">=</span> <span class="hljs-built_in">CAST</span>(creation_time <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>),
    creation_hour <span class="hljs-operator">=</span> <span class="hljs-keyword">CASE</span>
                        <span class="hljs-keyword">WHEN</span> <span class="hljs-built_in">CAST</span>(creation_time <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-built_in">CAST</span>(GETDATE() <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span>
                        <span class="hljs-keyword">ELSE</span> DATEPART(hh, creation_time)
                    <span class="hljs-keyword">END</span>,
    <span class="hljs-built_in">SUM</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> plans
<span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">CAST</span>(creation_time <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>),
         <span class="hljs-keyword">CASE</span>
             <span class="hljs-keyword">WHEN</span> <span class="hljs-built_in">CAST</span>(creation_time <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-built_in">CAST</span>(GETDATE() <span class="hljs-keyword">AS</span> <span class="hljs-type">date</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span>
             <span class="hljs-keyword">ELSE</span> DATEPART(hh, creation_time)
         <span class="hljs-keyword">END</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DESC</span>, <span class="hljs-number">2</span> <span class="hljs-keyword">DESC</span>;
GO

<span class="hljs-comment">/* Similarly: */</span>
sp_BlitzCache;
GO
sp_Blitz;
GO
sp_BlitzFirst;
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_GetUser <span class="hljs-variable">@UserId</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-variable">@DisplayName</span> NVARCHAR(<span class="hljs-number">40</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-variable">@Location</span> NVARCHAR(<span class="hljs-number">100</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-comment">/* They have to ask for either a UserId or a DisplayName or a Location: */</span>
IF <span class="hljs-variable">@UserId</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@DisplayName</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-variable">@Location</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
	<span class="hljs-keyword">RETURN</span>;

<span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@StringToExecute</span> NVARCHAR(<span class="hljs-number">4000</span>);
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;SELECT * FROM dbo.Users WHERE 1 = 1 &#x27;</span>;

IF <span class="hljs-variable">@UserId</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
	<span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND Id = &#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-built_in">CAST</span>(<span class="hljs-variable">@UserId</span> <span class="hljs-keyword">AS</span> NVARCHAR(<span class="hljs-number">10</span>));

IF <span class="hljs-variable">@DisplayName</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
	<span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND DisplayName = &#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-variable">@DisplayName</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span>;

IF <span class="hljs-variable">@Location</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
	<span class="hljs-keyword">SET</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@StringToExecute</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27; AND Location = &#x27;&#x27;&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-variable">@Location</span> <span class="hljs-operator">+</span> N<span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span>;

<span class="hljs-keyword">EXEC</span> sp_executesql <span class="hljs-variable">@StringToExecute</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_DynamicSQLLab] <span class="hljs-keyword">WITH</span> RECOMPILE <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-comment">/* Hi! You can ignore this stored procedure.
	   This is used to run different random stored procs as part of your class.
	   Don&#x27;t change this in order to &quot;tune&quot; things.
	*/</span>
	<span class="hljs-keyword">SET</span> NOCOUNT <span class="hljs-keyword">ON</span>
 
	<span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@Id1</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">CAST</span>(RAND() <span class="hljs-operator">*</span> <span class="hljs-number">1000000</span> <span class="hljs-keyword">AS</span> <span class="hljs-type">INT</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span>,
			<span class="hljs-variable">@Param1</span> NVARCHAR(<span class="hljs-number">100</span>);

	IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">4</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>
		<span class="hljs-keyword">EXEC</span> dbo.usp_GetUser <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span>;
	<span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">4</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>
		<span class="hljs-keyword">BEGIN</span>
		<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@Param1</span> <span class="hljs-operator">=</span> Location <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Id <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span> OPTION (RECOMPILE);
		<span class="hljs-keyword">EXEC</span> dbo.usp_GetUser <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Param1</span>;
		<span class="hljs-keyword">END</span>
	<span class="hljs-keyword">ELSE</span>
		<span class="hljs-keyword">BEGIN</span>
		<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@Param1</span> <span class="hljs-operator">=</span> DisplayName <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Id <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span> OPTION (RECOMPILE);
		<span class="hljs-keyword">EXEC</span> dbo.usp_GetUser <span class="hljs-variable">@DisplayName</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Param1</span>;
		<span class="hljs-keyword">END</span>
<span class="hljs-keyword">END</span>
GO

DBCC FREEPROCCACHE;
GO
<span class="hljs-keyword">EXEC</span> [usp_DynamicSQLLab]
GO <span class="hljs-number">500</span>

<span class="hljs-comment">/* Finding the culprits: */</span>
sp_BlitzCache <span class="hljs-variable">@SortOrder</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;recent compilations&#x27;</span>
GO
sp_BlitzCache <span class="hljs-variable">@SortOrder</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;query hash&#x27;</span>
GO

<span class="hljs-comment">/* Or this: Originally published here: 
https://www.brentozar.com/archive/2018/03/why-multiple-plans-for-one-query-are-bad/
*/</span>
<span class="hljs-keyword">WITH</span> RedundantQueries <span class="hljs-keyword">AS</span> 
        (<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> query_hash, statement_start_offset, statement_end_offset,
            <span class="hljs-comment">/* PICK YOUR SORT ORDER HERE BELOW: */</span>

            <span class="hljs-built_in">COUNT</span>(query_hash) <span class="hljs-keyword">AS</span> sort_order,            <span class="hljs-comment">--queries with the most plans in cache</span>

            <span class="hljs-comment">/* Your options are:
            COUNT(query_hash) AS sort_order,            --queries with the most plans in cache
            SUM(total_logical_reads) AS sort_order,     --queries reading data
            SUM(total_worker_time) AS sort_order,       --queries burning up CPU
            SUM(total_elapsed_time) AS sort_order,      --queries taking forever to run
            */</span>

            <span class="hljs-built_in">COUNT</span>(query_hash) <span class="hljs-keyword">AS</span> PlansCached,
            <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span>(query_hash)) <span class="hljs-keyword">AS</span> DistinctPlansCached,
            <span class="hljs-built_in">MIN</span>(creation_time) <span class="hljs-keyword">AS</span> FirstPlanCreationTime,
            <span class="hljs-built_in">MAX</span>(creation_time) <span class="hljs-keyword">AS</span> LastPlanCreationTime,
			<span class="hljs-built_in">MAX</span>(s.last_execution_time) <span class="hljs-keyword">AS</span> LastExecutionTime,
            <span class="hljs-built_in">SUM</span>(total_worker_time) <span class="hljs-keyword">AS</span> Total_CPU_ms,
            <span class="hljs-built_in">SUM</span>(total_elapsed_time) <span class="hljs-keyword">AS</span> Total_Duration_ms,
            <span class="hljs-built_in">SUM</span>(total_logical_reads) <span class="hljs-keyword">AS</span> Total_Reads,
            <span class="hljs-built_in">SUM</span>(total_logical_writes) <span class="hljs-keyword">AS</span> Total_Writes,
			<span class="hljs-built_in">SUM</span>(execution_count) <span class="hljs-keyword">AS</span> Total_Executions,
            <span class="hljs-comment">--SUM(total_spills) AS Total_Spills,</span>
            N<span class="hljs-string">&#x27;EXEC sp_BlitzCache @OnlyQueryHashes=&#x27;&#x27;0x&#x27;</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">CONVERT</span>(NVARCHAR(<span class="hljs-number">50</span>), query_hash, <span class="hljs-number">2</span>) <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span> <span class="hljs-keyword">AS</span> MoreInfo
            <span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats s
            <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> query_hash, statement_start_offset, statement_end_offset
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">4</span> <span class="hljs-keyword">DESC</span>)
<span class="hljs-keyword">SELECT</span> r.query_hash, r.PlansCached, r.DistinctPlansCached, q.SampleQueryText, q.SampleQueryPlan, r.MoreInfo, 
        r.Total_CPU_ms, r.Total_Duration_ms, r.Total_Reads, r.Total_Writes, r.Total_Executions, <span class="hljs-comment">--r.Total_Spills,</span>
        r.FirstPlanCreationTime, r.LastPlanCreationTime, r.LastExecutionTime, r.statement_start_offset, r.statement_end_offset, r.sort_order
    <span class="hljs-keyword">FROM</span> RedundantQueries r
    <span class="hljs-keyword">CROSS</span> APPLY (<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10</span> st.text <span class="hljs-keyword">AS</span> SampleQueryText, qp.query_plan <span class="hljs-keyword">AS</span> SampleQueryPlan, qs.total_elapsed_time
        <span class="hljs-keyword">FROM</span> sys.dm_exec_query_stats qs 
        <span class="hljs-keyword">CROSS</span> APPLY sys.dm_exec_sql_text(qs.sql_handle) <span class="hljs-keyword">AS</span> st
        <span class="hljs-keyword">CROSS</span> APPLY sys.dm_exec_query_plan(qs.plan_handle) <span class="hljs-keyword">AS</span> qp
        <span class="hljs-keyword">WHERE</span> r.query_hash <span class="hljs-operator">=</span> qs.query_hash
            <span class="hljs-keyword">AND</span> r.statement_start_offset <span class="hljs-operator">=</span> qs.statement_start_offset
            <span class="hljs-keyword">AND</span> r.statement_end_offset <span class="hljs-operator">=</span> qs.statement_end_offset
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> qs.total_elapsed_time <span class="hljs-keyword">DESC</span>) q
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> r.sort_order <span class="hljs-keyword">DESC</span>, r.query_hash, q.total_elapsed_time <span class="hljs-keyword">DESC</span>;


<span class="hljs-comment">/* Causing memory pressure from workspace grants */</span>
DropIndexes;
GO
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersLeaderboard <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> <span class="hljs-operator">*</span>
	<span class="hljs-keyword">FROM</span> dbo.Users
	<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO
<span class="hljs-comment">/* Run that across several sessions at once */</span>
</code></pre>
<h2 id="how-to-reac-to-a-sniffing-emergency">How to reac to a Sniffing Emergency</h2>
<ul>
<li>When the emergency strikes:
<ul>
<li>Identify the one bad plan by using sp_BlitzCache.
See for queries that you had never seen on the top 10 as a bonus check the Avg Duration(ms) column. If you know this and compared against what you have now and the diff is huge, you got the issue!</li>
<li>Save the one bad plan to disk or table for later troubleshooting</li>
<li>Free the one bad plan from cache</li>
<li>Identify the new plan that goes in cache instead, and save the newly good one for later troubleshooting too. You must use the QueryHash from the plan that you saved and then run sp_BlitzCache @OnlyQueryHases = 'oxa123wfds'</li>
<li>Then compare the execution plans. The old and new.</li>
</ul>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Set the stage with the right server options &amp; database config: */</span>
USE StackOverflow2013;
GO
DropIndexes;
GO
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">140</span>; <span class="hljs-comment">/* 2017, not 2019 yet */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO
<span class="hljs-keyword">SET</span> STATISTICS IO, <span class="hljs-type">TIME</span> <span class="hljs-keyword">ON</span>;
GO
<span class="hljs-keyword">CREATE</span> INDEX IX_Reputation <span class="hljs-keyword">ON</span> dbo.Users(Reputation)
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">PROCEDURE</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">10000</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> dbo.Users
<span class="hljs-keyword">WHERE</span> Reputation<span class="hljs-operator">=</span><span class="hljs-variable">@Reputation</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> DisplayName;
GO

<span class="hljs-comment">/* Put the bad plan into cache: */</span>
usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
GO
<span class="hljs-comment">/* See that performance tanked: */</span>
usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO
<span class="hljs-comment">/* Run them back and forth a few times to populate the plan cache: */</span>
usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
GO <span class="hljs-number">5</span>
usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
GO <span class="hljs-number">5</span>

sp_BlitzCache;
GO
</code></pre>
<h2 id="labreact-to-a-sniffing-emergency">Lab:React to a Sniffing Emergency</h2>
<ul>
<li>
<p>Ref
<a href="https://www.brentozar.com/training/fundamentals-of-parameter-sniffing/6-lab-tackle-a-parameter-sniffing-emergency/">https://www.brentozar.com/training/fundamentals-of-parameter-sniffing/6-lab-tackle-a-parameter-sniffing-emergency/</a></p>
</li>
<li>
<p><r>Este Lab se puede repetir tantas veces como queremos hasta que aprendamos todo!!!!</r></p>
</li>
<li>
<p>LAB</p>
<ul>
<li>Detectar cual es o son los queries que tiene o tienen un mal plan de ejecucion</li>
<li>Guardarlos</li>
<li>Eliminarlos de la cache, solo esos que pensas que estan mal</li>
<li>Y ver cual es el nuevo plan
<ul>
<li>Si embocaste a los planes correctos la barrade Iterations completed en la app SQL Stress se tendria que ir completando</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Step 1 The one-time database config: sets up indexes, procs</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-comment">/* Set the stage with the right server options &amp; database config: */</span>
USE StackOverflow2013;
GO
DropIndexes;
GO
<span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">130</span>; <span class="hljs-comment">/* Not 2019 yet */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;cost threshold for parallelism&#x27;</span>, N<span class="hljs-string">&#x27;50&#x27;</span> <span class="hljs-comment">/* Keep small queries serial */</span>
GO
<span class="hljs-keyword">EXEC</span> sys.sp_configure N<span class="hljs-string">&#x27;max degree of parallelism&#x27;</span>, N<span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-comment">/* Let queries go parallel */</span>
GO
RECONFIGURE
GO
<span class="hljs-keyword">SET</span> STATISTICS IO, <span class="hljs-type">TIME</span> <span class="hljs-keyword">ON</span>;
GO
<span class="hljs-keyword">CREATE</span> INDEX Reputation <span class="hljs-keyword">ON</span> dbo.Users(Reputation)
GO
<span class="hljs-keyword">CREATE</span> INDEX Location <span class="hljs-keyword">ON</span> dbo.Users(Location);
GO
<span class="hljs-keyword">CREATE</span> INDEX Type <span class="hljs-keyword">ON</span> dbo.PostTypes(Type);
GO
<span class="hljs-keyword">CREATE</span> INDEX PostTypeId <span class="hljs-keyword">ON</span> dbo.Posts(PostTypeId);
GO
<span class="hljs-keyword">CREATE</span> INDEX CreationDate <span class="hljs-keyword">ON</span> dbo.Posts(CreationDate);
GO
<span class="hljs-keyword">CREATE</span> INDEX ParentId <span class="hljs-keyword">ON</span> dbo.Posts(ParentId);
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_LogUserActivity <span class="hljs-variable">@UserId</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-comment">/* Log activity for the viewing user */</span>
	<span class="hljs-keyword">UPDATE</span> dbo.Users
		<span class="hljs-keyword">SET</span> LastAccessDate <span class="hljs-operator">=</span> GETDATE()
		<span class="hljs-keyword">WHERE</span> Id <span class="hljs-operator">=</span> <span class="hljs-variable">@UserId</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_ViewPost <span class="hljs-variable">@PostId</span> <span class="hljs-type">INT</span>, <span class="hljs-variable">@UserId</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-comment">/* Log activity for the viewing user */</span>
	<span class="hljs-keyword">EXEC</span> dbo.usp_LogUserActivity <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@UserId</span>;

	<span class="hljs-comment">/* Log activity on the post */</span>
	<span class="hljs-keyword">UPDATE</span> dbo.Posts
		<span class="hljs-keyword">SET</span> ViewCount <span class="hljs-operator">=</span> ViewCount <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
		<span class="hljs-keyword">WHERE</span> Id <span class="hljs-operator">=</span> <span class="hljs-variable">@PostId</span>;

	<span class="hljs-comment">/* Show the contents of the post */</span>
	<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COALESCE</span>(pParent.Title, p.Title) <span class="hljs-keyword">AS</span> QuestionTitle,
		<span class="hljs-built_in">COALESCE</span>(pParent.Body, p.Body, pChild.Body) <span class="hljs-keyword">AS</span> QuestionBody,
		<span class="hljs-built_in">COALESCE</span>(pParent.Tags, p.Tags) <span class="hljs-keyword">AS</span> QuestionTags,
		<span class="hljs-built_in">COALESCE</span>(p.Score, pChild.Score) <span class="hljs-keyword">AS</span> AnswerScore,
		<span class="hljs-built_in">COALESCE</span>(pChild.Body, p.Body) <span class="hljs-keyword">AS</span> AnswerBody
		<span class="hljs-keyword">FROM</span> dbo.Posts p
		<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pParent <span class="hljs-keyword">ON</span> p.ParentId <span class="hljs-operator">=</span> pParent.Id
		<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pChild <span class="hljs-keyword">ON</span> p.Id <span class="hljs-operator">=</span> pChild.ParentId
		<span class="hljs-keyword">WHERE</span> p.Id <span class="hljs-operator">=</span> <span class="hljs-variable">@PostId</span>
		<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">COALESCE</span>(p.Score, pChild.Score) <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_ShowPostsByDate 
	<span class="hljs-variable">@PostType</span> NVARCHAR(<span class="hljs-number">50</span>),
	<span class="hljs-variable">@StartDate</span> DATETIME, 
	<span class="hljs-variable">@EndDate</span> DATETIME,
	<span class="hljs-variable">@ResultsToShow</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-keyword">SELECT</span> TOP (<span class="hljs-variable">@ResultsToShow</span>) p.CreationDate, p.Score, <span class="hljs-built_in">COALESCE</span>(p.Title, pParent.Title) <span class="hljs-keyword">AS</span> Title, u.DisplayName <span class="hljs-keyword">AS</span> OwnerDisplayName
	<span class="hljs-keyword">FROM</span> dbo.PostTypes pt
	<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts p <span class="hljs-keyword">ON</span> pt.Id <span class="hljs-operator">=</span> p.PostTypeId
	<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> dbo.Posts pParent <span class="hljs-keyword">ON</span> p.ParentId <span class="hljs-operator">=</span> pParent.Id
	<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> dbo.Users u <span class="hljs-keyword">ON</span> p.OwnerUserId <span class="hljs-operator">=</span> u.Id
	<span class="hljs-keyword">WHERE</span> pt.Type <span class="hljs-operator">=</span> <span class="hljs-variable">@PostType</span>
	  <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&gt;=</span> <span class="hljs-variable">@StartDate</span>
	  <span class="hljs-keyword">AND</span> p.CreationDate <span class="hljs-operator">&lt;=</span> <span class="hljs-variable">@EndDate</span>
	<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.CreationDate;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_ShowBadgesForUser
	<span class="hljs-variable">@UserId</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-keyword">SELECT</span> b.Date, b.Name, b.Id <span class="hljs-keyword">AS</span> BadgeId
	<span class="hljs-keyword">FROM</span> dbo.Badges b
	<span class="hljs-keyword">WHERE</span> b.UserId <span class="hljs-operator">=</span> <span class="hljs-variable">@UserId</span>
	<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> b.Date, b.Name;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_CastVote <span class="hljs-variable">@PostId</span> <span class="hljs-type">INT</span>, <span class="hljs-variable">@VoteTypeName</span> NVARCHAR(<span class="hljs-number">50</span>), <span class="hljs-variable">@UserId</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-comment">/* Log activity for the viewing user */</span>
	<span class="hljs-keyword">EXEC</span> dbo.usp_LogUserActivity <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@UserId</span>;

	<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dbo.Votes(PostId, UserId, VoteTypeId, CreationDate)
	<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@PostId</span>, <span class="hljs-variable">@UserId</span>, vt.Id, GETDATE()
	<span class="hljs-keyword">FROM</span> dbo.VoteTypes vt
	<span class="hljs-keyword">WHERE</span> vt.Name <span class="hljs-operator">=</span> <span class="hljs-variable">@VoteTypeName</span>;

<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_InsertComment <span class="hljs-variable">@PostId</span> <span class="hljs-type">INT</span>, <span class="hljs-variable">@UserId</span> <span class="hljs-type">INT</span>, <span class="hljs-variable">@Text</span> NVARCHAR(<span class="hljs-number">700</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-comment">/* Log activity for the commenting user */</span>
	<span class="hljs-keyword">EXEC</span> dbo.usp_LogUserActivity <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@UserId</span>;

	<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dbo.Comments(PostId, UserId, Score, CreationDate, Text)
	<span class="hljs-keyword">VALUES</span> (<span class="hljs-variable">@PostId</span>, <span class="hljs-variable">@UserId</span>, <span class="hljs-number">0</span>, GETDATE(), <span class="hljs-variable">@Text</span>);

	<span class="hljs-keyword">UPDATE</span> dbo.Posts
		<span class="hljs-keyword">SET</span> CommentCount <span class="hljs-operator">=</span> CommentCount <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
		<span class="hljs-keyword">WHERE</span> Id <span class="hljs-operator">=</span> <span class="hljs-variable">@PostId</span>;

<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_RptUsersLeaderboard <span class="hljs-variable">@Location</span> NVARCHAR(<span class="hljs-number">100</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> <span class="hljs-operator">*</span>
		<span class="hljs-keyword">FROM</span> dbo.Users u
		<span class="hljs-keyword">WHERE</span> u.Location <span class="hljs-operator">=</span> <span class="hljs-variable">@Location</span>
		<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Reputation <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_InsertUser <span class="hljs-variable">@DisplayName</span> NVARCHAR(<span class="hljs-number">40</span>), <span class="hljs-variable">@Location</span> NVARCHAR(<span class="hljs-number">100</span>), <span class="hljs-variable">@WebsiteUrl</span> NVARCHAR(<span class="hljs-number">200</span>) <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dbo.Users(CreationDate, DisplayName, DownVotes, LastAccessDate, Location, Reputation, UpVotes, Views, WebsiteUrl)
	<span class="hljs-keyword">VALUES</span> (GETDATE(), <span class="hljs-variable">@DisplayName</span>, <span class="hljs-number">0</span>, GETDATE(), <span class="hljs-variable">@Location</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">@WebsiteUrl</span>);
<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC dbo.usp_GrantBadge <span class="hljs-variable">@BadgeName</span> NVARCHAR(<span class="hljs-number">40</span>), <span class="hljs-variable">@UserId</span> <span class="hljs-type">INT</span> <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-comment">/* Check to make sure the badge actually exists */</span>
	IF <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> dbo.Badges <span class="hljs-keyword">WHERE</span> Name <span class="hljs-operator">=</span> <span class="hljs-variable">@BadgeName</span>)
		<span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> dbo.Users <span class="hljs-keyword">WHERE</span> Id <span class="hljs-operator">=</span> <span class="hljs-variable">@UserId</span>)
	<span class="hljs-keyword">BEGIN</span>
		<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dbo.Badges (Name, UserId, <span class="hljs-type">Date</span>)
			<span class="hljs-keyword">VALUES</span> (<span class="hljs-variable">@BadgeName</span>, <span class="hljs-variable">@UserId</span>, GETDATE());

		<span class="hljs-comment">/* Track that the user was active */</span>
		<span class="hljs-keyword">EXEC</span> dbo.usp_LogUserActivity <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@UserId</span>;
	<span class="hljs-keyword">END</span>
<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SniffLab_Setup] <span class="hljs-keyword">WITH</span> RECOMPILE <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-comment">/* Hi! You can ignore this stored procedure.
	   This is used to run different random stored procs as part of your class.
	   Don&#x27;t change this in order to &quot;tune&quot; things.
	*/</span>
	<span class="hljs-keyword">SET</span> NOCOUNT <span class="hljs-keyword">ON</span>
	DBCC FREEPROCCACHE;
	<span class="hljs-keyword">EXEC</span> usp_ShowPostsByDate <span class="hljs-variable">@PostType</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Question&#x27;</span>, <span class="hljs-variable">@StartDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-01&#x27;</span>, <span class="hljs-variable">@EndDate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2011-11-02&#x27;</span>, <span class="hljs-variable">@ResultsToShow</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
	<span class="hljs-keyword">EXEC</span> dbo.usp_RptUsersLeaderboard <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;San Diego, CA, USA&#x27;</span>;
<span class="hljs-keyword">END</span>
GO

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC [dbo].[usp_SniffLab] <span class="hljs-keyword">WITH</span> RECOMPILE <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-comment">/* Hi! You can ignore this stored procedure.
	   This is used to run different random stored procs as part of your class.
	   Don&#x27;t change this in order to &quot;tune&quot; things.
	*/</span>
	<span class="hljs-keyword">SET</span> NOCOUNT <span class="hljs-keyword">ON</span>

	<span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@Id1</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">CAST</span>(RAND() <span class="hljs-operator">*</span> <span class="hljs-number">10000000</span> <span class="hljs-keyword">AS</span> <span class="hljs-type">INT</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span>,
			<span class="hljs-variable">@Id2</span> <span class="hljs-type">INT</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">CAST</span>(RAND() <span class="hljs-operator">*</span> <span class="hljs-number">10000000</span> <span class="hljs-keyword">AS</span> <span class="hljs-type">INT</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span>,
			<span class="hljs-variable">@StartDate</span> DATETIME <span class="hljs-operator">=</span> DATEADD(<span class="hljs-keyword">DAY</span>, <span class="hljs-number">-1</span>, GETUTCDATE()),
			<span class="hljs-variable">@EndDate</span> DATETIME <span class="hljs-operator">=</span> GETUTCDATE(),
			<span class="hljs-variable">@P1</span> NVARCHAR(<span class="hljs-number">50</span>),
			<span class="hljs-variable">@P2</span> NVARCHAR(<span class="hljs-number">50</span>),
			<span class="hljs-variable">@P3</span> NVARCHAR(<span class="hljs-number">50</span>),
			<span class="hljs-variable">@P4</span> NVARCHAR(<span class="hljs-number">50</span>);

	IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">10</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>
		<span class="hljs-keyword">EXEC</span> dbo.usp_InsertComment <span class="hljs-variable">@PostId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span>, <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Id2</span>, <span class="hljs-variable">@Text</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;Your ideas intrigue me and I would like to subscribe to your newsletter.&#x27;</span>;

	<span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">10</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span>
		<span class="hljs-keyword">EXEC</span> dbo.usp_GrantBadge <span class="hljs-variable">@BadgeName</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Supporter&#x27;</span>, <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span>;
	<span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">10</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>
		<span class="hljs-keyword">EXEC</span> dbo.usp_InsertUser <span class="hljs-variable">@DisplayName</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;John Malkovich&#x27;</span>, <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;New Jersey Turnpike&#x27;</span>, <span class="hljs-variable">@WebsiteUrl</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;https://www.youtube.com/watch?v=2UuRFr0GnHM&#x27;</span>;
	<span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">10</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>
		<span class="hljs-keyword">EXEC</span> dbo.usp_RptUsersLeaderboard <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;India&#x27;</span>;
	<span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">10</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>
		<span class="hljs-keyword">EXEC</span> dbo.usp_RptUsersLeaderboard <span class="hljs-variable">@Location</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;San Diego, CA, USA&#x27;</span>;
	<span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">10</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>
		<span class="hljs-keyword">EXEC</span> dbo.usp_CastVote <span class="hljs-variable">@PostId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span>, <span class="hljs-variable">@VoteTypeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;UpMod&#x27;</span>, <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Id2</span>;
	<span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">10</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>
		<span class="hljs-keyword">EXEC</span> dbo.usp_ShowBadgesForUser <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span>;
	<span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id1</span> <span class="hljs-operator">%</span> <span class="hljs-number">10</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
		<span class="hljs-keyword">EXEC</span> dbo.usp_ViewPost <span class="hljs-variable">@PostId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Id1</span>, <span class="hljs-variable">@UserId</span> <span class="hljs-operator">=</span> <span class="hljs-variable">@Id2</span>;
	<span class="hljs-keyword">ELSE</span>
		<span class="hljs-keyword">BEGIN</span>
			IF <span class="hljs-variable">@Id2</span> <span class="hljs-operator">%</span> <span class="hljs-number">3</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>			<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@P1</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Question&#x27;</span>
			<span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id2</span> <span class="hljs-operator">%</span> <span class="hljs-number">3</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>	<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@P1</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;Answer&#x27;</span>
			<span class="hljs-keyword">ELSE</span>					<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@P1</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;ModeratorNomination&#x27;</span>

			IF <span class="hljs-variable">@Id2</span> <span class="hljs-operator">%</span> <span class="hljs-number">4</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>			<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@P2</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;2011-11-01&#x27;</span>, <span class="hljs-variable">@P3</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;2011-11-02&#x27;</span>; 
			<span class="hljs-keyword">ELSE</span> IF <span class="hljs-variable">@Id2</span> <span class="hljs-operator">%</span> <span class="hljs-number">4</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>	<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@P2</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;2011-11-01&#x27;</span>, <span class="hljs-variable">@P3</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;2011-11-30&#x27;</span>; 
			<span class="hljs-keyword">ELSE</span>					<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@P2</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;2008-01-01&#x27;</span>, <span class="hljs-variable">@P3</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;2013-12-31&#x27;</span>; 
	
			IF <span class="hljs-variable">@Id2</span> <span class="hljs-operator">%</span> <span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>			<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@P4</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;100&#x27;</span>; 
			<span class="hljs-keyword">ELSE</span>					<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@P4</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;10000&#x27;</span>; 

			<span class="hljs-keyword">EXEC</span> dbo.usp_ShowPostsByDate <span class="hljs-variable">@P1</span>, <span class="hljs-variable">@P2</span>, <span class="hljs-variable">@P3</span>, <span class="hljs-variable">@P4</span>;
		<span class="hljs-keyword">END</span>;

	WHILE @<span class="hljs-variable">@TRANCOUNT</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>
		<span class="hljs-keyword">BEGIN</span>
		<span class="hljs-keyword">COMMIT</span>
		<span class="hljs-keyword">END</span>
<span class="hljs-keyword">END</span>
GO
</code></pre>
<ul>
<li>Step 2 The load test:
when you’re ready to start up the workload, execute this command to prime the plan cache:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> [dbo].[usp_SniffLab_Setup];
</code></pre>
<ul>
<li>Step 3
Fire up SQLQueryStress, click File, Load, and point it at the SniffLab.json file that you downloaded from my sample stress test files during the class prerequisite setup. This will call usp_SniffLab across 3 threads, 300 iterations per thread, 250 millisecond delay between threads. Click the GO button to get the party started.</li>
</ul>
<p>Let SQLQueryStress run for at least 10 minutes to populate data into your plan cache, then use the sp_BlitzCache analysis techniques that we talked about during the class. When you think you’ve found a solution:</p>
<ul>
<li>
<p>Stop SQLQueryStress (simulating shutting off your app during a deployment window)</p>
</li>
<li>
<p>Make your desired change</p>
</li>
<li>
<p>Start SQLQueryStress again, and see if the Iterations Completed move along a lot faster</p>
</li>
<li>
<p>Step 4
Run SQLQueryStress to run the full-blown workload</p>
</li>
</ul>
<p>NOTES</p>
<ul>
<li>Este ejercicio lo tengo que terminar. Ver el video the [Lab: Brent Does it (21:43)]</li>
</ul>
<h2 id="what-parameter-sniffing-isnt">What Parameter Sniffing ISN'T</h2>
<ul>
<li>
<p>We need to rule these things out:</p>
<ul>
<li>Different data distribution</li>
<li>Different statistics content</li>
<li>Different server hardware (cores, memory)</li>
<li>Different SQL Server versions (including build numbers)</li>
<li>Different server-level settings (sp_configure, trace flags)</li>
<li>Different database-level settings (database scoped options, sys.databases)</li>
</ul>
</li>
<li>
<p>Techniques we'll use to do it:</p>
<ul>
<li>Diagnostic queries like sp_Blitz</li>
<li>Comparing system tables</li>
<li>Comparing stats histograms</li>
<li>Testing our queries appropriately:
<ul>
<li>Avoiding DECLAREs</li>
<li>Using temp stored procedures instead</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Con variables locales, el SQL no usa las estadisticas porque no sabe que valor le vas a pasar</p>
</li>
<li>
<p>Por lo que cuando usas variables locales no podes resolver el problema de parameter sniffing y el engine va a usar siempre el mismo plan y va a usar el Density Vector</p>
</li>
<li>
<p>Use '#' behind the name of the SP and the SP will be visible only for you. You can use that on prod.</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> PROC #usp_UsersByReputation
<span class="hljs-variable">@Reputation</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> dbo.Users
  <span class="hljs-keyword">WHERE</span> Reputation <span class="hljs-operator">=</span> <span class="hljs-variable">@Reputation</span>
<span class="hljs-keyword">END</span>
</code></pre>
</li>
<li>
<p>Siempre que veas un DECLARE no es parameter sniffing es una mala estimacion</p>
</li>
</ul>
<h2 id="how-sql-server-2022-tries-fixing-parameter-sniffing">How SQL Server 2022 Tries Fixing Parameter Sniffing</h2>
<ul>
<li>SQL Server 2022 introduces a new fix:
Parameter Sensitive Plan (PSP) Optimization. To enable it, go into 2022 compat level:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">ALTER</span> DATABASE <span class="hljs-keyword">CURRENT</span> <span class="hljs-keyword">SET</span> COMPATIBILITY_LEVEL <span class="hljs-operator">=</span> <span class="hljs-number">160</span>;
GO
</code></pre>
<ul>
<li>Turn on actual plans and try the first one:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">1</span>;
GO
</code></pre>
<ul>
<li>
<p>Right-click on the Select, click Properties:</p>
<ul>
<li>Dispatcher</li>
<li>Statistics Info</li>
</ul>
</li>
<li>
<p>Try the next reputation:</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">2</span>;
GO
<span class="hljs-comment">-- Check Dispatcher, Statistics Info again.</span>
</code></pre>
<ul>
<li>Another:</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">3</span>;
GO
</code></pre>
<ul>
<li>
<p>Note:</p>
<ul>
<li>Estimated vs actual</li>
<li>Memory grant on sort</li>
<li>Query text with hint</li>
</ul>
</li>
<li>
<p>Another:</p>
</li>
</ul>
<pre><code class="language-sql"><span class="hljs-keyword">EXEC</span> dbo.usp_UsersByReputation <span class="hljs-variable">@Reputation</span> <span class="hljs-operator">=</span><span class="hljs-number">0</span>;
GO
</code></pre>
<ul>
<li>Note:
<ul>
<li>Estimated vs actual</li>
<li>Memory grant on sort</li>
<li>Query text with hint</li>
</ul>
</li>
</ul>
<p>So how's this look in the plan cache?</p>
<p>NOTA</p>
<ul>
<li><r>YO NO PUDE HACER QUE ME MUESTRE LOS MISMOS PLANES QUE EL. SE LO PODRIA ENVIAR Y PREGUNTARLE QUE ONDA.</r></li>
</ul>
<h2 id="recap">RECAP</h2>
<ul>
<li>
<p>SIMPRE BUSCAR LOS OUTLINERS</p>
</li>
<li>
<p>SIEMPRE USAR sp_recompile ''</p>
</li>
<li>
<p>Siempre ejecutarlos en diferentes combinaciones no siempre se puede hacer, pero tenes que sacar los 10 queries mas intensos y trabajarlos de esta manera. Las 10 quieres por memoria, cpu, reads, etc trabajarlas, implementar y luego de unos dias ver.</p>
</li>
<li>
<p>What you learned today</p>
<ul>
<li>You were doing the things that cause emergencies: rebuilding indexes, updating stats</li>
<li>They caused emergencies when SQL re-evaluated: parallelism, seeks vs scans, memory grants</li>
<li>To react to parameter sniffing emergencies:
<ol>
<li>sp_BlitzCache</li>
<li>Save the bad plan, remove it from cache</li>
<li>Then start making it less susceptible</li>
</ol>
</li>
</ul>
</li>
</ul>

            
            
        </body>
        </html>